<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual">
  <meta name="theme-color" content="#0D0D0D">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>RAI</title>

  <link rel="icon"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="64" height="64"><defs><linearGradient id="planetGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23f5d547;stop-opacity:1"/><stop offset="100%" style="stop-color:%23e6a824;stop-opacity:1"/></linearGradient><linearGradient id="ringGrad" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:%23f9e79f;stop-opacity:1"/><stop offset="100%" style="stop-color:%23fef5e7;stop-opacity:1"/></linearGradient></defs><circle cx="32" cy="32" r="14" fill="url(%23planetGrad)"/><path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(%23ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.8"/><path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(%23ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.9"/><circle cx="26" cy="26" r="4" fill="white" opacity="0.2"/></svg>'
    type="image/svg+xml">

  <!-- Google Fonts link removed -->
  <!-- Marked.js for Markdown Rendering -->
  <script src="lib/marked.min.js"></script>

  <!-- KaTeX for Math Rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    crossorigin="anonymous"></script>

  <script>
    // Robust loading with CDN fallback
    window.addEventListener('load', function () {
      if (typeof marked === 'undefined' && !window.marked) {
        console.warn('âš ï¸ Local marked.js failed to load. Attempting CDN fallback...');
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
        script.onload = function () {
          console.log('âœ… Marked.js loaded from CDN');
          if (typeof renderMessages === 'function') {
            console.log('ğŸ”„ Re-rendering messages...');
            renderMessages();
          }
        };
        script.onerror = function () {
          console.error('âŒ Critical: Marked.js failed to load from both local and CDN');
          // Define a simple fallback
          window.marked = {
            parse: function (text) { return text; }
          };
        };
        document.head.appendChild(script);
      } else {
        console.log('âœ… Marked.js loaded successfully (Local)');
      }
    });

    // æ•°å­¦å…¬å¼æ¸²æŸ“ - å®Œæ•´è§£å†³æ–¹æ¡ˆ

    // æ¸²æŸ“å¸¦æ•°å­¦å…¬å¼çš„Markdownæ–‡æœ¬
    function renderMarkdownWithMath(text) {
      if (!text) return '';

      // ä¸´æ—¶å­˜å‚¨å…¬å¼çš„æ˜ å°„
      const mathStore = new Map();
      let counter = 0;

      // 1. ä¿æŠ¤ $$ ... $$ å—çº§å…¬å¼
      let protectedText = text.replace(/\$\$([\s\S]+?)\$\$/g, (match, formula) => {
        const id = `@@MATHBLOCK${counter++}@@`;
        mathStore.set(id, { formula: formula.trim(), display: true });
        return id;
      });

      // 2. ä¿æŠ¤ $ ... $ è¡Œå†…å…¬å¼
      protectedText = protectedText.replace(/\$([^\$\n]+?)\$/g, (match, formula) => {
        // è·³è¿‡çœ‹èµ·æ¥åƒè´§å¸çš„æƒ…å†µï¼ˆä»¥æ•°å­—å¼€å¤´å¹¶ä¸”å¾ˆçŸ­ï¼‰
        if (/^\d+\.?\d*$/.test(formula.trim())) return match;
        const id = `@@MATHINLINE${counter++}@@`;
        mathStore.set(id, { formula: formula.trim(), display: false });
        return id;
      });

      // 3. Markdownè§£æ
      let html = '';
      if (typeof marked !== 'undefined' && marked.parse) {
        html = marked.parse(protectedText);
      } else {
        html = protectedText;
      }

      // 4. æ¢å¤å¹¶æ¸²æŸ“æ•°å­¦å…¬å¼
      if (typeof katex !== 'undefined') {
        mathStore.forEach((data, id) => {
          try {
            const rendered = katex.renderToString(data.formula, {
              displayMode: data.display,
              throwOnError: false,
              errorColor: '#ff6b6b',
              trust: true,
              strict: false
            });
            html = html.replace(new RegExp(id, 'g'), rendered);
          } catch (e) {
            console.warn('KaTeX render error for:', data.formula, e);
            // æ¸²æŸ“å¤±è´¥æ—¶æ˜¾ç¤ºåŸå§‹å…¬å¼ï¼ˆç”¨codeæ ‡ç­¾åŒ…è£¹ï¼‰
            const fallback = data.display
              ? `<pre class="math-error"><code>${escapeHtml(data.formula)}</code></pre>`
              : `<code class="math-error">${escapeHtml(data.formula)}</code>`;
            html = html.replace(new RegExp(id, 'g'), fallback);
          }
        });
      } else {
        // KaTeXæœªåŠ è½½ï¼Œæ˜¾ç¤ºåŸå§‹å…¬å¼
        mathStore.forEach((data, id) => {
          const original = data.display ? `$$${data.formula}$$` : `$${data.formula}$`;
          html = html.replace(new RegExp(id, 'g'), `<code>${escapeHtml(original)}</code>`);
        });
      }

      return html;
    }

    // HTMLè½¬ä¹‰è¾…åŠ©å‡½æ•°
    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // å…¼å®¹æ—§ä»£ç çš„ç©ºå‡½æ•°
    function restoreAndRenderMath(element) {
      // ä¸å†éœ€è¦ï¼Œå› ä¸ºrenderMarkdownWithMathå·²ç»å®Œæˆäº†æ‰€æœ‰å·¥ä½œ
    }
  </script>

  <style>
    /* ==================== å…¨å±€é‡ç½®ä¸å˜é‡ ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* ç¦ç”¨Androidè“è‰²ç‚¹å‡»çƒ­åŒºæç¤ºï¼Œä½¿ç”¨è‡ªå®šä¹‰æ ·å¼ */
      -webkit-tap-highlight-color: transparent;
    }

    :root {
      --bg-primary: #0D0D0D;
      --bg-secondary: #1A1A1A;
      --bg-tertiary: #2A2A2A;
      --bg-hover: #353535;
      --text-primary: #ECECEC;
      --text-secondary: #ACACAC;
      --text-tertiary: #6E6E6E;
      --border-color: #2A2A2A;
      --border-dark: #404040;
      --accent-color: #FFFFFF;
      --accent-hover: #E0E0E0;
      --input-bg: #202020;
      --error-color: #EF4444;
      --warning-color: #F59E0B;
      --success-color: #2aa97f;
      --thinking-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      /* Thinking UI Colors */
      --color-black: #000000;
      --color-white: #ffffff;
      --color-gray: #808080;
      --color-saturn-yellow: #FFC107;
      --sidebar-width: 280px;
      --header-height: 60px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 20px;
      --spacing-xl: 28px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
      --z-modal: 1000;
      --z-overlay: 999;
      --z-sidebar: 100;
      --z-header: 90;
    }

    /* æµ…è‰²ä¸»é¢˜ */
    [data-theme="light"] {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #E5E5E5;
      --bg-hover: #D4D4D4;
      --text-primary: #1A1A1A;
      --text-secondary: #525252;
      --text-tertiary: #A3A3A3;
      --border-color: #E5E5E5;
      --border-dark: #D4D4D4;
      --accent-color: #000000;
      --accent-hover: #404040;
      --input-bg: #F5F5F5;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      position: fixed;
      /* é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ */
      transition: background-color 0.3s, color 0.3s;
    }



    .material-symbols-outlined {
      display: inline-block;
      vertical-align: middle;
      fill: currentColor;
      width: 1em;
      height: 1em;
      /* font-variation-settings removed */
    }

    .hidden {
      display: none !important;
    }

    /* ==================== å¸ƒå±€å®¹å™¨ ==================== */
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      background-color: transparent;
      /* æ”¹ä¸ºé€æ˜ */
      position: relative;
      overflow: hidden;
      z-index: 1;
      /* ç¡®ä¿åœ¨canvasä¹‹ä¸Š */
    }

    /* ==================== ä¾§è¾¹æ  ==================== */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: var(--z-sidebar);
    }

    /* å›ºå®šé¡¶éƒ¨åŒºåŸŸ */
    .sidebar-header-fixed {
      padding: var(--spacing-lg);
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
    }

    /* PCä¾§è¾¹æ é¡¶æ æ§åˆ¶æŒ‰é’® */
    .sidebar-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .sidebar-header-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .sidebar-control-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .sidebar-control-btn:hover {
      background: var(--bg-hover);
    }

    .sidebar-lang-text {
      font-size: 14px;
      font-weight: 600;
      min-width: 18px;
      text-align: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: 0;
    }

    .logo-icon {
      width: 38px;
      height: 38px;
      flex-shrink: 0;
      background: var(--bg-tertiary);
      border-radius: 50% 10px 10px 10px;
      padding: 3px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .logo-text-col {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-subtitle {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
      font-weight: 400;
    }

    .new-chat-btn {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-md);
    }

    .new-chat-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-color);
    }

    /* æœç´¢æ¡† */
    .search-box {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      transition: all 0.2s;
      margin-bottom: var(--spacing-md);
    }

    .search-box:focus-within {
      border-color: var(--border-dark);
    }

    .search-box .material-symbols-outlined {
      font-size: 20px;
      color: var(--text-tertiary);
    }

    .search-box input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
    }

    .search-box input::placeholder {
      color: var(--text-tertiary);
    }

    /* å¯æ»šåŠ¨ä¸­é—´åŒºåŸŸ */
    .sidebar-scrollable {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-md);
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    .sidebar-scrollable::-webkit-scrollbar {
      width: 5px;
    }

    .sidebar-scrollable::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-scrollable::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    /* åˆ†ç»„æ ·å¼ */
    .sidebar-group {
      margin-bottom: var(--spacing-lg);
    }

    .sidebar-group-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
      user-select: none;
    }

    .sidebar-group-header:hover {
      background: var(--bg-tertiary);
    }

    .sidebar-group-header .material-symbols-outlined {
      font-size: 20px;
      color: var(--text-primary);
    }

    .sidebar-group-title {
      flex: 1;
    }

    .group-toggle-icon {
      font-size: 20px;
      transition: transform 0.3s;
      color: var(--text-secondary);
    }

    .group-toggle-icon.collapsed {
      transform: rotate(180deg);
    }

    .sidebar-group-content {
      padding-left: var(--spacing-md);
      margin-top: var(--spacing-sm);
      max-height: 1000px;
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
      opacity: 1;
    }

    .sidebar-group-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    /* å†…è”æ–°å»ºç©ºé—´æŒ‰é’® */
    .new-space-btn-inline {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      background: transparent;
      border: 1px dashed var(--border-dark);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-sm);
    }

    .new-space-btn-inline:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }

    .new-space-btn-inline .material-symbols-outlined {
      font-size: 16px;
    }

    /* æ—§çš„æ ‡ç­¾æ ·å¼éšè— */
    .sidebar-tabs {
      display: none;
    }

    .tab-content {
      display: none;
    }

    /* ==================== ç©ºé—´ç®¡ç† ==================== */
    .spaces-list {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .space-item {
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      /* åœ†è§’å¤§å°ï¼Œå¯è‡ªå®šä¹‰è°ƒæ•´ */
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .space-item:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
    }

    .space-item.active {
      border-color: var(--accent-color);
      background: var(--bg-hover);
    }

    .space-icon {
      font-size: 24px;
      flex-shrink: 0;
    }

    .space-info {
      flex: 1;
      min-width: 0;
    }

    .space-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .space-doc-count {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .space-actions {
      display: flex;
      gap: 4px;
    }

    .space-action-icon {
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      color: var(--text-tertiary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .space-action-icon:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .space-action-icon.delete:hover {
      background: var(--error-color);
      color: white;
    }

    /* ç©ºé—´è¯¦æƒ…é¢æ¿ */
    .space-detail {
      display: none;
      flex-direction: column;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border-radius: var(--radius-md);
      margin-top: var(--spacing-md);
    }

    .space-detail.active {
      display: flex;
    }

    .space-detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .space-detail-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .upload-file-btn {
      padding: 6px 12px;
      background: var(--accent-color);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .upload-file-btn:hover {
      background: var(--accent-hover);
    }

    .document-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }

    .document-item {
      padding: 8px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .document-info {
      flex: 1;
      min-width: 0;
    }

    .document-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .document-meta {
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .document-delete {
      width: 20px;
      height: 20px;
      padding: 0;
      background: transparent;
      color: var(--text-tertiary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .document-delete:hover {
      background: var(--error-color);
      color: white;
    }

    .new-space-btn {
      width: 100%;
      padding: var(--spacing-md);
      background: transparent;
      border: 1px dashed var(--border-dark);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
    }

    .new-space-btn:hover {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      color: var(--text-primary);
    }


    .sessions-container {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .session-item {
      padding: var(--spacing-md);
      padding-right: 36px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .session-item:hover {
      background: var(--bg-tertiary);
    }

    .session-item.active {
      background: var(--bg-tertiary);
      border-color: var(--border-dark);
    }

    .session-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-delete-btn {
      position: absolute;
      top: 50%;
      right: var(--spacing-sm);
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      color: var(--text-tertiary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }

    .session-delete-btn:hover {
      background: var(--error-color);
      color: white;
      opacity: 1;
    }

    /* å›ºå®šåº•éƒ¨åŒºåŸŸ */
    .sidebar-footer-fixed {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .user-section {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 16px;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
      flex-shrink: 0;
    }

    .user-info-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-width: 0;
    }

    .user-info-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 2px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-email {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .settings-btn-inline {
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      color: var(--text-secondary);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .settings-btn-inline:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .settings-btn-inline .material-symbols-outlined {
      font-size: 18px;
    }

    .sidebar-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .sidebar-action-btn {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      background: transparent;
      border: 1px solid var(--border-color);
      /* border-radius: var(--radius-sm); removed for specific corners */
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
    }

    .sidebar-action-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
    }

    .sidebar-actions .sidebar-action-btn:first-child {
      border-radius: 10px 10px 10px 20px;
      /* è®¾ç½®æŒ‰é’® å·¦ä¸‹è§’ä¸º30dp å…¶ä»–14dp */
    }

    .sidebar-actions .sidebar-action-btn:last-child {
      border-radius: 10px 10px 20px 10px;
      /* é€€å‡ºæŒ‰é’® å³ä¸‹æ˜¯30dp å…¶ä»–14dp */
    }

    /* ==================== ä¸»å†…å®¹åŒº ==================== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: transparent;
      /* æ”¹ä¸ºé€æ˜ */
      position: relative;
      overflow: hidden;
      height: 100%;
      /* ç¡®ä¿é«˜åº¦ */
      min-width: 0;
      /* ä¿®å¤Flexå­é¡¹æº¢å‡ºé—®é¢˜ */
      z-index: 2;
      /* ç¡®ä¿åœ¨canvasä¹‹ä¸Š */
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-xl) var(--spacing-lg);
      padding-bottom: 160px;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
      padding: var(--spacing-xl);
      position: relative;
      /* ç¡®ä¿z-indexç”Ÿæ•ˆ */
      z-index: 10;
      /* æå‡å±‚çº§ */
      opacity: 1;
      /* å¼ºåˆ¶ä¸é€æ˜ */
      visibility: visible;
      /* å¼ºåˆ¶å¯è§ */
    }

    .welcome-icon {
      width: 96px;
      height: 96px;
      margin-bottom: var(--spacing-xl);
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 4px 12px rgba(245, 213, 71, 0.3));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .welcome-icon svg {
      width: 100%;
      height: 100%;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    .welcome-title {
      font-size: 32px;
      font-weight: 700;
      /* æš—è‰²æ¨¡å¼ï¼šç™½è‰²æ–‡å­— + ä»å·¦åˆ°å³çš„é‡‘å±å…‰æ³½é—ªè¿‡ */
      background:
        linear-gradient(90deg,
          transparent 0%,
          rgba(30, 30, 30, 0.9) 10%,
          rgba(60, 60, 60, 0.85) 20%,
          rgba(80, 80, 80, 0.7) 30%,
          rgba(120, 120, 120, 0.5) 40%,
          transparent 50%,
          transparent 100%),
        linear-gradient(90deg, #FFFFFF, #FFFFFF);
      background-size: 250% 100%, 100% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0;
      letter-spacing: -0.5px;
      animation: metalShine 3s linear infinite;
      position: relative;
    }

    /* é‡‘å±å…‰æ³½é—ªè¿‡åŠ¨ç”» - ä»å·¦åˆ°å³ï¼Œå®Œç¾å¾ªç¯ */
    @keyframes metalShine {
      0% {
        background-position: 200% 0, 0 0;
      }

      100% {
        background-position: -100% 0, 0 0;
      }
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: var(--spacing-xl);
    }

    .welcome-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 420px;
      margin-top: 32px;
    }

    .action-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      /* å±…ä¸­å¯¹é½ */
      justify-content: center;
      gap: 12px;
      aspect-ratio: 1;
      min-width: 140px;
      min-height: 140px;
      position: relative;
      overflow: hidden;
    }

    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .action-card:hover::before {
      opacity: 1;
    }

    .action-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-dark);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .action-card:nth-child(1) {
      border-radius: 30px 13px 13px 13px;
    }

    .action-card:nth-child(2) {
      border-radius: 13px 30px 13px 13px;
    }

    .action-card:nth-child(3) {
      border-radius: 13px 13px 13px 30px;
    }

    .action-card:nth-child(4) {
      border-radius: 13px 13px 30px 13px;
    }

    .action-card-icon {
      font-size: 32px;
      background: linear-gradient(135deg, #FFFFFF 0%, #D0D0D0 50%, #606060 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .action-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      /* æ–‡å­—å±…ä¸­ */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    [data-theme="light"] .welcome-icon {
      background: linear-gradient(135deg, #404040 0%, #808080 50%, #D0D0D0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    [data-theme="light"] .welcome-title {
      /* æµ…è‰²æ¨¡å¼ï¼šé»‘è‰²æ–‡å­— + ä»å·¦åˆ°å³çš„ç™½ç°é‡‘å±å…‰æ³½é—ªè¿‡ */
      background:
        linear-gradient(90deg,
          transparent 0%,
          rgba(255, 255, 255, 0.95) 10%,
          rgba(230, 230, 230, 0.9) 20%,
          rgba(200, 200, 200, 0.8) 30%,
          rgba(170, 170, 170, 0.6) 40%,
          transparent 50%,
          transparent 100%),
        linear-gradient(90deg, #1a1a1a, #1a1a1a);
      background-size: 250% 100%, 100% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: metalShine 3s linear infinite;
    }

    [data-theme="light"] .action-card-icon {
      background: linear-gradient(135deg, #303030 0%, #606060 50%, #909090 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .messages-list {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      min-width: 0;
      /* é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º */
      overflow-wrap: break-word;
    }

    .message {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      animation: messageSlideIn 0.3s ease-out;
    }

    /* ç”¨æˆ·æ¶ˆæ¯å±…å³å¯¹é½ */
    .message.user {
      flex-direction: row-reverse;
      justify-content: flex-start;
      margin-bottom: calc(var(--spacing-xl) * 1.5);
    }

    /* AIæ¶ˆæ¯å±…å·¦å¯¹é½ï¼Œå‚ç›´å¸ƒå±€ - å¤´åƒã€ç«–çº¿ã€æ­£æ–‡å‚ç›´å¯¹é½ */
    .message.assistant {
      flex-direction: column;
      /* å‚ç›´å¸ƒå±€ */
      align-items: flex-start;
      margin-bottom: calc(var(--spacing-xl) * 2);
      position: relative;
      gap: var(--spacing-sm);
      /* ç¼©å°é—´è· */
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .message.user .message-avatar {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
    }

    .message.assistant .message-avatar {
      display: flex;
      position: relative;
    }

    /* AIæ¶ˆæ¯å‚ç›´å¼•å¯¼çº¿ - åªåœ¨å±•å¼€æ—¶æ˜¾ç¤ºï¼Œç°è‰²ï¼Œä½ç½®åœ¨å¤´åƒæ­£ä¸‹æ–¹ */
    .message.assistant .message-avatar::after {
      content: '';
      position: absolute;
      left: 50%;
      top: 100%;
      transform: translateX(-50%);
      width: 2px;
      height: var(--thinking-line-height, 0);
      background: var(--text-tertiary);
      opacity: 0;
      pointer-events: none;
      transition: height 0.3s ease, opacity 0.3s ease;
    }

    /* å±•å¼€æ—¶æ˜¾ç¤ºå‚ç›´çº¿ */
    .message.assistant:has(.thinking-content.expanded) .message-avatar::after {
      opacity: 0.3;
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    /* ç”¨æˆ·æ¶ˆæ¯å†…å®¹å±…å³ */
    .message.user .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-text {
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      line-height: 1.7;
      word-wrap: break-word;
      overflow-wrap: break-word;
      word-break: break-word;
      /* å¤„ç†é•¿ URL å’Œè¿ç»­å­—ç¬¦ */
      hyphens: auto;
      /* è‡ªåŠ¨è¿å­—ç¬¦æ¢è¡Œ */
      -webkit-hyphens: auto;
      font-size: 14px;
      max-width: 100%;
      /* ç¡®ä¿ä¸æº¢å‡ºå®¹å™¨ */
      min-width: 0;
      /* é˜²æ­¢ flex å­å…ƒç´ æº¢å‡º */
    }

    .message.user .message-text {
      background: var(--bg-secondary);
      color: var(--text-primary);
      max-width: 100%;
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .message.assistant .message-text {
      background: transparent;
      color: var(--text-primary);
      padding: 0;
      padding-left: 16px;
      /* ä¸å¤´åƒä¸­å¿ƒ/ç«–çº¿å¯¹é½ (å¤´åƒ32px / 2 = 16px) */
    }

    /* æ¶ˆæ¯å…ƒä¿¡æ¯å’Œæ“ä½œæ  */
    .message-meta {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
      font-size: 11px;
      color: var(--text-tertiary);
      padding-left: 16px;
      /* ä¸å¤´åƒä¸­å¿ƒ/ç«–çº¿å¯¹é½ */
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .meta-badge .material-symbols-outlined {
      font-size: 12px;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px;
      width: 28px;
      height: 28px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .copy-btn .material-symbols-outlined {
      font-size: 16px;
    }

    .copy-btn.copied {
      color: var(--accent-color);
      border-color: var(--accent-color);
    }

    /* ====================Markdownæ¸²æŸ“æ ·å¼ ==================== */
    .message-text h1,
    .message-text h2,
    .message-text h3,
    .message-text h4,
    .message-text h5,
    .message-text h6 {
      margin: 1em 0 0.5em 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .message-text h1 {
      font-size: 1.8em;
    }

    .message-text h2 {
      font-size: 1.5em;
    }

    .message-text h3 {
      font-size: 1.3em;
    }

    .message-text h4 {
      font-size: 1.1em;
    }

    .message-text p {
      margin: 0.5em 0;
    }

    .message-text ul,
    .message-text ol {
      margin: 0.5em 0;
      padding-left: 2em;
    }

    .message-text li {
      margin: 0.3em 0;
    }

    .message-text a {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .message-text blockquote {
      border-left: 3px solid var(--border-dark);
      padding-left: 1em;
      margin: 1em 0;
      color: var(--text-secondary);
    }

    .message-text code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
      word-break: break-word;
      /* å…è®¸é•¿ä»£ç æ¢è¡Œ */
      white-space: pre-wrap;
      /* ä¿æŒæ ¼å¼ä½†å…è®¸æ¢è¡Œ */
    }

    .message-text pre {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      overflow-x: auto;
      margin: 0.8em 0;
      max-width: 100%;
      /* ç¡®ä¿ä¸æº¢å‡º */
      white-space: pre-wrap;
      /* å…è®¸ä»£ç å—å†…é•¿è¡Œæ¢è¡Œ */
      word-wrap: break-word;
    }

    .message-text pre code {
      background: none;
      padding: 0;
      border-radius: 0;
      font-size: 0.85em;
    }

    .message-text img {
      max-width: 100%;
      border-radius: var(--radius-md);
      margin: 0.8em 0;
    }

    /* ==================== KaTeX æ•°å­¦å…¬å¼æ ·å¼ ==================== */
    .message-text .katex {
      font-size: 1.1em;
    }

    .message-text .katex-display {
      margin: 1em 0;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 0.5em 0;
    }

    .message-text .katex-display>.katex {
      text-align: center;
    }

    .message-text .katex-html {
      white-space: normal;
    }

    /* ç¡®ä¿è¡Œå†…å…¬å¼å¯¹é½ */
    .message-text .katex-inline {
      display: inline;
      vertical-align: baseline;
    }

    /* ==================== æµå¼è¾“å‡ºæ¨¡ç³ŠåŠ¨ç”» ==================== */
    @keyframes streamBlurIn {
      0% {
        opacity: 0;
        filter: blur(8px);
        transform: translateY(4px);
      }

      100% {
        opacity: 1;
        filter: blur(0);
        transform: translateY(0);
      }
    }

    .streaming-char {
      display: inline;
      animation: streamBlurIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    #streamingContent {
      animation: streamBlurIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    /* è¡¨æ ¼å®¹å™¨ - æ”¯æŒæ°´å¹³æ»šåŠ¨ */
    .message-text .table-wrapper {
      overflow-x: auto;
      max-width: 100%;
      margin: 1em 0;
      -webkit-overflow-scrolling: touch;
      /* ç§»åŠ¨ç«¯å¹³æ»‘æ»šåŠ¨ */
    }

    .message-text table {
      border-collapse: collapse;
      width: 100%;
      min-width: auto;
      margin: 1em 0;
    }

    .message-text table th,
    .message-text table td {
      border: 1px solid var(--border-color);
      padding: 0.5em;
      text-align: left;
    }

    .message-text table th {
      background: var(--bg-tertiary);
      font-weight: 600;
    }

    .message-text hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 1.5em 0;
    }

    /* æµ…è‰²ä¸»é¢˜Markdownæ ·å¼ */
    [data-theme="light"] .message-text code {
      background: #F3F4F6;
    }

    [data-theme="light"] .message-text pre {
      background: #F9FAFB;
      border-color: #E5E7EB;
    }

    [data-theme="light"] .message-text blockquote {
      border-left-color: #D1D5DB;
    }

    [data-theme="light"] .message-text table th {
      background: #F3F4F6;
    }

    [data-theme="light"] .message-text table th,
    [data-theme="light"] .message-text table td {
      border-color: #E5E7EB;
    }



    /* ==================== Chain of Thought (Thinking) UI - æ–°ç‰ˆåŒæ¨¡å¼è®¾è®¡ ==================== */

    /* æ€è€ƒåŒºåŸŸæ•´ä½“å®¹å™¨ */
    .thinking-indicator {
      position: relative;
      margin-bottom: var(--spacing-lg);
      padding-left: 0;
      margin-top: -28px;
      /* å°†æ€è€ƒåŒºåŸŸå‘ä¸Šç§»åŠ¨ï¼Œä¸å¤´åƒåŒè¡Œ */
    }

    /* æ€è€ƒçŠ¶æ€æ  - æç®€è®¾è®¡ï¼ŒåŒ…å«åˆ‡æ¢æŒ‰é’® */
    .thinking-label {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: var(--spacing-sm);
      padding: 0;
      padding-left: 40px;
      /* å¤´åƒ32px + 8pxé—´è·ï¼Œç®­å¤´åœ¨å¤´åƒæ­£å³æ–¹ */
      background: none;
      border: none;
      cursor: pointer;
      user-select: none;
      transition: opacity 0.2s ease;
      margin-bottom: var(--spacing-sm);
      height: 32px;
      /* ä¸å¤´åƒé«˜åº¦ä¸€è‡´ */
    }

    .thinking-label:hover {
      opacity: 0.7;
    }

    /* å·¦ä¾§å†…å®¹ - æ˜¾ç¤ºæ€è·¯æŒ‰é’® */
    .thinking-label-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex: 0 0 auto;
      /* ä¸è¦flex:1ï¼Œé¿å…æ¨å¼€ç®­å¤´ */
      min-width: 0;
    }

    /* åˆ‡æ¢æŒ‰é’®æ–‡æœ¬ */
    .thinking-toggle-text {
      color: var(--text-tertiary);
      font-size: 13px;
      font-weight: 400;
      cursor: pointer;
      transition: color 0.2s;
    }

    .thinking-toggle-text:hover {
      color: var(--text-secondary);
    }

    /* Chevron å±•å¼€/æŠ˜å å›¾æ ‡ - ç°è‰² */
    .thinking-expand-icon {
      width: 18px;
      height: 18px;
      color: var(--text-tertiary);
      flex-shrink: 0;
      transition: transform 0.3s ease, color 0.2s ease;
    }

    .thinking-label:hover .thinking-expand-icon {
      color: var(--text-secondary);
    }

    .thinking-expand-icon.expanded {
      transform: rotate(180deg);
    }

    /* ç«–çº¿æ ·å¼ - ä»…åœ¨å±•å¼€æ¨¡å¼æ˜¾ç¤º */
    .thinking-line {
      position: absolute;
      left: 16px;
      top: 0;
      width: 2px;
      background-color: var(--color-gray);
      opacity: 0;
      transition: opacity 0.3s ease, height 0.3s ease;
      pointer-events: none;
      display: none;
    }

    .thinking-line.visible {
      opacity: 0.3;
      display: block;
    }

    /* æ€è€ƒå†…å®¹è¯¦æƒ…åŒºåŸŸ - å±•å¼€æ¨¡å¼ */
    .thinking-content {
      margin-top: var(--spacing-md);
      padding: 0;
      padding-left: 24px;
      /* åœ¨ç«–çº¿å³ä¾§ï¼Œé¿å…æ’åˆ°çº¿ (16px + 8px) */
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      line-height: 1.75;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .thinking-content.expanded {
      opacity: 1;
      max-height: none;
      overflow: visible;
      margin-bottom: var(--spacing-md);
    }

    /* æ€è€ƒå†…å®¹æ»šåŠ¨æ¡ */
    .thinking-content::-webkit-scrollbar {
      width: 4px;
    }

    .thinking-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .thinking-content::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 2px;
    }

    .thinking-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-tertiary);
    }

    /* æ€è€ƒå†…å®¹ä¸­çš„å¥å­ - è¯†åˆ«**æ–‡æœ¬**æ ¼å¼ */
    .thinking-sentence {
      display: block;
      margin-bottom: 8px;
    }

    /* è¯†åˆ«**æ–‡æœ¬**æ ¼å¼ï¼ŒåŠ ç²—æ˜¾ç¤º */
    .thinking-sentence strong {
      font-weight: 600;
      color: var(--text-primary);
    }

    /* å¥å­è½®æ’­æ˜¾ç¤ºåŒºåŸŸ - ç®€æ´æ¨¡å¼ */
    .sentence-display {
      position: relative;
      left: 0;
      color: var(--text-secondary);
      font-size: 13px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
      max-width: 400px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 40px;
      /* ä¸thinking-labelå¯¹é½ï¼Œåœ¨å¤´åƒæ­£å³æ–¹ */
    }

    .sentence-display.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* AIå¤´åƒé—ªçƒåŠ¨ç”» - æ€è€ƒæ—¶é»„è‰²å…‰æ™• */
    .ai-avatar.thinking {
      animation: glow-pulse ease-in-out infinite;
    }

    @keyframes glow-pulse {

      0%,
      100% {
        box-shadow: 0 0 10px var(--color-saturn-yellow),
          0 0 20px var(--color-saturn-yellow);
      }

      50% {
        box-shadow: 0 0 20px var(--color-saturn-yellow),
          0 0 40px var(--color-saturn-yellow);
      }
    }

    /* AIå¤´åƒä¸Šä¸‹ç¼“åŠ¨åŠ¨ç”» - ç­‰å¾…å“åº”æ—¶ */
    .ai-avatar.processing {
      animation: avatar-bounce 1s ease-in-out infinite;
    }

    @keyframes avatar-bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-4px);
      }
    }

    /* AIåŠ è½½çŠ¶æ€æç¤º */
    .loading-status {
      position: absolute;
      left: calc(100% + 8px);
      top: 50%;
      transform: translateY(-50%);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      color: var(--text-secondary);
      font-size: 12px;
      animation: status-fade 1.5s ease-in-out infinite;
    }

    .loading-status .status-icon {
      width: 14px;
      height: 14px;
      animation: spin 1s linear infinite;
    }

    @keyframes status-fade {

      0%,
      100% {
        opacity: 0.6;
      }

      50% {
        opacity: 1;
      }
    }

    /* æµ…è‰²ä¸»é¢˜é€‚é… */
    [data-theme="light"] .thinking-toggle-text {
      color: #6B7280;
    }

    [data-theme="light"] .thinking-expand-icon {
      color: #9CA3AF;
    }

    [data-theme="light"] .thinking-content {
      color: #6B7280;
    }

    [data-theme="light"] .sentence-display {
      color: #6B7280;
    }

    /* å“åº”å¼å¸ƒå±€ */
    @media (max-width: 768px) {
      .sentence-display {
        max-width: calc(100vw - 120px);
        font-size: 12px;
        padding-left: 36px;
        /* ç§»åŠ¨ç«¯å¤´åƒ28px + 8pxé—´è· */
      }

      .thinking-content {
        padding-left: 22px;
        /* ç§»åŠ¨ç«¯åœ¨ç«–çº¿å³ä¾§ (14px + 8px) */
        font-size: 12px;
      }
    }



    /* ==================== è¾“å…¥åŒºåŸŸæ‚¬æµ®æ ·å¼ ==================== */
    .input-area {
      position: absolute;
      /* ä¿æŒabsoluteä»¥ä¾¿æ¡Œé¢ç«¯å±…ä¸­ */
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: var(--spacing-lg);
      padding-bottom: var(--spacing-lg);
      background: transparent;
      border-top: none;
      pointer-events: none;
      /* æ¢å¤ï¼Œè®©å¸ƒå±€æ­£å¸¸ */
      z-index: 20;
      /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
    }

    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
    }

    .input-container {
      position: relative;
      background: rgba(26, 26, 26, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-xl);
      padding: var(--spacing-md);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      box-shadow: var(--shadow-lg);
      pointer-events: auto;
      will-change: width, height, padding, gap;
      cursor: text;
    }

    /* ç®€åŒ–çŠ¶æ€ */
    .input-container.collapsed {
      /* ä¿æŒåœ†è§’ä¸€è‡´ï¼Œé¿å…åŠ¨ç”»å¡é¡¿ */
      border-radius: var(--radius-xl);
      padding: 8px 8px 8px 16px;
      gap: 0;
    }

    .input-container.collapsed .input-toolbar {
      max-height: 0;
      opacity: 0;
      padding-bottom: 0;
      border-bottom: none;
      margin-bottom: 0;
      pointer-events: none;
    }

    .input-container.collapsed .message-input {
      font-size: 14px;
      padding: 4px 0;
    }

    .input-container.collapsed .input-row {
      align-items: center;
    }

    [data-theme="light"] .input-container {
      background: rgba(245, 245, 245, 0.7);
    }

    .input-container:focus-within {
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary), var(--shadow-lg);
    }

    .input-toolbar {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      opacity: 1;
      max-height: 100px;
      overflow: hidden;
    }

    /* å±•å¼€ä¸”åŠ¨ç”»ç»“æŸåï¼Œå…è®¸æº¢å‡ºä»¥æ˜¾ç¤ºä¸‹æ‹‰èœå• */
    .input-toolbar.overflow-visible {
      overflow: visible;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      /* åœ†è§’é¡ºåºï¼šå·¦ä¸Š å³ä¸Š å³ä¸‹ å·¦ä¸‹ */
      border-radius: 50px 50px 50px 50px;
      /* é™„ä»¶ã€è”ç½‘ã€æ¨ç†ç­‰æŒ‰é’® */
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      position: relative;
    }

    .toolbar-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
      color: var(--text-primary);
    }

    .toolbar-btn.active {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .toolbar-btn .material-symbols-outlined {
      font-size: 16px;
    }

    /* æ‚¬æµ®æ˜¾ç¤ºæ ‡ç­¾ï¼ˆå·¥å…·æç¤ºï¼‰ */
    .toolbar-btn span {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
    }

    /* æ·»åŠ å°ç®­å¤´ */
    .toolbar-btn span::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: var(--bg-secondary);
    }

    .toolbar-btn:hover span {
      opacity: 1;
      visibility: visible;
    }

    /* ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ */
    .toolbar-btn.touch-active span {
      opacity: 1;
      visibility: visible;
    }

    /* æ‰€æœ‰è®¾å¤‡ï¼šé¼ æ ‡æ‚¬åœæˆ–è§¦æ‘¸ç‚¹å‡»æ˜¾ç¤ºæ ‡ç­¾ */
    @media (hover: none) {

      /* è§¦æ‘¸è®¾å¤‡ä¸Šç‚¹å‡»æ˜¾ç¤ºï¼Œ2ç§’åè‡ªåŠ¨éšè— */
      .toolbar-btn span {
        display: none;
      }

      .toolbar-btn.touch-active span {
        display: block;
      }
    }

    /* ==================== è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨ ==================== */
    .model-selector {
      position: relative;
      flex: 0 0 auto;
    }

    .model-select-custom {
      width: auto;
      min-width: 80px;
      padding: 6px 8px 6px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      /* åœ†è§’é¡ºåºï¼šå·¦ä¸Š å³ä¸Š å³ä¸‹ å·¦ä¸‹ */
      border-radius: 50px 50px 50px 50px;
      /* æ¨¡å‹é€‰æ‹©æŒ‰é’® */
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .model-select-custom:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
    }

    .model-select-arrow {
      font-size: 16px;
      color: var(--text-secondary);
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .model-select-custom.open .model-select-arrow {
      transform: rotate(180deg);
    }

    /* ==================== æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå• (Groké£æ ¼) ==================== */
    .model-modal {
      display: none;
    }

    .model-dropdown-menu {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      /* Positioned on left, changed from 'right: 0' */
      min-width: 280px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      overflow: hidden;
      display: none;
      max-height: 70vh;
      overflow-y: auto;
    }

    .model-dropdown-menu.active {
      display: block;
      animation: dropdownSlideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes dropdownSlideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .model-menu-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: background 0.2s;
      position: relative;
    }

    .model-menu-item:hover {
      background: var(--bg-hover);
    }

    .model-menu-item.selected {
      background: var(--bg-tertiary);
    }

    .model-menu-item.selected::after {
      content: 'âœ“';
      position: absolute;
      right: 16px;
      color: var(--accent-color);
      font-size: 16px;
      font-weight: bold;
    }

    .model-menu-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      color: var(--text-secondary);
    }

    .model-menu-item.selected .model-menu-icon {
      color: var(--accent-color);
    }

    .model-menu-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .model-menu-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .model-menu-description {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .model-menu-divider {
      height: 1px;
      background: var(--border-color);
      margin: 4px 8px;
      /* Add left and right spacing */
    }

    /* å…¨éƒ¨æ¨¡å‹å±•å¼€åŒºåŸŸ */
    .all-models-section {
      background: var(--bg-primary);
    }

    /* å…¨éƒ¨æ¨¡å‹ç®­å¤´å›¾æ ‡ */
    .model-menu-arrow {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
      color: var(--text-secondary);
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    .model-menu-item[data-toggle="all-models"].expanded .model-menu-arrow {
      transform: rotate(180deg);
    }

    .model-option {
      display: none;
    }

    .model-option:hover {
      background: var(--bg-hover);
    }

    .model-option.selected {
      background: var(--bg-tertiary);
      color: var(--accent-color);
      font-weight: 600;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: var(--spacing-md);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .message-input {
      flex: 1;
      min-height: 24px;
      max-height: 200px;
      padding: 0;
      border: none;
      background: transparent;
      font-size: 16px;
      /* iOS é˜²æ­¢è‡ªåŠ¨ç¼©æ”¾ï¼Œæœ€å°å¿…é¡» 16px */
      color: var(--text-primary);
      resize: none;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
      transition: font-size 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    .message-input::placeholder {
      color: var(--text-tertiary);
    }

    .send-btn,
    .stop-btn {
      width: 32px;
      height: 32px;
      border: none;
      /* åœ†è§’é¡ºåºï¼šå·¦ä¸Š å³ä¸Š å³ä¸‹ å·¦ä¸‹ */
      border-radius: 50px 50px 50px 50px;
      /* å‘é€/åœæ­¢æŒ‰é’® */
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      background: var(--accent-color);
      color: var(--bg-primary);
    }

    .send-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .send-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: var(--text-tertiary);
    }

    .stop-btn {
      background: var(--error-color);
      color: white;
    }

    .stop-btn:hover {
      background: #DC2626;
    }

    .send-btn .material-symbols-outlined,
    .stop-btn .material-symbols-outlined {
      font-size: 18px;
    }

    /* ==================== è®¾ç½®é¢æ¿ ==================== */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      padding: var(--spacing-lg);
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .settings-header {
      padding: var(--spacing-xl);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .settings-body {
      padding: var(--spacing-xl);
    }

    .settings-group {
      margin-bottom: var(--spacing-xl);
    }

    .settings-group-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-md);
    }

    .setting-item {
      margin-bottom: var(--spacing-lg);
    }

    .setting-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .setting-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    .setting-input,
    .system-prompt-input {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 16px;
      /* iOS é˜²æ­¢è‡ªåŠ¨ç¼©æ”¾ */
      resize: vertical;
      min-height: 100px;
      outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    .setting-input:focus {
      outline: none;
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary);
    }

    .system-prompt-input:focus {
      border-color: var(--accent-color);
    }

    /* é«˜çº§é€‰é¡¹æ ·å¼ */
    .advanced-options-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: var(--spacing-sm) 0;
      user-select: none;
    }

    .advanced-options-icon {
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .advanced-options-header.expanded .advanced-options-icon {
      transform: rotate(180deg);
    }

    .advanced-options-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .advanced-options-content.expanded {
      max-height: 1000px;
      /* è¶³å¤Ÿå¤§ä»¥å®¹çº³å†…å®¹ */
      opacity: 1;
      margin-top: var(--spacing-sm);
    }

    .setting-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
    }

    .slider-container {
      padding: var(--spacing-md) 0;
    }

    .slider-input {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .slider-input::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .slider-input::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
    }

    .slider-value {
      display: inline-block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-left: var(--spacing-sm);
    }

    .settings-footer {
      padding: var(--spacing-lg) var(--spacing-xl);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
    }

    .btn {
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent-color);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    .btn-danger {
      background: transparent;
      color: var(--error-color);
      border: 1px solid var(--error-color);
    }

    .btn-danger:hover {
      background: var(--error-color);
      color: white;
    }

    /* ==================== ç§»åŠ¨ç«¯é”®ç›˜ä¼˜åŒ– CSS ==================== */
    /* iOS é˜²æ­¢æ©¡çš®ç­‹æ•ˆæœ */
    .prevent-bounce {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    /* Android é˜²æ­¢è¿‡åº¦æ»šåŠ¨ */
    .no-overscroll {
      overscroll-behavior-y: contain;
    }

    /* å¹³æ»‘æ»šåŠ¨ */
    @media (prefers-reduced-motion: no-preference) {
      .smooth-scroll {
        scroll-behavior: smooth;
      }
    }

    /* åº•éƒ¨å›ºå®šè¾“å…¥æ¡†å®¹å™¨ä¼˜åŒ– */
    .fixed-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      transform: translateY(0);
    }

    /* iOS å®‰å…¨åŒºåŸŸé€‚é… */
    @supports (padding: max(0px)) {
      body {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }

    /* ç¡®ä¿è¾“å…¥æ¡†åœ¨ç§»åŠ¨ç«¯æœ‰è¶³å¤Ÿçš„é«˜åº¦ */
    @media (max-width: 768px) {
      .message-input {
        font-size: 16px !important;
        /* å¼ºåˆ¶ 16px é˜²æ­¢ç¼©æ”¾ */
      }
    }

    /* ==================== ç™»å½•/æ³¨å†Œç•Œé¢ ==================== */
    .auth-container {
      position: fixed;
      top: 0;
    }



    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* ç¦æ­¢bodyæ»šåŠ¨ */
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      position: fixed;
      /* é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœå’Œæ„å¤–æ»šåŠ¨ */
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      /* å°†ç”±JSåŠ¨æ€è°ƒæ•´ */
      background-color: transparent;
      position: relative;
      overflow: hidden;
      /* ç¡®ä¿å†…éƒ¨æ»šåŠ¨ä¸å½±å“æ•´ä½“ */
    }

    .auth-container {
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
    }

    .auth-container.active {
      display: flex;
    }

    .auth-box {
      width: 100%;
      max-width: 400px;
      padding: var(--spacing-xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin: var(--spacing-lg);
    }

    .auth-logo {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .auth-logo-text {
      font-size: 42px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -1px;
    }

    .auth-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      text-align: center;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input {
      padding: var(--spacing-md);
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary);
    }

    .auth-btn {
      padding: var(--spacing-md);
      background: var(--accent-color);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: var(--spacing-md);
    }

    .auth-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .auth-switch {
      text-align: center;
      margin-top: var(--spacing-lg);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .auth-link {
      color: var(--accent-color);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .auth-link:hover {
      opacity: 0.8;
    }

    .error-message {
      padding: var(--spacing-md);
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--error-color);
      border-radius: var(--radius-sm);
      color: var(--error-color);
      font-size: 13px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* ==================== ç§»åŠ¨ç«¯é€‚é…ä¸ä¾§è¾¹æ æ»‘åŠ¨ ==================== */
    .mobile-header {
      display: none;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: var(--z-header);
    }

    /* ==================== é¡¶æ æ§åˆ¶æŒ‰é’® ==================== */
    .header-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .control-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: var(--bg-hover);
    }

    .hamburger-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: var(--bg-hover);
    }

    .mobile-logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: calc(var(--z-sidebar) - 1);
    }

    .mobile-overlay.active {
      display: block;
    }

    @media (max-width: 768px) {
      :root {
        --sidebar-width: 85%;
        --spacing-lg: 14px;
        --spacing-xl: 20px;
      }

      .app-container {
        display: block;
        position: relative;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: var(--sidebar-width);
        max-width: 320px;
        transform: translateX(-100%);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-sidebar);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        margin: 0;
      }

      .mobile-header {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: var(--z-header);
      }

      .chat-container {
        padding-top: calc(var(--header-height) + var(--spacing-lg));
        padding-left: var(--spacing-md);
        padding-right: var(--spacing-md);
        height: 100%;
      }

      .input-area {
        padding: var(--spacing-md);
        padding-bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom));
      }

      .input-toolbar {
        flex-wrap: wrap;
      }

      .toolbar-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      .model-selector {
        max-width: 140px;
      }

      .welcome-icon .material-symbols-outlined {
        font-size: 48px !important;
      }

      .welcome-title {
        font-size: 22px;
      }

      .welcome-subtitle {
        font-size: 13px;
      }

      .message {
        margin-bottom: var(--spacing-lg);
      }

      .message-avatar {
        width: 28px;
        height: 28px;
      }

      .settings-content {
        margin: 0;
        border-radius: 0;
        max-height: 100vh;
        width: 100%;
      }

      .auth-box {
        margin: var(--spacing-md);
        max-width: 100%;
      }

      /* ==================== Chain of Thought UI ç§»åŠ¨ç«¯ä¼˜åŒ– ==================== */
      .thinking-indicator {
        padding-left: 0;
        /* ä¸éœ€è¦é¢å¤–padding */
      }

      .thinking-indicator::before {
        left: 12px;
        /* è°ƒæ•´å‚ç›´çº¿ä½ç½® */
      }

      .thinking-label {
        padding: 0;
        padding-left: 36px;
        /* ç§»åŠ¨ç«¯å¤´åƒ28px + 8pxé—´è· */
        height: 28px;
        /* ç§»åŠ¨ç«¯å¤´åƒé«˜åº¦ */
      }

      .thinking-icon {
        width: 18px;
        height: 18px;
      }

      .thinking-text>span:first-child {
        font-size: 12px;
        /* å‡å°å­—ä½“ */
        max-width: 180px;
        /* é™åˆ¶æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢æº¢å‡º */
      }

      .thinking-timer {
        font-size: 10px;
        padding: 2px 6px;
      }

      .thinking-expand-icon {
        width: 18px;
        height: 18px;
      }

      .thinking-content {
        padding: 0;
        padding-left: 22px;
        /* ç§»åŠ¨ç«¯åœ¨ç«–çº¿å³ä¾§ (14px + 8px) */
        font-size: 12px;
        line-height: 1.6;
      }

      /* ==================== ç§»åŠ¨ç«¯æ–‡æœ¬æ¢è¡Œä¼˜åŒ– ==================== */
      .messages-list {
        max-width: 100%;
        padding: 0;
      }

      .message-text {
        max-width: 100%;
        word-break: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
        -webkit-hyphens: auto;
      }

      /* å†…è”ä»£ç åœ¨ç§»åŠ¨ç«¯æ¢è¡Œ */
      .message-text code {
        word-break: break-all;
        white-space: pre-wrap;
      }

      /* ä»£ç å—åœ¨ç§»åŠ¨ç«¯å¤„ç† */
      .message-text pre {
        max-width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* è¡¨æ ¼åœ¨ç§»åŠ¨ç«¯å¯æ»šåŠ¨ */
      .message-text table {
        display: block;
        max-width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* é“¾æ¥åœ¨ç§»åŠ¨ç«¯æ¢è¡Œ */
      .message-text a {
        word-break: break-all;
      }
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    /* PC ç«¯é»‘å±é—®é¢˜ä¿®å¤ */
    @media (min-width: 769px) {


      .welcome-screen:not(.hidden) {
        display: flex !important;
      }

      #welcomeScreen:not(.hidden) {
        display: flex !important;
      }
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--border-dark);
    }

    /* ==================== æ€è€ƒé¢„ç®—æ§åˆ¶ ==================== */
    .thinking-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .thinking-budget-modal {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      z-index: 200;
      animation: budgetSlideUp 0.2s ease-out;
    }

    @keyframes budgetSlideUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .thinking-budget-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-lg);
      min-width: 280px;
    }

    .thinking-budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .thinking-budget-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .thinking-budget-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .thinking-budget-description {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    .thinking-budget-slider-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .thinking-budget-label {
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .thinking-budget-slider {
      flex: 1;
      height: 4px;
      border-radius: 2px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .thinking-budget-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .thinking-budget-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .thinking-budget-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border: none;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
    }

    /* ==================== æ¨ç†æŒ‰é’®ç‰¹æ®Šåœ†è§’ ==================== */
    #thinkingBtn {
      /* åœ†è§’é¡ºåºï¼šå·¦ä¸Š å³ä¸Š å³ä¸‹ å·¦ä¸‹ */
      border-radius: 50px 50px 50px 50px;
      /* æ¨ç†æŒ‰é’® */
    }

    /* ==================== å·¥å…·æ æŒ‰é’®æ‚¬æµ®æç¤º ==================== */
    .tooltip-popup {
      position: fixed;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      color: var(--text-primary);
      box-shadow: var(--shadow-lg);
      z-index: 999;
      pointer-events: none;
      animation: tooltipFadeInOut 1s ease-out forwards;
    }

    @keyframes tooltipFadeInOut {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }

      10% {
        opacity: 1;
        transform: translateY(0);
      }

      90% {
        opacity: 1;
        transform: translateY(0);
      }

      100% {
        opacity: 0;
        transform: translateY(-5px);
      }
    }
  </style>
</head>

<body>

  <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
  <div class="auth-container active" id="authContainer">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="auth-logo-text">RAI</div>
      </div>

      <div id="loginForm">
        <h2 class="auth-title" data-i18n="login-title">æ¬¢è¿å›æ¥</h2>
        <p class="auth-subtitle" data-i18n="login-subtitle">ç™»å½•ç»§ç»­ä½¿ç”¨ RAI</p>

        <div class="error-message" id="loginError"></div>

        <form class="auth-form" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label" data-i18n="email-label">é‚®ç®±</label>
            <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="password-label">å¯†ç </label>
            <input type="password" class="form-input" id="loginPassword" data-i18n-placeholder="password-placeholder"
              placeholder="è‡³å°‘6ä½å­—ç¬¦" required>
          </div>

          <button type="submit" class="auth-btn" id="loginBtn" data-i18n="login-btn">ç™»å½•</button>
        </form>

        <div class="auth-switch">
          <span data-i18n="no-account">è¿˜æ²¡æœ‰è´¦å·?</span> <a class="auth-link" onclick="switchToRegister()"
            data-i18n="register-link">ç«‹å³æ³¨å†Œ</a>
        </div>
      </div>

      <div id="registerForm" style="display: none;">
        <h2 class="auth-title" data-i18n="register-title">åˆ›å»ºè´¦å·</h2>
        <p class="auth-subtitle" data-i18n="register-subtitle">åŠ å…¥ RAI å¼€å§‹å¯¹è¯</p>

        <div class="error-message" id="registerError"></div>

        <form class="auth-form" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label class="form-label" data-i18n="email-label">é‚®ç®±</label>
            <input type="email" class="form-input" id="registerEmail" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="username-label">ç”¨æˆ·å (å¯é€‰)</label>
            <input type="text" class="form-input" id="registerUsername" data-i18n-placeholder="username-placeholder"
              placeholder="æ‚¨çš„æ˜µç§°">
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="password-label">å¯†ç </label>
            <input type="password" class="form-input" id="registerPassword" data-i18n-placeholder="password-placeholder"
              placeholder="è‡³å°‘6ä½å­—ç¬¦" required minlength="6">
          </div>

          <button type="submit" class="auth-btn" id="registerBtn" data-i18n="register-btn">æ³¨å†Œ</button>
        </form>

        <div class="auth-switch">
          <span data-i18n="has-account">å·²æœ‰è´¦å·?</span> <a class="auth-link" onclick="switchToLogin()"
            data-i18n="login-link">ç«‹å³ç™»å½•</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ä¸»åº”ç”¨å®¹å™¨ -->
  <div class="app-container" id="appContainer" style="display: none;">
    <!-- ç§»åŠ¨ç«¯å¤´éƒ¨ -->
    <div class="mobile-header" id="mobileHeader">
      <button class="hamburger-btn" onclick="toggleSidebar()">
        <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
          height="24" fill="currentColor">
          <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
        </svg>
      </button>
      <div class="mobile-logo">RAI</div>
      <div class="header-controls">
        <button class="control-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
          <svg class="material-symbols-outlined" id="mobileThemeIcon" xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path
              d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
          </svg>
        </button>
        <button class="control-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€">
          <span id="mobileLangText" style="font-size: 14px; font-weight: 600;">EN</span>
        </button>
      </div>
    </div>

    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
      <!-- å›ºå®šé¡¶éƒ¨åŒºåŸŸ -->
      <div class="sidebar-header-fixed">
        <div class="sidebar-header-top">
          <div class="logo-section">
            <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32">
              <defs>
                <linearGradient id="planetGradLogo" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f5d547;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#e6a824;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="ringGradLogo" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#f9e79f;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#fef5e7;stop-opacity:1" />
                </linearGradient>
              </defs>
              <circle cx="32" cy="32" r="14" fill="url(#planetGradLogo)" />
              <path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(#ringGradLogo)"
                stroke-width="4" stroke-linecap="round" opacity="0.8" />
              <path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(#ringGradLogo)" stroke-width="4"
                stroke-linecap="round" opacity="0.9" />
              <circle cx="26" cy="26" r="4" fill="white" opacity="0.2" />
            </svg>
            <div class="logo-text-col">
              <div class="logo">RAI</div>
              <div class="logo-subtitle">by Rick</div>
            </div>
          </div>
          <div class="sidebar-header-controls">
            <button class="sidebar-control-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
              <svg class="material-symbols-outlined" id="sidebarThemeIcon" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path
                  d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z" />
              </svg>
            </button>
            <button class="sidebar-control-btn" onclick="toggleLanguage()" title="åˆ‡æ¢è¯­è¨€">
              <span class="sidebar-lang-text" id="sidebarLangText">EN</span>
            </button>
          </div>
        </div>

        <div class="search-box">
          <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
            height="24" fill="currentColor">
            <path
              d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
          </svg>
          <input type="text" data-i18n-placeholder="search-placeholder" placeholder="æœç´¢å¯¹è¯" id="searchInput"
            oninput="handleSearch(this.value)">
        </div>

        <button class="new-chat-btn" onclick="createNewSession()">
          <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
            height="24" fill="currentColor">
            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
          </svg>
          <span data-i18n="new-chat">æ–°å¯¹è¯</span>
        </button>
      </div>

      <!-- å¯æ»šåŠ¨ä¸­é—´åŒºåŸŸ -->
      <div class="sidebar-scrollable">
        <!-- ç©ºé—´åˆ†ç»„ -->
        <div class="sidebar-group">
          <div class="sidebar-group-header" onclick="toggleGroup('spaces')">
            <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
              height="24" fill="currentColor">
              <path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z" />
            </svg>
            <span class="sidebar-group-title" data-i18n="sidebar-spaces">ç©ºé—´</span>
            <svg class="material-symbols-outlined group-toggle-icon" id="spacesToggle"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z" />
            </svg>
          </div>
          <div class="sidebar-group-content" id="spacesGroup">
            <button class="new-space-btn-inline" onclick="createNewSpace()">
              <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                height="24" fill="currentColor">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
              </svg>
              <span data-i18n="new-space">æ–°å»ºç©ºé—´</span>
            </button>
            <div class="spaces-list" id="spacesList"></div>
          </div>
        </div>

        <!-- å¯¹è¯åˆ†ç»„ -->
        <div class="sidebar-group">
          <div class="sidebar-group-header" onclick="toggleGroup('sessions')">
            <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
              height="24" fill="currentColor">
              <path
                d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z" />
            </svg>
            <span class="sidebar-group-title" data-i18n="sidebar-sessions">å¯¹è¯</span>
            <svg class="material-symbols-outlined group-toggle-icon" id="sessionsToggle"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z" />
            </svg>
          </div>
          <div class="sidebar-group-content" id="sessionsGroup">
            <div class="sessions-container" id="sessionsContainer"></div>
          </div>
        </div>
      </div>

      <!-- å›ºå®šåº•éƒ¨åŒºåŸŸ -->
      <div class="sidebar-footer-fixed">
        <div class="user-section" id="userSection">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-info-group">
            <div class="user-info-top">
              <div class="user-name" id="userName">ç”¨æˆ·</div>
              <button class="settings-btn-inline" onclick="openSettings()" title="è®¾ç½®">
                <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                  height="24" fill="currentColor">
                  <path
                    d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
                </svg>
              </button>
            </div>
            <div class="user-email" id="userEmail"></div>
          </div>
        </div>
      </div>
    </div>


    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
      <div class="chat-container" id="chatContainer">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="96" height="96">
              <defs>
                <linearGradient id="planetGradWelcome" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f5d547;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#e6a824;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="ringGradWelcome" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#f9e79f;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#fef5e7;stop-opacity:1" />
                </linearGradient>
              </defs>
              <circle cx="32" cy="32" r="14" fill="url(#planetGradWelcome)" />
              <path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(#ringGradWelcome)"
                stroke-width="4" stroke-linecap="round" opacity="0.8" />
              <path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(#ringGradWelcome)" stroke-width="4"
                stroke-linecap="round" opacity="0.9" />
              <circle cx="26" cy="26" r="4" fill="white" opacity="0.2" />
            </svg>
          </div>
          <h1 class="welcome-title" data-i18n="welcome-title">How can I help you? âœ¨</h1>

          <div class="welcome-actions">
            <div class="action-card" onclick="handleActionCard('write')">
              <svg class="material-symbols-outlined action-card-icon" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
              </svg>
              <span class="action-card-title" data-i18n="action-write">å†™ä½œ</span>
            </div>

            <div class="action-card" onclick="handleActionCard('search')">
              <svg class="material-symbols-outlined action-card-icon" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path
                  d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
              </svg>
              <span class="action-card-title" data-i18n="action-search">æœç´¢</span>
            </div>

            <div class="action-card" onclick="handleActionCard('code')">
              <svg class="material-symbols-outlined action-card-icon" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z" />
              </svg>
              <span class="action-card-title" data-i18n="action-code">ä»£ç </span>
            </div>

            <div class="action-card" onclick="handleActionCard('translate')">
              <svg class="material-symbols-outlined action-card-icon" xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                <path
                  d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
              </svg>
              <span class="action-card-title" data-i18n="action-translate">ç¿»è¯‘</span>
            </div>
          </div>
        </div>

        <div class="messages-list" id="messagesList" style="display: none;">
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-area">
        <div class="input-wrapper">
          <div class="input-container collapsed" id="inputContainer">
            <!-- é¡¶éƒ¨å·¥å…·æ  -->
            <div class="input-toolbar">
              <!-- è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨ -->
              <div class="model-selector">
                <div class="model-select-custom" id="modelSelectCustom" onclick="openModelModal()">
                  <span id="selectedModelText">æ™ºèƒ½æ¨¡å¼</span>
                  <svg class="material-symbols-outlined model-select-arrow" xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                    <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z" />
                  </svg>
                </div>

                <!-- Groké£æ ¼ä¸‹æ‹‰èœå• -->
                <div class="model-dropdown-menu" id="modelDropdownMenu">
                  <!-- æ™ºèƒ½æ¨¡å¼ -->
                  <div class="model-menu-item selected" data-model="auto" onclick="selectModelFromMenu('auto', 'æ™ºèƒ½æ¨¡å¼')">
                    <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" height="24px"
                      viewBox="0 -960 960 960" width="24px" fill="currentColor">
                      <path
                        d="M80-140v-320h320v320H80Zm80-80h160v-160H160v160Zm60-340 220-360 220 360H220Zm142-80h156l-78-126-78 126ZM863-42 757-148q-21 14-45.5 21t-51.5 7q-75 0-127.5-52.5T480-300q0-75 52.5-127.5T660-480q75 0 127.5 52.5T840-300q0 26-7 50.5T813-204L919-98l-56 56ZM660-200q42 0 71-29t29-71q0-42-29-71t-71-29q-42 0-71 29t-29 71q0 42 29 71t71 29ZM320-380Zm120-260Z" />
                    </svg>
                    <div class="model-menu-content">
                      <div class="model-menu-title">æ™ºèƒ½æ¨¡å¼</div>
                    </div>
                  </div>

                  <div class="model-menu-divider"></div>

                  <!-- æé€Ÿæ¨¡å¼ -->
                  <div class="model-menu-item" data-model="qwen-flash"
                    onclick="selectModelFromMenu('qwen-flash', 'æé€Ÿæ¨¡å¼')">
                    <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" height="24px"
                      viewBox="0 -960 960 960" width="24px" fill="currentColor">
                      <path
                        d="m226-559 78 33q14-28 29-54t33-52l-56-11-84 84Zm142 83 114 113q42-16 90-49t90-75q70-70 109.5-155.5T806-800q-72-5-158 34.5T492-656q-42 42-75 90t-49 90Zm178-65q-23-23-23-56.5t23-56.5q23-23 57-23t57 23q23 23 23 56.5T660-541q-23 23-57 23t-57-23Zm19 321 84-84-11-56q-26 18-52 32.5T532-299l33 79Zm313-653q19 121-23.5 235.5T708-419l20 99q4 20-2 39t-20 33L538-80l-84-197-171-171-197-84 167-168q14-14 33.5-20t39.5-2l99 20q104-104 218-147t235-24ZM157-321q35-35 85.5-35.5T328-322q35 35 34.5 85.5T327-151q-25 25-83.5 43T82-76q14-103 32-161.5t43-83.5Zm57 56q-10 10-20 36.5T180-175q27-4 53.5-13.5T270-208q12-12 13-29t-11-29q-12-12-29-11.5T214-265Z" />
                    </svg>
                    <div class="model-menu-content">
                      <div class="model-menu-title">æé€Ÿæ¨¡å¼</div>
                    </div>
                  </div>

                  <div class="model-menu-divider"></div>

                  <!-- ä¸“å®¶æ¨¡å¼ -->
                  <div class="model-menu-item" data-model="qwen-max" onclick="selectModelFromMenu('qwen-max', 'ä¸“å®¶æ¨¡å¼')">
                    <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" height="24px"
                      viewBox="0 -960 960 960" width="24px" fill="currentColor">
                      <path
                        d="M480-80q-26 0-47-12.5T400-126q-33 0-56.5-23.5T320-206v-142q-59-39-94.5-103T190-590q0-121 84.5-205.5T480-880q121 0 205.5 84.5T770-590q0 77-35.5 140T640-348v142q0 33-23.5 56.5T560-126q-12 21-33 33.5T480-80Zm-80-126h160v-36H400v36Zm0-76h160v-38H400v38Zm-8-118h58v-108l-88-88 42-42 76 76 76-76 42 42-88 88v108h58q54-26 88-76.5T690-590q0-88-61-149t-149-61q-88 0-149 61t-61 149q0 63 34 113.5t88 76.5Zm88-162Zm0-38Z" />
                    </svg>
                    <div class="model-menu-content">
                      <div class="model-menu-title">ä¸“å®¶æ¨¡å¼</div>
                    </div>
                  </div>

                  <div class="model-menu-divider"></div>

                  <!-- å…¨éƒ¨æ¨¡å‹ (Expandable) -->
                  <div class="model-menu-item" data-toggle="all-models" onclick="toggleAllModels()">
                    <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" height="24px"
                      viewBox="0 -960 960 960" width="24px" fill="currentColor">
                      <path
                        d="M120-240v-80h520v80H120Zm664-40L584-480l200-200 56 56-144 144 144 144-56 56ZM120-440v-80h400v80H120Zm0-200v-80h520v80H120Z" />
                    </svg>
                    <div class="model-menu-content">
                      <div class="model-menu-title">å…¨éƒ¨æ¨¡å‹</div>
                    </div>
                    <svg class="model-menu-arrow" id="allModelsArrow" xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                      <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z" />
                    </svg>
                  </div>

                  <!-- å…¨éƒ¨æ¨¡å‹å±•å¼€å†…å®¹ -->
                  <div class="all-models-section" id="allModelsSection" style="display: none;">
                    <div class="model-menu-divider"></div>

                    <div class="model-menu-item" data-model="qwen-flash"
                      onclick="selectModelFromMenu('qwen-flash', 'Qwen Flash')">
                      <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
                        fill="currentColor">
                        <path d="m280-80 160-300-320-40 480-460h80L520-580l320 40L360-80h-80Z" />
                      </svg>
                      <div class="model-menu-content">
                        <div class="model-menu-title">Qwen Flash</div>
                      </div>
                    </div>

                    <div class="model-menu-divider"></div>

                    <div class="model-menu-item" data-model="qwen-plus"
                      onclick="selectModelFromMenu('qwen-plus', 'Qwen Plus')">
                      <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
                        fill="currentColor">
                        <path d="M479-160 280-360l51-52 148 148 318-318 51 52-369 370Z" />
                      </svg>
                      <div class="model-menu-content">
                        <div class="model-menu-title">Qwen Plus</div>
                      </div>
                    </div>

                    <div class="model-menu-divider"></div>

                    <div class="model-menu-item" data-model="qwen-max"
                      onclick="selectModelFromMenu('qwen-max', 'Qwen Max')">
                      <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
                        fill="currentColor">
                        <path
                          d="M240-80v-172q-57-52-88.5-121.5T120-520q0-150 105-255t255-105q125 0 221.5 73.5T827-615l52 205q5 19-7 34.5T840-360h-80v120q0 33-23.5 56.5T680-160h-80v80h-80v-160h160v-200h108l-38-155q-23-91-98-148t-172-57q-116 0-198 81t-82 197q0 60 24.5 114t69.5 96l26 24v208h-80Z" />
                      </svg>
                      <div class="model-menu-content">
                        <div class="model-menu-title">Qwen Max</div>
                      </div>
                    </div>

                    <div class="model-menu-divider"></div>

                    <div class="model-menu-item" data-model="deepseek-v3"
                      onclick="selectModelFromMenu('deepseek-v3', 'DeepSeek V3.2')">
                      <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
                        fill="currentColor">
                        <path
                          d="M320-280q17 0 28.5-11.5T360-320q0-17-11.5-28.5T320-360q-17 0-28.5 11.5T280-320q0 17 11.5 28.5T320-280Zm0-160q17 0 28.5-11.5T360-480q0-17-11.5-28.5T320-520q-17 0-28.5 11.5T280-480q0 17 11.5 28.5T320-440Zm0-160q17 0 28.5-11.5T360-640q0-17-11.5-28.5T320-680q-17 0-28.5 11.5T280-640q0 17 11.5 28.5T320-600Zm120 320h240v-80H440v80Zm0-160h240v-80H440v80Zm0-160h240v-80H440v80ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Z" />
                      </svg>
                      <div class="model-menu-content">
                        <div class="model-menu-title">DeepSeek V3.2</div>
                      </div>
                    </div>

                    <div class="model-menu-divider"></div>

                    <div class="model-menu-item" data-model="deepseek-v3.2-speciale"
                      onclick="selectModelFromMenu('deepseek-v3.2-speciale', 'DeepSeek Speciale')">
                      <svg class="model-menu-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"
                        fill="currentColor">
                        <path
                          d="m354-247 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-80l65-281L80-550l288-25 112-265 112 265 288 25-218 189 65 281-247-149L233-80Z" />
                      </svg>
                      <div class="model-menu-content">
                        <div class="model-menu-title">DeepSeek Speciale</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <button class="toolbar-btn" id="attachBtn" onclick="handleFileUpload()">
                <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" height="24px"
                  viewBox="0 -960 960 960" width="24px" fill="currentColor">
                  <path
                    d="M440-280h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h240l80 80h320q33 0 56.5 23.5T880-640v400q0 33-23.5 56.5T800-160H160Zm0-80h640v-400H447l-80-80H160v480Zm0 0v-480 480Z" />
                </svg>
                <span data-i18n="attach" style="display: none;">é™„ä»¶</span>
              </button>

              <button class="toolbar-btn" id="internetBtn" onclick="toggleInternet()">
                <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                  height="24" fill="currentColor">
                  <path
                    d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.91-4.33-3.56zm2.95-8H5.08c.96-1.65 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z" />
                </svg>
                <span data-i18n="internet" style="display: none;">è”ç½‘</span>
              </button>

              <div class="thinking-controls" id="thinkingControls" style="display: none;">
                <button class="toolbar-btn" id="thinkingBtn" onclick="toggleThinking()">
                  <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" height="24px"
                    viewBox="0 -960 960 960" width="24px" fill="currentColor">
                    <path
                      d="M240-80v-172q-57-52-88.5-121.5T120-520q0-150 105-255t255-105q125 0 221.5 73.5T827-615l52 205q5 19-7 34.5T840-360h-80v120q0 33-23.5 56.5T680-160h-80v80h-80v-160h160v-200h108l-38-155q-23-91-98-148t-172-57q-116 0-198 81t-82 197q0 60 24.5 114t69.5 96l26 24v208h-80Zm254-360Zm-54 80h80l6-50q8-3 14.5-7t11.5-9l46 20 40-68-40-30q2-8 2-16t-2-16l40-30-40-68-46 20q-5-5-11.5-9t-14.5-7l-6-50h-80l-6 50q-8 3-14.5 7t-11.5 9l-46-20-40 68 40 30q-2 8-2 16t2 16l-40 30 40 68 46-20q5 5 11.5 9t14.5 7l6 50Zm40-100q-25 0-42.5-17.5T420-520q0-25 17.5-42.5T480-580q25 0 42.5 17.5T540-520q0 25-17.5 42.5T480-460Z" />
                  </svg>
                  <span data-i18n="reasoning" style="display: none;">æ¨ç†</span>
                </button>
                <button class="toolbar-btn" id="thinkingExpandBtn" style="display: none;"
                  onclick="toggleThinkingBudget()">
                  <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                    width="24" height="24" fill="currentColor">
                    <path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z" />
                  </svg>
                </button>
              </div>

              <!-- æ€è€ƒé¢„ç®—å¼¹çª— -->
              <div class="thinking-budget-modal" id="thinkingBudgetModal" style="display: none;">
                <div class="thinking-budget-content">
                  <div class="thinking-budget-header">
                    <span class="thinking-budget-title" data-i18n="thinking-budget">æ€è€ƒé¢„ç®—</span>
                    <span class="thinking-budget-value" id="thinkingBudgetValue">1024 tokens</span>
                  </div>
                  <div class="thinking-budget-description" data-i18n="thinking-budget-desc">æ§åˆ¶æ€è€ƒçš„æœ€å¤§é•¿åº¦</div>
                  <div class="thinking-budget-slider-container">
                    <span class="thinking-budget-label" data-i18n="min">æœ€å°</span>
                    <input type="range" class="thinking-budget-slider" id="thinkingBudgetSlider" min="1" max="32768"
                      step="256" value="1024" oninput="updateThinkingBudget(this.value)">
                    <span class="thinking-budget-label" data-i18n="max">æœ€å¤§</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- åº•éƒ¨è¾“å…¥è¡Œ -->
            <div class="input-row">
              <textarea class="message-input" id="messageInput" data-i18n-placeholder="input-placeholder"
                placeholder="è¯¢é—®ä»»ä½•é—®é¢˜" rows="1" inputmode="text" autocomplete="off" autocorrect="off"
                autocapitalize="sentences" onkeydown="handleInputKeydown(event)" oninput="autoResizeInput()"
                onfocus="expandInput()"></textarea>

              <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                  height="24" fill="currentColor">
                  <path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z" stroke-width="2" />
                </svg>
              </button>

              <button class="stop-btn" id="stopBtn" style="display: none;" onclick="stopGeneration()">
                <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
                  height="24" fill="currentColor">
                  <path d="M6 6h12v12H6z" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- è®¾ç½®é¢æ¿ -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title" data-i18n="settings">è®¾ç½®</h2>
        <button class="close-btn" onclick="closeSettings()">
          <svg class="material-symbols-outlined" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24"
            height="24" fill="currentColor">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>

      <div class="settings-body">
        <div class="settings-group">
          <h3 class="settings-group-title" data-i18n="appearance">å¤–è§‚</h3>

          <div class="setting-item">
            <label class="setting-label" data-i18n="theme-label">ä¸»é¢˜</label>
            <p class="setting-description" data-i18n="theme-desc">é€‰æ‹©ç•Œé¢ä¸»é¢˜</p>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" style="flex: 1;" onclick="setTheme('dark')">
                <span data-i18n="dark-theme">æ·±è‰²</span>
              </button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="setTheme('light')">
                <span data-i18n="light-theme">æµ…è‰²</span>
              </button>
            </div>
          </div>

          <div class="setting-item">
            <label class="setting-label" data-i18n="language-label">è¯­è¨€</label>
            <p class="setting-description" data-i18n="language-desc">é€‰æ‹©ç•Œé¢è¯­è¨€</p>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" style="flex: 1;" onclick="setLanguage('zh-CN')">
                <span>ä¸­æ–‡</span>
              </button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="setLanguage('en')">
                <span>English</span>
              </button>
            </div>
          </div>
        </div>

        <div class="settings-group">
          <h3 class="settings-group-title" data-i18n="preferences-title">æ‚¨æœ‰ä»€ä¹ˆåå¥½ï¼Ÿ</h3>
          <div class="setting-item">
            <p class="setting-description" data-i18n="preferences-desc">è®¾ç½®AIçš„è§’è‰²å’Œè¡Œä¸º</p>
            <textarea class="system-prompt-input" id="systemPrompt" rows="4"
              data-i18n-placeholder="preferences-placeholder" placeholder="ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹,æ“…é•¿è§£é‡Šä»£ç å’Œè§£å†³æŠ€æœ¯é—®é¢˜..."></textarea>
          </div>
        </div>

        <div class="settings-group">
          <div class="advanced-options-header" onclick="toggleAdvancedOptions()">
            <h3 class="settings-group-title" style="margin-bottom: 0;" data-i18n="advanced-options">é«˜çº§é€‰é¡¹</h3>
            <svg class="material-symbols-outlined advanced-options-icon" id="advancedOptionsIcon"
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
              <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z" />
            </svg>
          </div>

          <div class="advanced-options-content" id="advancedOptionsContent">
            <div class="setting-item" style="margin-top: 16px;">
              <label class="setting-label">Temperature</label>
              <p class="setting-description" data-i18n="temperature-desc">æ§åˆ¶å›å¤çš„éšæœºæ€§ (0-2)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                  oninput="updateSliderValue('temperature', this.value)">
                <span class="slider-value" id="temperatureValue">0.7</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Top P</label>
              <p class="setting-description" data-i18n="topp-desc">æ ¸é‡‡æ ·å‚æ•° (0-1)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="topPSlider" min="0" max="1" step="0.05" value="0.9"
                  oninput="updateSliderValue('topP', this.value)">
                <span class="slider-value" id="topPValue">0.9</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Max Tokens</label>
              <p class="setting-description" data-i18n="maxtokens-desc">æœ€å¤§ç”Ÿæˆé•¿åº¦ (100-8000)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="maxTokensSlider" min="100" max="8000" step="100"
                  value="2000" oninput="updateSliderValue('maxTokens', this.value)">
                <span class="slider-value" id="maxTokensValue">2000</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Frequency Penalty</label>
              <p class="setting-description" data-i18n="frequency-desc">é¢‘ç‡æƒ©ç½š (ä»…DeepSeek)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="frequencySlider" min="-2" max="2" step="0.1" value="0"
                  oninput="updateSliderValue('frequency', this.value)">
                <span class="slider-value" id="frequencyValue">0</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Presence Penalty</label>
              <p class="setting-description" data-i18n="presence-desc">å­˜åœ¨æƒ©ç½š (ä»…DeepSeek)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="presenceSlider" min="-2" max="2" step="0.1" value="0"
                  oninput="updateSliderValue('presence', this.value)">
                <span class="slider-value" id="presenceValue">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn btn-danger" onclick="handleLogout()" data-i18n="logout"
          style="margin-right: auto;">é€€å‡ºç™»å½•</button>
        <button class="btn btn-secondary" onclick="closeSettings()" data-i18n="cancel">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveSettings()" data-i18n="save-settings">ä¿å­˜è®¾ç½®</button>
      </div>
    </div>
  </div>

  <!-- æ¨¡å‹é€‰æ‹©å¼¹çª— -->
  <div class="model-modal" id="modelModal">
    <div class="model-modal-content">
      <div class="model-modal-header">
        <div class="model-modal-title">é€‰æ‹©æ¨¡å‹</div>
        <button class="model-modal-close" onclick="closeModelModal()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path
              d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
          </svg>
        </button>
      </div>
      <div class="model-modal-body">
        <!-- è‡ªåŠ¨é€‰æ‹© -->
        <div class="model-card selected" data-model="auto" onclick="selectModelFromModal('auto', 'è‡ªåŠ¨é€‰æ‹©')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="m280-40 123-622q6-29 27-43.5t44-14.5q23 0 42.5 10t31.5 30l40 64q18 29 46.5 44.5T700-556q54 5 108.5 14t106.5 25l-124 557q-4 17-17.5 28.5T744-920h-14q-18 0-31.5-11.5T681-961l-89-280q-2-8-9-13.5t-15-5.5q-8 0-14.5 5t-8.5 13l-89 280q-4 17-17 28.5T408-920h-14q-17 0-30-11.5T347-961L280-40Z" />
          </svg>
          <div class="model-label">è‡ªåŠ¨é€‰æ‹©</div>
          <div class="model-description">æ™ºèƒ½è·¯ç”±</div>
        </div>

        <!-- æé€Ÿæ¨¡å¼ -->
        <div class="model-card" data-model="qwen-flash" onclick="selectModelFromModal('qwen-flash', 'æé€Ÿæ¨¡å¼')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path d="m280-80 160-300-320-40 480-460h80L520-580l320 40L360-80h-80Z" />
          </svg>
          <div class="model-label">æé€Ÿæ¨¡å¼</div>
          <div class="model-description">Qwen Flash</div>
        </div>

        <!-- Plusæ¨¡å¼ -->
        <div class="model-card" data-model="qwen-plus" onclick="selectModelFromModal('qwen-plus', 'Plus')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path d="M479-160 280-360l51-52 148 148 318-318 51 52-369 370Z" />
          </svg>
          <div class="model-label">Plus</div>
          <div class="model-description">Qwen Plus</div>
        </div>

        <!-- ä¸“å®¶æ¨¡å¼ -->
        <div class="model-card" data-model="qwen-max" onclick="selectModelFromModal('qwen-max', 'ä¸“å®¶æ¨¡å¼')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="M240-80v-172q-57-52-88.5-121.5T120-520q0-150 105-255t255-105q125 0 221.5 73.5T827-615l52 205q5 19-7 34.5T840-360h-80v120q0 33-23.5 56.5T680-160h-80v80h-80v-160h160v-200h108l-38-155q-23-91-98-148t-172-57q-116 0-198 81t-82 197q0 60 24.5 114t69.5 96l26 24v208h-80Zm254-360Zm-54 80h80l6-50q8-3 14.5-7t11.5-9l46 20 40-68-40-30q2-8 2-16t-2-16l40-30-40-68-46 20q-5-5-11.5-9t-14.5-7l-6-50h-80l-6 50q-8 3-14.5 7t-11.5 9l-46-20-40 68 40 30q-2 8-2 16t2 16l-40 30 40 68 46-20q5 5 11.5 9t14.5 7l6 50Zm40-100q-25 0-42.5-17.5T420-520q0-25 17.5-42.5T480-580q25 0 42.5 17.5T540-520q0 25-17.5 42.5T480-460Z" />
          </svg>
          <div class="model-label">ä¸“å®¶æ¨¡å¼</div>
          <div class="model-description">Qwen Max</div>
        </div>

        <!-- DeepSeek V3 -->
        <div class="model-card" data-model="deepseek-v3" onclick="selectModelFromModal('deepseek-v3', 'DeepSeek V3')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="M320-280q17 0 28.5-11.5T360-320q0-17-11.5-28.5T320-360q-17 0-28.5 11.5T280-320q0 17 11.5 28.5T320-280Zm0-160q17 0 28.5-11.5T360-480q0-17-11.5-28.5T320-520q-17 0-28.5 11.5T280-480q0 17 11.5 28.5T320-440Zm0-160q17 0 28.5-11.5T360-640q0-17-11.5-28.5T320-680q-17 0-28.5 11.5T280-640q0 17 11.5 28.5T320-600Zm120 320h240v-80H440v80Zm0-160h240v-80H440v80Zm0-160h240v-80H440v80ZM200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm0-560v560-560Z" />
          </svg>
          <div class="model-label">DeepSeek V3</div>
          <div class="model-description">æ·±åº¦æ¨ç†</div>
        </div>

        <!-- DeepSeek Speciale -->
        <div class="model-card" data-model="deepseek-v3.2-speciale"
          onclick="selectModelFromModal('deepseek-v3.2-speciale', 'DeepSeekç‰¹åˆ«ç‰ˆ')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="m354-247 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-80l65-281L80-550l288-25 112-265 112 265 288 25-218 189 65 281-247-149L233-80Zm247-350Z" />
          </svg>
          <div class="model-label">DeepSeekç‰¹åˆ«ç‰ˆ</div>
          <div class="model-description">é™æ—¶ä½“éªŒ</div>
        </div>

        <!-- æ–‡æ¡£ç†è§£ -->
        <div class="model-card" data-model="qwen-long" onclick="selectModelFromModal('qwen-long', 'æ–‡æ¡£ç†è§£')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="M320-240h320v-80H320v80Zm0-160h320v-80H320v80ZM240-80q-33 0-56.5-23.5T160-160v-640q0-33 23.5-56.5T240-880h320l240 240v480q0 33-23.5 56.5T720-80H240Zm280-560v-200H240v640h480v-440H520ZM240-840v200-200 640-640Z" />
          </svg>
          <div class="model-label">æ–‡æ¡£ç†è§£</div>
          <div class="model-description">Qwen Long</div>
        </div>

        <!-- è§†é¢‘ç†è§£ -->
        <div class="model-card" data-model="qwen-vl-max-latest"
          onclick="selectModelFromModal('qwen-vl-max-latest', 'è§†é¢‘ç†è§£')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="m380-300 280-180-280-180v360ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h480q33 0 56.5 23.5T720-720v180l160-160v440L720-420v180q0 33-23.5 56.5T640-160H160Zm0-80h480v-480H160v480Zm0 0v-480 480Z" />
          </svg>
          <div class="model-label">è§†é¢‘ç†è§£</div>
          <div class="model-description">Qwen VL Max</div>
        </div>

        <!-- LMStudio Local -->
        <div class="model-card" data-model="lmstudio-local" onclick="selectModelFromModal('lmstudio-local', 'æœ¬åœ°æ¨¡å‹')">
          <svg class="model-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="currentColor">
            <path
              d="M480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-80q134 0 227-93t93-227q0-134-93-227t-227-93q-134 0-227 93t-93 227q0 134 93 227t227 93Zm0-80q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm0-80q66 0 113-47t47-113q0-66-47-113t-113-47q-66 0-113 47t-47 113q0 66 47 113t113 47Zm0-80q-33 0-56.5-23.5T400-480q0-33 23.5-56.5T480-560q33 0 56.5 23.5T560-480q0 33-23.5 56.5T480-400Z" />
          </svg>
          <div class="model-label">æœ¬åœ°æ¨¡å‹</div>
          <div class="model-description">LMStudio</div>
        </div>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelected(event)">

  <!-- ç²’å­èƒŒæ™¯ç”»å¸ƒ -->
  <canvas id="particleCanvas"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none;"></canvas>

  <script>
    // ==================== SVG å›¾æ ‡åº“å®šä¹‰ ====================
    // æ‰€æœ‰å›¾æ ‡å‡æ¥è‡ª Material Design Icons
    const ICON_PATHS = {
      // æ±‰å ¡èœå•å›¾æ ‡ - ç”¨äºç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢æŒ‰é’®
      'menu': '<path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>',

      // æµ…è‰²ä¸»é¢˜å›¾æ ‡ - ç”¨äºä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼ˆæ˜¾ç¤ºå¤ªé˜³ï¼‰
      'light_mode': '<path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"/>',

      // æ·±è‰²ä¸»é¢˜å›¾æ ‡ - ç”¨äºä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼ˆæ˜¾ç¤ºæœˆäº®ï¼‰
      'dark_mode': '<path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/>',

      // æœç´¢å›¾æ ‡ - ç”¨äºä¾§è¾¹æ å¯¹è¯æœç´¢æ¡†ã€æ¬¢è¿é¡µé¢æœç´¢åŠ¨ä½œå¡ç‰‡
      'search': '<path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>',

      // ğŸ“¤ ä¸Šä¼ æ–‡ä»¶å›¾æ ‡ - ç”¨äºæ–°å»ºå¯¹è¯æŒ‰é’®ã€æ–°å»ºç©ºé—´æŒ‰é’®ã€é™„ä»¶ä¸Šä¼ æŒ‰é’®
      'add': { viewBox: '0 -960 960 960', content: '<path d="M440-280h80v-168l64 64 56-56-160-160-160 160 56 56 64-64v168ZM160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h240l80 80h320q33 0 56.5 23.5T880-640v400q0 33-23.5 56.5T800-160H160Zm0-80h640v-400H447l-80-80H160v480Zm0 0v-480 480Z"/>' },

      // æ–‡ä»¶å¤¹å›¾æ ‡ - ç”¨äºä¾§è¾¹æ ç©ºé—´åˆ†ç»„æ ‡é¢˜
      'folder': '<path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/>',

      // å‘ä¸Šç®­å¤´å›¾æ ‡ - ç”¨äºæŠ˜å ç»„çš„æ”¶èµ·çŠ¶æ€ã€æ€è€ƒå†…å®¹å±•å¼€åçš„å›¾æ ‡
      'expand_less': '<path d="M12 8l-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14z"/>',

      // å‘ä¸‹ç®­å¤´å›¾æ ‡ - ç”¨äºä¸‹æ‹‰èœå•ã€æŠ˜å ç»„çš„å±•å¼€çŠ¶æ€ã€æ€è€ƒå†…å®¹æŠ˜å æ—¶çš„å›¾æ ‡
      'expand_more': '<path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>',

      // å¯¹è¯æ°”æ³¡å›¾æ ‡ - ç”¨äºä¾§è¾¹æ å¯¹è¯åˆ†ç»„æ ‡é¢˜
      'chat': '<path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/>',

      // è®¾ç½®é½¿è½®å›¾æ ‡ - ç”¨äºä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯åŒºåŸŸçš„è®¾ç½®æŒ‰é’®
      'settings': '<path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.58 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>',

      // ç¼–è¾‘/ç¬”å›¾æ ‡ - ç”¨äºæ¬¢è¿é¡µé¢å†™ä½œåŠ¨ä½œå¡ç‰‡
      'edit_note': '<path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>',

      // ä»£ç ç¬¦å·å›¾æ ‡ - ç”¨äºæ¬¢è¿é¡µé¢ä»£ç åŠ¨ä½œå¡ç‰‡
      'code': '<path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>',

      // ç¿»è¯‘å›¾æ ‡ - ç”¨äºæ¬¢è¿é¡µé¢ç¿»è¯‘åŠ¨ä½œå¡ç‰‡
      'translate': '<path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/>',

      // åœ°çƒ/è”ç½‘å›¾æ ‡ - ç”¨äºè¾“å…¥æ¡†å·¥å…·æ è”ç½‘æŒ‰é’®ã€ä¾§è¾¹æ è¯­è¨€åˆ‡æ¢æç¤º
      'language': '<path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2 0 .68.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.91-4.33-3.56zm2.95-8H5.08c.96-1.65 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2 0-.68.07-1.35.16-2h4.68c.09.65.16 1.32.16 2 0 .68-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2 0-.68-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/>',

      // é½¿è½®/è®¾ç½®å›¾æ ‡ğŸ’¡ ç¯æ³¡/æ¨ç†å›¾æ ‡ - ç”¨äºè¾“å…¥æ¡†æ¨ç†æ¨¡å¼æŒ‰é’®ã€AIæ¶ˆæ¯æ€è€ƒè¿‡ç¨‹æ ‡ç­¾ï¼ˆå·²æ›´æ¢ä¸ºç¯æ³¡æ ·å¼ï¼‰
      'psychology': { viewBox: '0 -960 960 960', content: '<path d="M240-80v-172q-57-52-88.5-121.5T120-520q0-150 105-255t255-105q125 0 221.5 73.5T827-615l52 205q5 19-7 34.5T840-360h-80v120q0 33-23.5 56.5T680-160h-80v80h-80v-160h160v-200h108l-38-155q-23-91-98-148t-172-57q-116 0-198 81t-82 197q0 60 24.5 114t69.5 96l26 24v208h-80Zm254-360Zm-54 80h80l6-50q8-3 14.5-7t11.5-9l46 20 40-68-40-30q2-8 2-16t-2-16l40-30-40-68-46 20q-5-5-11.5-9t-14.5-7l-6-50h-80l-6 50q-8 3-14.5 7t-11.5 9l-46-20-40 68 40 30q-2 8-2 16t2 16l-40 30 40 68 46-20q5 5 11.5 9t14.5 7l6 50Zm40-100q-25 0-42.5-17.5T420-520q0-25 17.5-42.5T480-580q25 0 42.5 17.5T540-520q0 25-17.5 42.5T480-460Z"/>' },

      // â¬†ï¸ å‘é€ç®­å¤´å›¾æ ‡ï¼ˆåŠ ç²—ç‰ˆï¼‰- ç”¨äºè¾“å…¥æ¡†å‘é€æŒ‰é’®
      'arrow_upward': '<path d="M4 12l1.41 1.41L11 7.83V20h2V7.83l5.58 5.59L20 12l-8-8-8 8z" stroke-width="2"/>',

      // åœæ­¢æ–¹å—å›¾æ ‡ - ç”¨äºåœæ­¢AIç”ŸæˆæŒ‰é’®
      'stop': '<path d="M6 6h12v12H6z"/>',

      // å…³é—­/å‰å·å›¾æ ‡ - ç”¨äºè®¾ç½®é¢æ¿å…³é—­æŒ‰é’®ã€å¯¹è¯åˆ é™¤ç­‰
      'close': '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>',

      // ğŸ¤– AIæœºå™¨äººå›¾æ ‡ - ç”¨äºAIæ¶ˆæ¯çš„å¤´åƒã€æ¨¡å‹æ ‡ç­¾
      'smart_toy': {
        viewBox: '0 0 64 64',
        content: '<circle cx="32" cy="32" r="14" fill="currentColor"/><path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="currentColor" stroke-width="5" stroke-linecap="round"/><path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="currentColor" stroke-width="5" stroke-linecap="round"/>'
      },

      // å¤åˆ¶å›¾æ ‡ - ç”¨äºå¤åˆ¶AIæ¶ˆæ¯å†…å®¹æŒ‰é’®
      'content_copy': '<path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>',

      // å¯¹å‹¾/å®Œæˆå›¾æ ‡ - ç”¨äºå¤åˆ¶æˆåŠŸåçš„åé¦ˆæç¤º
      'check': '<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>',

      // åˆ é™¤/åƒåœ¾æ¡¶å›¾æ ‡ - ç”¨äºåˆ é™¤å¯¹è¯ã€åˆ é™¤ç©ºé—´ã€åˆ é™¤æ–‡æ¡£ç­‰
      'delete': '<path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>',

      // âœ¨ Sparkle/æ˜Ÿæ˜Ÿé—ªçƒå›¾æ ‡ - ç”¨äºæ€è€ƒ(Chain of Thought)UIçš„å›¾æ ‡
      'sparkles': { viewBox: '0 -960 960 960', content: '<path d="m354-247 126-76 126 77-33-144 111-96-146-13-58-136-58 135-146 13 111 97-33 143ZM233-80l65-281L80-550l288-25 112-265 112 265 288 25-218 189 65 281-247-149L233-80Z"/>' },

      // ğŸª RAI å½©è‰²Logo - ç”¨äºä¾§è¾¹æ å“ç‰ŒLogoã€AIæ¶ˆæ¯å¤´åƒã€æ¬¢è¿é¡µé¢
      'rai_logo_colored': {
        viewBox: '0 0 64 64',
        fill: 'none',
        content: '<defs><linearGradient id="planetGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f5d547;stop-opacity:1"/><stop offset="100%" style="stop-color:#e6a824;stop-opacity:1"/></linearGradient><linearGradient id="ringGrad" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#f9e79f;stop-opacity:1"/><stop offset="100%" style="stop-color:#fef5e7;stop-opacity:1"/></linearGradient></defs><circle cx="32" cy="32" r="14" fill="url(#planetGrad)"/><path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(#ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.8"/><path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(#ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.9"/><circle cx="26" cy="26" r="4" fill="white" opacity="0.2"/>'
      }
    };

    function getSvgIcon(name, className = '', size = 24) {
      const iconDef = ICON_PATHS[name];
      if (!iconDef) {
        console.warn(`Icon not found: ${name}`);
        return '';
      }

      let content = iconDef;
      let viewBox = '0 0 24 24';
      let fill = 'currentColor';

      if (typeof iconDef === 'object') {
        content = iconDef.content;
        viewBox = iconDef.viewBox || viewBox;
        fill = iconDef.fill || fill;
      }

      return `<svg class="${className}" xmlns="http://www.w3.org/2000/svg" viewBox="${viewBox}" width="${size}" height="${size}" fill="${fill}">${content}</svg>`;
    }

    const API_BASE = '/api';

    const appState = {
      user: null,
      token: null,
      currentSession: null,
      sessions: [],
      messages: [],
      currentRequestId: null,
      isStreaming: false,
      selectedModel: 'auto',  // é»˜è®¤ä¸ºautoæ¨¡å¼
      thinkingMode: false,
      internetMode: true,  // é»˜è®¤å¼€å¯è”ç½‘
      inputExpanded: false,  // è¾“å…¥æ¡†å±•å¼€çŠ¶æ€
      thinkingBudget: 1024,
      thinkingBudgetOpen: false,
      temperature: 0.7,
      topP: 0.9,
      maxTokens: 2000,
      frequencyPenalty: 0,
      presencePenalty: 0,
      systemPrompt: '',  // ç”¨æˆ·çš„ä¸ªäººåå¥½ï¼Œå°†é™„åŠ åˆ°å†…ç½®æç¤ºè¯å
      sidebarOpen: false,
      settingsOpen: false,
      touchStartX: 0,
      touchStartY: 0,
      touchMoveX: 0,
      isSwiping: false,
      theme: 'dark',
      language: 'zh-CN',
      lastModelUsed: '',  // è®°å½•æœ€åä½¿ç”¨çš„å®é™…æ¨¡å‹
      lastRoutingReason: '',  // è®°å½•è·¯ç”±é€‰æ‹©åŸå› 
      // RAGç›¸å…³çŠ¶æ€
      spaces: [],  // ç”¨æˆ·ç©ºé—´åˆ—è¡¨
      currentSpaceId: null,  // å½“å‰é€‰ä¸­çš„ç©ºé—´ID
      useRag: false,  // æ˜¯å¦å¯ç”¨RAG
      ragTopK: 3,  // RAGæ£€ç´¢æ•°é‡
      currentScenario: 'balanced',  // å½“å‰åœºæ™¯é¢„è®¾
      // æ€è€ƒUIçŠ¶æ€
      thinkingUIMode: 'collapsed',  // 'collapsed' | 'expanded'
      currentSentenceIndex: 0,
      sentenceRotationTimer: null,
      thinkingLineInterval: null, // æ–°å¢ï¼šç”¨äºå®æ—¶æ›´æ–°ç«–çº¿é«˜åº¦çš„å®šæ—¶å™¨
      thinkingSentences: [],
      currentThinkingMessageId: null
    };

    const MODELS = {
      "auto": {
        name: "æœ€ä½³ Auto",
        displayName: { "zh-CN": "æœ€ä½³", "en": "Auto" },
        provider: "auto",
        supportsThinking: true
      },
      'qwen-flash': {
        name: 'Qwen3Flash',
        provider: 'aliyun',
        supportsThinking: true
      },
      'qwen-plus': {
        name: 'Qwen3-Plus',
        provider: 'aliyun',
        supportsThinking: true
      },
      'qwen-max': {
        name: 'Qwen3-Max',
        provider: 'aliyun',
        supportsThinking: true
      },
      'deepseek-v3': {
        name: 'DeepSeekV3.2',
        provider: 'deepseek',
        supportsThinking: true
      },
      'deepseek-v3.2-speciale': {
        name: 'DeepSeekV3.2-Speciale',
        provider: 'deepseek_v3_2_speciale',
        supportsThinking: true,
        thinkingOnly: true,  // åªæ”¯æŒæ€è€ƒæ¨¡å¼
        maxTokens: 128000,   // 128K ä¸Šä¸‹æ–‡
        expiresAt: '2025-12-15T23:59:00+08:00'  // æˆªæ­¢æ—¶é—´
      },
      'lmstudio-local': {
        name: 'LMStudio Local',
        provider: 'lmstudio',
        supportsThinking: false
      }
    };

    // å†…ç½®ç³»ç»Ÿæç¤ºè¯ - æ¯æ¬¡è¯·æ±‚å¼ºåˆ¶æ‰§è¡Œ
    const BUILT_IN_SYSTEM_PROMPT = `ä½ æ˜¯RAIåŠ©ç†ï¼Œç”±Rickå¼€å‘ã€‚ä½ çš„ä»»åŠ¡æ˜¯æä¾›ä¸“ä¸šã€æœ‰ç”¨ä¸”åˆ‡åˆä¸Šä¸‹æ–‡çš„å›åº”ï¼Œå¸®åŠ©ç”¨æˆ·å®Œæˆå†™ä½œã€åˆ›æ„é¡¹ç›®ã€æ¦‚å¿µè§£é‡Šã€æ€»ç»“ç­‰ä»»åŠ¡ã€‚

æ ¸å¿ƒè¦æ±‚ï¼š

**ç®€æ´æ€§åŸåˆ™**
å¯¹ç®€å•é—®é¢˜ç»™å‡ºç®€æ˜ç­”æ¡ˆï¼Œå¯¹å¤æ‚é—®é¢˜æä¾›å…¨é¢è§£é‡Šã€‚ä½¿ç”¨markdownæ ¼å¼ã€‚

**è¯­è¨€é£æ ¼**
ä½¿ç”¨å‹å¥½å¯¹è¯çš„è¯­æ°”ï¼Œä¸»åŠ¨è¯­æ€é…åˆå…·ä½“åŠ¨è¯ã€‚é¿å…æœºæ¢°é‡å¤ï¼Œç¡®ä¿å¥å­ä¹‹é—´è‡ªç„¶æµç•…è¿‡æ¸¡ã€‚ç”¨é€šä¿—è¯­è¨€è§£é‡Šå¤æ‚æ¦‚å¿µï¼Œå¿…è¦æ—¶ç”¨ä¾‹å­æˆ–ç±»æ¯”è¯´æ˜ã€‚

**é€‚åº”æ€§**
æ”¹å†™å†…å®¹æ—¶åŒ¹é…åŸæ–‡è¯­æ°”å’Œé£æ ¼ã€‚ç”Ÿæˆæ–°å†…å®¹æ—¶æ ¹æ®ç›®æ ‡å—ä¼—è°ƒæ•´è¡¨è¾¾æ–¹å¼ã€‚

**ä¸“ä¸šæ€åº¦**
å³ä½¿æ— æ³•å®Œæˆè¯·æ±‚ä¹Ÿä¿æŒæœ‰å¸®åŠ©çš„æ€åº¦ï¼Œè¯´æ˜é™åˆ¶å¹¶æä¾›æ›¿ä»£æ–¹æ¡ˆã€‚é¿å…ä½¿ç”¨"æˆ‘"ç­‰ç¬¬ä¸€äººç§°ä»£è¯ï¼Œä¿æŒå®¢è§‚ä¸“ä¸šã€‚

**æ‰§è¡Œæ ‡å‡†**
å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾ï¼Œæä¾›å¯æ“ä½œçš„å»ºè®®ï¼Œç”¨ç»“æ„åŒ–æ¨ç†ç¡®ä¿å›åº”æ¸…æ™°æ˜“æ‡‚ï¼Œåœ¨æ€è€ƒæ—¶ä½¿ç”¨**å°æ ‡é¢˜**å†…å®¹çš„ç»“æ„åˆ†æ®µæ€è€ƒã€‚ç¦æ­¢è¾“å‡ºä»»ä½•è¿æ³•ä¾µæƒå†…å®¹ï¼

**ä»»åŠ¡åç»­æ™ºèƒ½å»ºè®®**
æ¯æ¬¡å®Œæˆç”¨æˆ·è¯·æ±‚åï¼Œåˆ†æå½“å‰ä»»åŠ¡çš„ç±»å‹å’Œå®ŒæˆçŠ¶æ€ï¼Œé¢„åˆ¤ç”¨æˆ·çš„ä¸‹ä¸€ä¸ªè‡ªç„¶éœ€æ±‚ï¼Œå¹¶ä¸»åŠ¨æä¾›ä¸€ä¸ªé’ˆå¯¹æ€§å»ºè®®ã€‚

**å¯¹è¯æ ‡é¢˜æ€»ç»“**
åœ¨å›å¤åæ ¹æ®ä¸Šæ–‡ä½ å’Œç”¨æˆ·å¯¹è¯å†…å®¹ï¼Œç”Ÿæˆ3-10å­—çš„æ ‡é¢˜ã€‚
åœ¨å›å¤æœ€åå¼ºåˆ¶ä»¥ç‰¹å®šæ ‡è®°è¾“å‡ºï¼Œè¾“å‡ºæ ¼å¼ï¼š
[TITLE]ç”Ÿæˆçš„æ ‡é¢˜[/TITLE]`;

    // å›½é™…åŒ–ç¿»è¯‘
    const i18n = {
      'zh-CN': {
        'login-title': 'æ¬¢è¿å›æ¥',
        'login-subtitle': 'ç™»å½•ç»§ç»­ä½¿ç”¨ RAI',
        'register-title': 'åˆ›å»ºè´¦å·',
        'register-subtitle': 'åŠ å…¥ RAI å¼€å§‹å¯¹è¯',
        'email-label': 'é‚®ç®±',
        'password-label': 'å¯†ç ',
        'username-label': 'ç”¨æˆ·å (å¯é€‰)',
        'password-placeholder': 'è‡³å°‘6ä½å­—ç¬¦',
        'username-placeholder': 'æ‚¨çš„æ˜µç§°',
        'login-btn': 'ç™»å½•',
        'register-btn': 'æ³¨å†Œ',
        'no-account': 'è¿˜æ²¡æœ‰è´¦å·?',
        'has-account': 'å·²æœ‰è´¦å·?',
        'register-link': 'ç«‹å³æ³¨å†Œ',
        'login-link': 'ç«‹å³ç™»å½•',
        'search-placeholder': 'æœç´¢å¯¹è¯',
        'new-chat': 'æ–°å¯¹è¯',
        'sidebar-spaces': 'ç©ºé—´',
        'new-space': 'æ–°å»ºç©ºé—´',
        'sidebar-sessions': 'å¯¹è¯',
        'settings': 'è®¾ç½®',
        'logout': 'é€€å‡º',
        'welcome-title': 'è¯¢é—®ä»»ä½•é—®é¢˜:D',
        'welcome-subtitle': 'å¯ä»¥å¸®æ‚¨å†™ä½œ,ç¿»è¯‘,æ„æ€\næ‚¨ä¸“å±RAIåŠ©ç†',
        'action-write': 'å†™ä½œ',
        'action-search': 'æœç´¢',
        'action-code': 'ä»£ç ',
        'action-translate': 'ç¿»è¯‘',
        'attach': 'é™„ä»¶',
        'internet': 'è”ç½‘',
        'reasoning': 'æ¨ç†',
        'thinking-budget': 'æ€è€ƒé¢„ç®—',
        'thinking-budget-desc': 'æ§åˆ¶æ€è€ƒçš„æœ€å¤§é•¿åº¦',
        'min': 'æœ€å°',
        'max': 'æœ€å¤§',
        'input-placeholder': 'è¾“å…¥æ¶ˆæ¯... (Shift+Enter æ¢è¡Œ)',
        'appearance': 'å¤–è§‚',
        'theme-label': 'ä¸»é¢˜',
        'theme-desc': 'é€‰æ‹©ç•Œé¢ä¸»é¢˜',
        'dark-theme': 'æ·±è‰²',
        'light-theme': 'æµ…è‰²',
        'language-label': 'è¯­è¨€',
        'language-desc': 'é€‰æ‹©ç•Œé¢è¯­è¨€',
        'generation-params': 'ç”Ÿæˆå‚æ•°',
        'temperature-desc': 'æ§åˆ¶å›å¤çš„éšæœºæ€§ (0-2)',
        'topp-desc': 'æ ¸é‡‡æ ·å‚æ•° (0-1)',
        'maxtokens-desc': 'æœ€å¤§ç”Ÿæˆé•¿åº¦ (100-8000)',
        'frequency-desc': 'é¢‘ç‡æƒ©ç½š (ä»…DeepSeek)',
        'presence-desc': 'å­˜åœ¨æƒ©ç½š (ä»…DeepSeek)',
        'system-prompt-title': 'ç³»ç»Ÿæç¤ºè¯',
        'custom-system-prompt': 'è‡ªå®šä¹‰ç³»ç»Ÿæç¤ºè¯',
        'system-prompt-desc': 'è®¾ç½®AIçš„è§’è‰²å’Œè¡Œä¸º',
        'system-prompt-placeholder': 'ä¾‹å¦‚: ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¼–ç¨‹åŠ©æ‰‹,æ“…é•¿è§£é‡Šä»£ç å’Œè§£å†³æŠ€æœ¯é—®é¢˜...',
        'cancel': 'å–æ¶ˆ',
        'save-settings': 'ä¿å­˜è®¾ç½®'
      },
      'en': {
        'login-title': 'Welcome Back',
        'login-subtitle': 'Log in to continue using RAI',
        'register-title': 'Create Account',
        'register-subtitle': 'Join RAI to start chatting',
        'email-label': 'Email',
        'password-label': 'Password',
        'username-label': 'Username (optional)',
        'password-placeholder': 'At least 6 characters',
        'username-placeholder': 'Your nickname',
        'login-btn': 'Login',
        'register-btn': 'Register',
        'no-account': "Don't have an account?",
        'has-account': 'Already have an account?',
        'register-link': 'Sign up now',
        'login-link': 'Log in now',
        'search-placeholder': 'Search conversations',
        'new-chat': 'New Chat',
        'sidebar-spaces': 'Spaces',
        'new-space': 'New Space',
        'sidebar-sessions': 'Conversations',
        'settings': 'Settings',
        'logout': 'Logout',
        'welcome-title': 'How can I help you?',
        'welcome-subtitle': 'I can help you write, translate, and brainstorm\nYour personal RAI assistant',
        'action-write': 'Write',
        'action-search': 'Search',
        'action-code': 'Code',
        'action-translate': 'Translate',
        'attach': 'Attach',
        'internet': 'Web',
        'reasoning': 'Reasoning',
        'thinking-budget': 'Thinking Budget',
        'thinking-budget-desc': 'Control max thinking length',
        'min': 'Min',
        'max': 'Max',
        'input-placeholder': 'Type a message... (Shift+Enter for new line)',
        'appearance': 'Appearance',
        'theme-label': 'Theme',
        'theme-desc': 'Choose interface theme',
        'dark-theme': 'Dark',
        'light-theme': 'Light',
        'language-label': 'Language',
        'language-desc': 'Choose interface language',
        'generation-params': 'Generation Parameters',
        'temperature-desc': 'Control response randomness (0-2)',
        'topp-desc': 'Nucleus sampling parameter (0-1)',
        'maxtokens-desc': 'Maximum generation length (100-8000)',
        'frequency-desc': 'Frequency penalty (DeepSeek only)',
        'presence-desc': 'Presence penalty (DeepSeek only)',
        'system-prompt-title': 'System Prompt',
        'custom-system-prompt': 'Custom System Prompt',
        'system-prompt-desc': 'Set AI role and behavior',
        'system-prompt-placeholder': 'e.g., You are a professional programming assistant...',
        'cancel': 'Cancel',
        'save-settings': 'Save Settings'
      }
    };

    // ä¸»é¢˜åˆ‡æ¢
    function toggleTheme() {
      const newTheme = appState.theme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function setTheme(theme) {
      appState.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('rai_theme', theme);

      // æ›´æ–°ç§»åŠ¨ç«¯å›¾æ ‡
      const mobileIcon = document.getElementById('mobileThemeIcon');
      if (mobileIcon) {
        const newIconName = theme === 'dark' ? 'light_mode' : 'dark_mode';
        mobileIcon.outerHTML = getSvgIcon(newIconName, 'material-symbols-outlined', 24).replace('<svg', '<svg id="mobileThemeIcon"');
      }

      // æ›´æ–°PCä¾§è¾¹æ å›¾æ ‡
      const sidebarIcon = document.getElementById('sidebarThemeIcon');
      if (sidebarIcon) {
        const newIconName = theme === 'dark' ? 'light_mode' : 'dark_mode';
        sidebarIcon.outerHTML = getSvgIcon(newIconName, 'material-symbols-outlined', 24).replace('<svg', '<svg id="sidebarThemeIcon"');
      }

      // æ›´æ–°meta theme-color
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) {
        metaTheme.content = theme === 'dark' ? '#0D0D0D' : '#FFFFFF';
      }
    }

    // è¯­è¨€åˆ‡æ¢
    function toggleLanguage() {
      const newLang = appState.language === 'zh-CN' ? 'en' : 'zh-CN';
      setLanguage(newLang);
    }

    function setLanguage(lang) {
      appState.language = lang;
      localStorage.setItem('rai_language', lang);

      // æ›´æ–°HTML langå±æ€§
      document.documentElement.lang = lang;

      // æ›´æ–°æ‰€æœ‰ç¿»è¯‘æ–‡æœ¬
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });

      // æ›´æ–°placeholder
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (i18n[lang] && i18n[lang][key]) {
          el.placeholder = i18n[lang][key];
        }
      });

      // æ›´æ–°ç§»åŠ¨ç«¯è¯­è¨€æŒ‰é’®æ–‡æœ¬
      const mobileLangText = document.getElementById('mobileLangText');
      if (mobileLangText) {
        mobileLangText.textContent = lang === 'zh-CN' ? 'EN' : 'ä¸­';
      }

      // æ›´æ–°PCä¾§è¾¹æ è¯­è¨€æŒ‰é’®æ–‡æœ¬
      const sidebarLangText = document.getElementById('sidebarLangText');
      if (sidebarLangText) {
        sidebarLangText.textContent = lang === 'zh-CN' ? 'EN' : 'ä¸­';
      }
    }

    // åˆå§‹åŒ–ä¸»é¢˜å’Œè¯­è¨€
    function initThemeAndLanguage() {
      // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
      const savedTheme = localStorage.getItem('rai_theme') || 'dark';
      setTheme(savedTheme);

      // åŠ è½½ä¿å­˜çš„è¯­è¨€
      const savedLanguage = localStorage.getItem('rai_language') || 'zh-CN';
      setLanguage(savedLanguage);

      // åˆå§‹åŒ–PCä¾§è¾¹æ æŒ‰é’®çŠ¶æ€
      const sidebarThemeIcon = document.getElementById('sidebarThemeIcon');
      if (sidebarThemeIcon) {
        const newIconName = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';
        sidebarThemeIcon.outerHTML = getSvgIcon(newIconName, 'material-symbols-outlined', 24).replace('<svg', '<svg id="sidebarThemeIcon"');
      }

      const sidebarLangText = document.getElementById('sidebarLangText');
      if (sidebarLangText) {
        sidebarLangText.textContent = savedLanguage === 'zh-CN' ? 'EN' : 'ä¸­';
      }
    }

    // ==================== ä¾§è¾¹æ åˆ†ç»„æŠ˜å åŠŸèƒ½ ====================
    function toggleGroup(groupName) {
      const group = document.getElementById(groupName + 'Group');
      const icon = document.getElementById(groupName + 'Toggle');

      if (!group || !icon) return;

      const isCollapsed = group.classList.contains('collapsed');

      if (isCollapsed) {
        group.classList.remove('collapsed');
        icon.classList.remove('collapsed');
      } else {
        group.classList.add('collapsed');
        icon.classList.add('collapsed');
      }
    }

    // ==================== æœç´¢å¯¹è¯åŠŸèƒ½ ====================
    function handleSearch(query) {
      const sessionItems = document.querySelectorAll('.session-item');
      const searchQuery = query.toLowerCase().trim();

      sessionItems.forEach(item => {
        const title = item.querySelector('.session-title');
        const preview = item.querySelector('.session-preview');

        if (!title) return;

        const titleText = title.textContent.toLowerCase();
        const previewText = preview ? preview.textContent.toLowerCase() : '';

        if (searchQuery === '' || titleText.includes(searchQuery) || previewText.includes(searchQuery)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    // ==================== è¾“å…¥æ¡†å±•å¼€/æ”¶ç¼©äº¤äº’ ====================
    function expandInput() {
      if (appState.inputExpanded) return;

      const container = document.getElementById('inputContainer');
      const toolbar = container.querySelector('.input-toolbar');

      if (!container) return;

      container.classList.remove('collapsed');
      appState.inputExpanded = true;

      // åŠ¨ç”»ç»“æŸåè®¾ç½®overflow: visibleï¼Œä»¥ä¾¿æ˜¾ç¤ºä¸‹æ‹‰èœå•
      setTimeout(() => {
        if (appState.inputExpanded && toolbar) {
          toolbar.classList.add('overflow-visible');
        }
      }, 500); // ä¸CSS transitionæ—¶é—´åŒ¹é…
    }

    function collapseInput() {
      if (!appState.inputExpanded) return;

      const container = document.getElementById('inputContainer');
      const input = document.getElementById('messageInput');
      const toolbar = container.querySelector('.input-toolbar');

      if (!container) return;

      // å¦‚æœè¾“å…¥æ¡†æœ‰å†…å®¹æˆ–æ­£åœ¨æµå¼ç”Ÿæˆï¼Œä¸æ”¶ç¼©
      if (input && (input.value.trim() !== '' || appState.isStreaming)) {
        return;
      }

      // ç«‹å³éšè—overflowï¼Œé˜²æ­¢å†…å®¹æº¢å‡º
      if (toolbar) {
        toolbar.classList.remove('overflow-visible');
      }

      container.classList.add('collapsed');
      appState.inputExpanded = false;
    }

    function handleInputContainerClick(event) {
      // ç‚¹å‡»è¾“å…¥å®¹å™¨æ—¶å±•å¼€
      const target = event.target;

      // å¦‚æœç‚¹å‡»çš„æ˜¯å·¥å…·æ æŒ‰é’®æˆ–ä¸‹æ‹‰èœå•ï¼Œä¸å¤„ç†
      if (target.closest('.toolbar-btn') ||
        target.closest('.model-dropdown') ||
        target.closest('.thinking-budget-modal')) {
        return;
      }

      expandInput();

      // ç‚¹å‡»å®¹å™¨æ—¶ï¼Œå¦‚æœè¾“å…¥æ¡†æœªèšç„¦ï¼Œå¼ºåˆ¶èšç„¦
      // è§£å†³ Android "ç‚¹ä¸€ä¸‹å±•å¼€ï¼Œå†ç‚¹ä¸€ä¸‹è¾“å…¥" çš„é—®é¢˜
      const input = document.getElementById('messageInput');
      if (input && document.activeElement !== input) {
        // ç¨å¾®å»¶è¿Ÿä»¥ç­‰å¾…å±•å¼€åŠ¨ç”»å¼€å§‹
        setTimeout(() => input.focus(), 10);
      }
    }

    function handleActionCard(action) {
      const input = document.getElementById('messageInput');
      if (!input) return;

      let text = '';
      switch (action) {
        case 'write':
          text = 'å¸®æˆ‘å†™ä¸€ç¯‡æ–‡ç« ï¼š';
          break;
        case 'search':
          text = 'æœç´¢ï¼š';
          if (!appState.internetMode) toggleInternet();
          break;
        case 'code':
          text = 'å¸®æˆ‘å†™ä»£ç ï¼š';
          break;
        case 'translate':
          text = 'ç¿»è¯‘ï¼š';
          break;
      }

      input.value = text;
      input.focus();
      expandInput();
    }

    function autoResizeInput() {
      const input = document.getElementById('messageInput');
      if (!input) return;

      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    }

    function handleInputKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('âœ… RAI v0.5 åˆå§‹åŒ–');

      // ç»‘å®šè¾“å…¥å®¹å™¨ç‚¹å‡»äº‹ä»¶
      const inputContainer = document.getElementById('inputContainer');
      if (inputContainer) {
        inputContainer.addEventListener('click', handleInputContainerClick);
      }

      // åˆå§‹åŒ–ä¸»é¢˜å’Œè¯­è¨€
      initThemeAndLanguage();

      const token = localStorage.getItem('rai_token');
      if (token) {
        appState.token = token;
        verifyToken();
      }

      loadSettings();
      updateModelControls();
      initSwipeGestures();

      // ä¿®å¤ï¼šæ”¹è¿›model dropdownçš„ç‚¹å‡»å¤–å…³é—­é€»è¾‘
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('modelDropdown');
        const customSelect = document.getElementById('modelSelectCustom');

        if (dropdown && customSelect) {
          if (!customSelect.contains(e.target) && !dropdown.contains(e.target)) {
            closeModelDropdown();
          }
        }

        // ä¿®å¤ï¼šæ”¹è¿›thinking budget modalçš„ç‚¹å‡»å¤–å…³é—­é€»è¾‘
        const budgetModal = document.getElementById('thinkingBudgetModal');
        const expandBtn = document.getElementById('thinkingExpandBtn');

        if (budgetModal && expandBtn) {
          if (!budgetModal.contains(e.target) && !expandBtn.contains(e.target)) {
            appState.thinkingBudgetOpen = false;
            budgetModal.style.display = 'none';
            const icon = expandBtn.querySelector('.material-symbols-outlined');
            if (icon) {
              icon.textContent = 'expand_less';
            }
          }
        }

        // è¾“å…¥æ¡†æ”¶ç¼©é€»è¾‘ï¼šç‚¹å‡»ç©ºç™½åŒºåŸŸæ—¶æ”¶ç¼©
        const inputContainer = document.getElementById('inputContainer');
        const inputArea = document.querySelector('.input-area');

        if (inputContainer && inputArea) {
          // æ£€æŸ¥ç‚¹å‡»æ˜¯å¦åœ¨è¾“å…¥åŒºåŸŸä¹‹å¤–
          if (!inputArea.contains(e.target)) {
            collapseInput();
          }
        }
      });
    });

    // ==================== è‡ªå®šä¹‰æ¨¡å‹é€‰æ‹©å™¨ ====================
    function toggleModelDropdown() {
      const dropdown = document.getElementById('modelDropdown');
      const customSelect = document.getElementById('modelSelectCustom');

      if (!dropdown || !customSelect) {
        console.error('âŒ æ¨¡å‹é€‰æ‹©å™¨å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      const isOpen = dropdown.classList.contains('open');

      if (isOpen) {
        closeModelDropdown();
      } else {
        dropdown.classList.add('open');
        customSelect.classList.add('open');
      }
    }

    function closeModelDropdown() {
      const dropdown = document.getElementById('modelDropdown');
      const customSelect = document.getElementById('modelSelectCustom');

      if (dropdown) {
        dropdown.classList.remove('open');
      }

      if (customSelect) {
        customSelect.classList.remove('open');
      }
    }

    // ==================== å·¥å…·æ åŠŸèƒ½ ====================
    function toggleInternet() {
      appState.internetMode = !appState.internetMode;
      updateToolbarUI();
    }

    function toggleThinking() {
      appState.thinkingMode = !appState.thinkingMode;
      updateToolbarUI();
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.click();
      }
    }

    function handleFileSelected(event) {
      const files = event.target.files;
      if (files && files.length > 0) {
        console.log('æ–‡ä»¶é€‰æ‹©:', files[0].name);
        // è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡ä»¶ä¸Šä¼ é€»è¾‘
      }
    }

    function updateToolbarUI() {
      const internetBtn = document.getElementById('internetBtn');
      const thinkingBtn = document.getElementById('thinkingBtn');

      if (internetBtn) {
        if (appState.internetMode) {
          internetBtn.classList.add('active');
        } else {
          internetBtn.classList.remove('active');
        }
      }

      if (thinkingBtn) {
        if (appState.thinkingMode) {
          thinkingBtn.classList.add('active');
        } else {
          thinkingBtn.classList.remove('active');
        }
      }
    }

    function updateModelControls() {
      // æ ¹æ®é€‰æ‹©çš„æ¨¡å‹æ˜¾ç¤º/éšè—æ¨ç†æ§ä»¶
      const thinkingControls = document.getElementById('thinkingControls');
      const selectedModel = appState.selectedModel;

      if (thinkingControls) {
        // DeepSeekæ¨¡å‹æ”¯æŒæ¨ç†æ¨¡å¼
        if (selectedModel === 'deepseek-v3' || selectedModel === 'deepseek-v3.2-speciale') {
          thinkingControls.style.display = 'flex';

          // DeepSeek-V3.2-Speciale å¼ºåˆ¶å¼€å¯æ€è€ƒæ¨¡å¼(åªæ”¯æŒæ€è€ƒæ¨¡å¼)
          if (selectedModel === 'deepseek-v3.2-speciale') {
            appState.thinkingMode = true;  // å¼ºåˆ¶å¼€å¯
          }
        } else {
          thinkingControls.style.display = 'none';
        }
      }

      // æ›´æ–°å·¥å…·æ UIçŠ¶æ€
      updateToolbarUI();
    }

    // ä¿®å¤ï¼šæ”¹è¿›toggleThinkingBudgetå‡½æ•°
    function toggleThinkingBudget() {
      appState.thinkingBudgetOpen = !appState.thinkingBudgetOpen;

      const modal = document.getElementById('thinkingBudgetModal');
      const expandBtn = document.getElementById('thinkingExpandBtn');

      if (!modal || !expandBtn) {
        console.warn('âš ï¸ æ€è€ƒé¢„ç®—æ¨¡æ€æ¡†å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      const icon = expandBtn.querySelector('.material-symbols-outlined');

      if (appState.thinkingBudgetOpen) {
        modal.style.display = 'block';
        if (icon) icon.outerHTML = getSvgIcon('expand_more', 'material-symbols-outlined', 24);
      } else {
        modal.style.display = 'none';
        if (icon) icon.outerHTML = getSvgIcon('expand_less', 'material-symbols-outlined', 24);
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›updateThinkingBudgetå‡½æ•°
    function updateThinkingBudget(value) {
      const numValue = parseInt(value);
      if (!isNaN(numValue)) {
        appState.thinkingBudget = numValue;

        const valueEl = document.getElementById('thinkingBudgetValue');
        if (valueEl) {
          valueEl.textContent = `${value} tokens`;
        }
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›updateToolbarUIå‡½æ•°
    function updateToolbarUI() {
      const thinkingBtn = document.getElementById('thinkingBtn');
      const internetBtn = document.getElementById('internetBtn');

      if (thinkingBtn) {
        if (appState.thinkingMode) {
          thinkingBtn.classList.add('active');
        } else {
          thinkingBtn.classList.remove('active');
        }
      }

      if (internetBtn) {
        if (appState.internetMode) {
          internetBtn.classList.add('active');
        } else {
          internetBtn.classList.remove('active');
        }
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›updateSliderValueå‡½æ•°
    function updateSliderValue(name, value) {
      const spanMap = {
        'temperature': 'temperatureValue',
        'topP': 'topPValue',
        'maxTokens': 'maxTokensValue',
        'frequency': 'frequencyValue',
        'presence': 'presenceValue'
      };

      const spanId = spanMap[name];
      if (spanId) {
        const element = document.getElementById(spanId);
        if (element) {
          element.textContent = value;
        }
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›updateSettingsUIå‡½æ•°ï¼Œæ·»åŠ nullæ£€æŸ¥
    function updateSettingsUI() {
      const elements = [
        { id: 'temperatureSlider', valueId: 'temperatureValue', value: appState.temperature, format: 1 },
        { id: 'topPSlider', valueId: 'topPValue', value: appState.topP, format: 2 },
        { id: 'maxTokensSlider', valueId: 'maxTokensValue', value: appState.maxTokens, format: 0 },
        { id: 'frequencySlider', valueId: 'frequencyValue', value: appState.frequencyPenalty, format: 1 },
        { id: 'presenceSlider', valueId: 'presenceValue', value: appState.presencePenalty, format: 1 }
      ];

      elements.forEach(({ id, valueId, value, format }) => {
        const slider = document.getElementById(id);
        const valueEl = document.getElementById(valueId);

        if (slider) slider.value = value;
        if (valueEl) {
          valueEl.textContent = format === 0 ? value : value.toFixed(format);
        }
      });

      const systemPromptEl = document.getElementById('systemPrompt');
      if (systemPromptEl) {
        systemPromptEl.value = appState.systemPrompt;
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›updateModelControlså‡½æ•°ï¼Œæ·»åŠ nullæ£€æŸ¥
    function updateModelControls() {
      const model = MODELS[appState.selectedModel];

      if (!model) {
        console.warn(`âš ï¸ æœªæ‰¾åˆ°æ¨¡å‹é…ç½®: ${appState.selectedModel}`);
        return;
      }

      const thinkingControls = document.getElementById('thinkingControls');
      const thinkingExpandBtn = document.getElementById('thinkingExpandBtn');

      if (thinkingControls) {
        if (model.supportsThinking) {
          thinkingControls.style.display = 'flex';
        } else {
          thinkingControls.style.display = 'none';
          appState.thinkingMode = false;
          appState.thinkingBudgetOpen = false;
        }
      }

      if (thinkingExpandBtn) {
        if (appState.thinkingMode) {
          thinkingExpandBtn.style.display = 'flex';
        } else {
          thinkingExpandBtn.style.display = 'none';
          appState.thinkingBudgetOpen = false;
          const budgetModal = document.getElementById('thinkingBudgetModal');
          if (budgetModal) {
            budgetModal.style.display = 'none';
          }
        }
      }

      updateToolbarUI();
    }

    // ä¿®å¤ï¼šæ”¹è¿›toggleThinkingå‡½æ•°
    function toggleThinking() {
      const model = MODELS[appState.selectedModel];

      if (!model || !model.supportsThinking) {
        console.warn('âš ï¸ å½“å‰æ¨¡å‹ä¸æ”¯æŒæ€è€ƒæ¨¡å¼');
        return;
      }

      appState.thinkingMode = !appState.thinkingMode;
      updateModelControls();
      updateToolbarUI();
    }

    // ä¿®å¤ï¼šæ”¹è¿›toggleInternetå‡½æ•°
    function toggleInternet() {
      appState.internetMode = !appState.internetMode;
      updateToolbarUI();
    }

    // ==================== æ–°ç‰ˆæ€è€ƒUIå‡½æ•° ====================

    // è§£ææ€è€ƒå†…å®¹ï¼Œæå–ä»¥"-"å¼€å¤´çš„å¥å­
    function parseThinkingContent(rawContent) {
      if (!rawContent) return [];

      // åŒ¹é…ä»¥ "- " å¼€å¤´çš„è¡Œ
      const lines = rawContent.split('\n');
      const sentences = [];

      for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed.startsWith('- ')) {
          // ç§»é™¤å¼€å¤´çš„ "- "
          const sentence = trimmed.substring(2).trim();
          if (sentence) {
            sentences.push(sentence);
          }
        }
      }

      return sentences;
    }

    // ç®€æ´æ¨¡å¼å¥å­è½®æ’­
    function startSentenceRotation(thinkingId, sentences) {
      if (!sentences || sentences.length === 0) return;
      if (appState.thinkingUIMode !== 'collapsed') return;

      // ä¿®å¤é€‰æ‹©å™¨ï¼šåœ¨thinking-indicatorå†…æŸ¥æ‰¾sentence-display
      const thinkingIndicator = document.getElementById(thinkingId)?.closest('.thinking-indicator');
      const sentenceDisplay = thinkingIndicator?.querySelector('.sentence-display');

      if (!sentenceDisplay) {
        console.warn('sentence-displayå…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      let currentIndex = 0;

      function showNextSentence() {
        if (appState.thinkingUIMode !== 'collapsed') return;

        // æ¯æ¬¡é‡æ–°è®¡ç®—éšæœºé—´éš”ï¼š1.8-2.8ç§’
        const DISPLAY_DURATION = 1800 + Math.random() * 1000;

        const sentence = sentences[currentIndex];
        sentenceDisplay.textContent = sentence;
        sentenceDisplay.classList.add('visible'); // ç§»é™¤thinking-animationç±»

        currentIndex = (currentIndex + 1) % sentences.length;

        // æ·¡å‡ºåŠ¨ç”»
        setTimeout(() => {
          sentenceDisplay.classList.remove('visible');
        }, DISPLAY_DURATION - 300);

        // è®¾ç½®ä¸‹ä¸€ä¸ªå¥å­
        appState.sentenceRotationTimer = setTimeout(showNextSentence, DISPLAY_DURATION);
      }

      showNextSentence();
    }

    // åœæ­¢å¥å­è½®æ’­
    function stopSentenceRotation() {
      if (appState.sentenceRotationTimer) {
        clearTimeout(appState.sentenceRotationTimer);
        appState.sentenceRotationTimer = null;
      }

      // éšè—æ‰€æœ‰å¥å­æ˜¾ç¤ºå…ƒç´ 
      document.querySelectorAll('.sentence-display').forEach(el => {
        el.classList.remove('visible', 'thinking-animation');
      });
    }

    // åˆ‡æ¢æ€è€ƒUIæ¨¡å¼ï¼ˆç®€æ´/å±•å¼€ï¼‰
    function toggleThinkingUIMode(thinkingId) {
      const thinkingContent = document.getElementById(thinkingId);
      const icon = document.getElementById(thinkingId + '-icon');
      const toggleText = document.querySelector(`[data-thinking-id="${thinkingId}"] .thinking-toggle-text`);

      if (!thinkingContent) return;

      const isExpanding = !thinkingContent.classList.contains('expanded');

      if (isExpanding) {
        // åˆ‡æ¢åˆ°å±•å¼€æ¨¡å¼
        appState.thinkingUIMode = 'expanded';
        thinkingContent.classList.add('expanded');
        if (icon) icon.classList.add('expanded');
        if (toggleText) {
          toggleText.style.display = 'inline'; // æ˜¾ç¤ºæŒ‰é’®æ–‡å­—
          toggleText.textContent = appState.language === 'zh-CN' ? 'æ”¶èµ·æ€è·¯' : 'Hide Thinking';
        }

        // åœæ­¢è½®æ’­ï¼Œæ˜¾ç¤ºç«–çº¿
        stopSentenceRotation();
        updateThinkingLine(thinkingId);

        // å¯åŠ¨å®æ—¶æ›´æ–°å®šæ—¶å™¨ (0.1såˆ·æ–°ä¸€æ¬¡)
        if (appState.thinkingLineInterval) clearInterval(appState.thinkingLineInterval);
        appState.thinkingLineInterval = setInterval(() => updateThinkingLine(thinkingId), 100);
      } else {
        // åˆ‡æ¢åˆ°ç®€æ´æ¨¡å¼
        appState.thinkingUIMode = 'collapsed';
        thinkingContent.classList.remove('expanded');
        if (icon) icon.classList.remove('expanded');
        if (toggleText) {
          toggleText.style.display = 'none'; // éšè—æŒ‰é’®æ–‡å­—
        }

        // åœæ­¢å®æ—¶æ›´æ–°å®šæ—¶å™¨
        if (appState.thinkingLineInterval) {
          clearInterval(appState.thinkingLineInterval);
          appState.thinkingLineInterval = null;
        }

        // éšè—ç«–çº¿
        updateThinkingLine(thinkingId);

        // å¦‚æœè¿˜åœ¨æ€è€ƒï¼Œæ¢å¤è½®æ’­
        const sentences = parseThinkingContent(thinkingContent.textContent);
        if (sentences.length > 0) {
          startSentenceRotation(thinkingId, sentences);
        }
      }
    }

    // æ›´æ–°ç«–çº¿é•¿åº¦ - æ§åˆ¶AIå¤´åƒä¸‹æ–¹çš„ç«–çº¿
    function updateThinkingLine(thinkingId) {
      const thinkingContent = document.getElementById(thinkingId);
      if (!thinkingContent) return;

      // æ‰¾åˆ°å¯¹åº”çš„messageå®¹å™¨å’Œavatar
      const messageDiv = thinkingContent.closest('.message.assistant');
      const avatar = messageDiv ? messageDiv.querySelector('.message-avatar') : null;

      if (!avatar) return;

      // ç®€æ´æ¨¡å¼æˆ–æ”¶èµ·çŠ¶æ€ï¼Œå®Œå…¨éšè—ç«–çº¿
      if (appState.thinkingUIMode !== 'expanded' || !thinkingContent.classList.contains('expanded')) {
        avatar.style.setProperty('--thinking-line-height', '0px');
        return;
      }

      // å±•å¼€æ¨¡å¼ï¼šè®¡ç®—å®é™…å†…å®¹é«˜åº¦
      // ä½¿ç”¨æ›´é•¿çš„å»¶è¿Ÿç¡®ä¿å†…å®¹å®Œå…¨æ¸²æŸ“
      const updateHeight = () => {
        if (thinkingContent.classList.contains('expanded')) {
          const contentHeight = thinkingContent.scrollHeight;
          avatar.style.setProperty('--thinking-line-height', `${contentHeight}px`);
        }
      };

      // ç«‹å³æ›´æ–°ä¸€æ¬¡
      updateHeight();

      // å»¶è¿Ÿå†æ›´æ–°ä¸€æ¬¡ï¼Œç¡®ä¿åŠ¨æ€å†…å®¹ä¹Ÿè¢«è®¡ç®—
      setTimeout(updateHeight, 300);
    }

    // å¼€å§‹æ€è€ƒåŠ¨ç”»
    function startThinkingAnimation(avatarElement, thinkingId, sentences) {
      if (!avatarElement) return;

      // æ·»åŠ å…‰æ™•åŠ¨ç”»ï¼Œéšæœºå‘¨æœŸ
      const glowDuration = 1.2 + Math.random() * 0.3; // 1.2-1.5s
      avatarElement.style.animationDuration = `${glowDuration}s`;
      avatarElement.classList.add('thinking');

      // æ ¹æ®æ¨¡å¼å¯åŠ¨å¯¹åº”æ˜¾ç¤º
      if (appState.thinkingUIMode === 'collapsed' && sentences && sentences.length > 0) {
        startSentenceRotation(thinkingId, sentences);
      } else if (appState.thinkingUIMode === 'expanded') {
        updateThinkingLine(thinkingId);
      }
    }

    // åœæ­¢æ€è€ƒåŠ¨ç”»
    function stopThinkingAnimation(avatarElement, thinkingId) {
      if (!avatarElement) return;

      avatarElement.classList.remove('thinking');
      stopSentenceRotation();

      // åœæ­¢å®æ—¶æ›´æ–°å®šæ—¶å™¨
      if (appState.thinkingLineInterval) {
        clearInterval(appState.thinkingLineInterval);
        appState.thinkingLineInterval = null;
      }

      // éšè—ç«–çº¿
      const thinkingContent = document.getElementById(thinkingId);
      if (thinkingContent) {
        const messageDiv = thinkingContent.closest('.message.assistant');
        const avatar = messageDiv ? messageDiv.querySelector('.message-avatar') : null;
        if (avatar) {
          avatar.style.setProperty('--thinking-line-height', '0px');
        }
      }
    }


    // ==================== æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰èœå•å‡½æ•° ====================
    function openModelModal() {
      const menu = document.getElementById('modelDropdownMenu');
      if (menu) {
        menu.classList.toggle('active');
        if (menu.classList.contains('active')) {
          updateMenuSelection();
        }
      }
    }

    function closeModelModal() {
      const menu = document.getElementById('modelDropdownMenu');
      if (menu) {
        menu.classList.remove('active');
      }
    }

    function toggleAllModels() {
      const section = document.getElementById('allModelsSection');
      const toggleItem = document.querySelector('[data-toggle="all-models"]');

      if (section && toggleItem) {
        if (section.style.display === 'none') {
          section.style.display = 'block';
          toggleItem.classList.add('expanded');
        } else {
          section.style.display = 'none';
          toggleItem.classList.remove('expanded');
        }
      }
    }

    function updateMenuSelection() {
      const items = document.querySelectorAll('.model-menu-item');
      items.forEach(item => {
        const modelValue = item.getAttribute('data-model');
        if (modelValue === appState.selectedModel) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function selectModelFromMenu(model, displayName) {
      appState.selectedModel = model;
      const selectedText = document.getElementById('selectedModelText');
      if (selectedText) {
        selectedText.textContent = displayName;
      }

      updateModelControls();
      closeModelModal();

      console.log(`âœ… å·²åˆ‡æ¢æ¨¡å‹: ${model} (${displayName})`);
    }

    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰èœå•
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('modelDropdownMenu');
      const selector = document.getElementById('modelSelectCustom');

      if (menu && selector) {
        if (!menu.contains(e.target) && !selector.contains(e.target)) {
          menu.classList.remove('active');
        }
      }
    });

    // ==================== è®¾ç½®ç›¸å…³ ====================
    function toggleAdvancedOptions() {
      const content = document.getElementById('advancedOptionsContent');
      const header = document.querySelector('.advanced-options-header');

      if (content && header) {
        content.classList.toggle('expanded');
        header.classList.toggle('expanded');
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›openSettingså‡½æ•°
    function openSettings() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.classList.add('active');
        appState.settingsOpen = true;
        updateSettingsUI();
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›closeSettingså‡½æ•°
    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.classList.remove('active');
        appState.settingsOpen = false;
      }
    }

    // ç‚¹å‡»ç©ºç™½å¤„å…³é—­è®¾ç½®
    document.addEventListener('click', (e) => {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal && e.target === settingsModal) {
        closeSettings();
      }
    });

    // ç§»åŠ¨ç«¯é”®ç›˜é€‚é… - æœ€ç®€å•ä¿å®ˆæ–¹æ¡ˆ
    // åªå¤„ç†iOSçš„æ»šåŠ¨é—®é¢˜ï¼Œè®©Androidä½¿ç”¨é»˜è®¤è¡Œä¸º
    if (window.visualViewport) {
      window.visualViewport.addEventListener('scroll', () => {
        // é˜²æ­¢iOSæ©¡çš®ç­‹æ•ˆæœ
        window.scrollTo(0, 0);
      });
    }

    function scrollToBottom() {
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›saveSettingså‡½æ•°ï¼Œæ·»åŠ nullæ£€æŸ¥
    function saveSettings() {
      const temperatureSlider = document.getElementById('temperatureSlider');
      const topPSlider = document.getElementById('topPSlider');
      const maxTokensSlider = document.getElementById('maxTokensSlider');
      const frequencySlider = document.getElementById('frequencySlider');
      const presenceSlider = document.getElementById('presenceSlider');
      const systemPromptEl = document.getElementById('systemPrompt');

      if (!temperatureSlider || !topPSlider || !maxTokensSlider) {
        console.error('âŒ è®¾ç½®è¡¨å•å…ƒç´ æœªæ‰¾åˆ°');
        return;
      }

      const temperature = parseFloat(temperatureSlider.value);
      const topP = parseFloat(topPSlider.value);
      const maxTokens = parseInt(maxTokensSlider.value, 10);
      const frequencyPenalty = parseFloat(frequencySlider?.value || 0);
      const presencePenalty = parseFloat(presenceSlider?.value || 0);
      // âœ… ä¿®å¤ï¼šç¡®ä¿systemPromptæ­£ç¡®è¯»å–å’Œå¤„ç†ï¼Œå¤„ç†ç©ºå­—ç¬¦ä¸²å’Œnull
      const systemPrompt = (systemPromptEl?.value || '').trim();

      if (isNaN(temperature) || isNaN(topP) || isNaN(maxTokens)) {
        console.error('âŒ å‚æ•°å€¼æ— æ•ˆ');
        return;
      }

      appState.temperature = temperature;
      appState.topP = topP;
      appState.maxTokens = maxTokens;
      appState.frequencyPenalty = frequencyPenalty;
      appState.presencePenalty = presencePenalty;
      appState.systemPrompt = systemPrompt;  // âœ… ä¿å­˜trimmedç‰ˆæœ¬

      const settings = {
        temperature,
        topP,
        maxTokens,
        frequencyPenalty,
        presencePenalty,
        systemPrompt
      };
      localStorage.setItem('rai_settings', JSON.stringify(settings));

      // âœ… ä¿®å¤ï¼šåŒæ­¥ä¿å­˜åˆ°åç«¯æ•°æ®åº“
      if (appState.token) {
        console.log(`ğŸ“¤ æ­£åœ¨å°†è®¾ç½®åŒæ­¥åˆ°äº‘ç«¯...`);
        console.log(`   ç³»ç»Ÿæç¤ºè¯é•¿åº¦: ${systemPrompt.length}å­—ç¬¦`);

        fetch(`${API_BASE}/user/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            theme: appState.theme,
            default_model: appState.selectedModel,
            temperature,
            top_p: topP,
            max_tokens: maxTokens,
            frequency_penalty: frequencyPenalty,
            presence_penalty: presencePenalty,
            system_prompt: systemPrompt,  // âœ… ç¡®ä¿å‘é€æ­£ç¡®çš„å€¼
            thinking_mode: appState.thinkingMode ? 1 : 0,
            internet_mode: appState.internetMode ? 1 : 0
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log('âœ… äº‘ç«¯é…ç½®å·²åŒæ­¥');
            } else {
              console.warn('âš ï¸ äº‘ç«¯åŒæ­¥å¤±è´¥:', data.error);
            }
          })
          .catch(err => console.error('âŒ ä¿å­˜é…ç½®ç½‘ç»œé”™è¯¯:', err));
      }

      console.log('âœ… è®¾ç½®å·²ä¿å­˜æœ¬åœ°å¹¶åŒæ­¥äº‘ç«¯');

      closeSettings();
    }

    // ä¿®å¤äº‹ä»¶å¤„ç†å™¨ä¸­inline onclickå¤„ç†å’Œäº‹ä»¶å§”æ‰˜é—®é¢˜ï¼Œé¿å…undefinedå¼•ç”¨

    // ä¿®å¤ï¼šæ”¹è¿›renderMessagesï¼Œé˜²æ­¢äº‹ä»¶å¤„ç†ä¸­çš„undefinedé”™è¯¯
    function renderMessages() {
      const container = document.getElementById('messagesList');
      const welcome = document.getElementById('welcomeScreen');

      if (!container || !welcome) {
        console.error('âŒ æ¶ˆæ¯å®¹å™¨æˆ–æ¬¢è¿å±å¹•æœªæ‰¾åˆ°');
        return;
      }

      if (appState.messages.length === 0) {
        showWelcome();
        return;
      }

      welcome.classList.add('hidden');
      welcome.style.display = 'none';
      container.style.display = 'block';
      container.innerHTML = '';

      appState.messages.forEach(msg => {
        const messageDiv = createMessageElement(msg);
        if (messageDiv) {
          container.appendChild(messageDiv);
        }
      });

      scrollToBottom();
    }

    // ä¿®å¤ï¼šæ”¹è¿›createMessageElementï¼Œæ·»åŠ å®‰å…¨çš„äº‹ä»¶å¤„ç†
    function createMessageElement(message) {
      if (!message || !message.role) {
        console.warn('âš ï¸ æ— æ•ˆçš„æ¶ˆæ¯å¯¹è±¡');
        return null;
      }

      const div = document.createElement('div');
      div.className = `message ${message.role}`;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';

      if (message.role === 'user') {
        const name = appState.user?.username || appState.user?.email || 'U';
        avatar.textContent = name ? name[0].toUpperCase() : 'U';
      } else {
        avatar.innerHTML = getSvgIcon('rai_logo_colored', 'material-symbols-outlined ai-avatar', 24);
      }
      div.appendChild(avatar);

      const content = document.createElement('div');
      content.className = 'message-content';

      if (message.reasoning_content && message.reasoning_content !== 'null' && message.reasoning_content.trim() !== '') {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'thinking-indicator';

        const thinkingId = `thinking-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        const toggleText = '';

        const thinkingLabel_el = document.createElement('div');
        thinkingLabel_el.className = 'thinking-label';
        thinkingLabel_el.setAttribute('data-thinking-id', thinkingId);
        thinkingLabel_el.innerHTML = `
          <div class="thinking-label-left">
            <span class="thinking-toggle-text" style="display: none;">${toggleText}</span>
          </div>
          ${getSvgIcon('expand_more', 'material-symbols-outlined thinking-expand-icon', 18).replace('<svg', `<svg id="${thinkingId}-icon"`)}
        `;

        // ä½¿ç”¨æ–°çš„toggleThinkingUIModeå‡½æ•°
        thinkingLabel_el.addEventListener('click', function () {
          const id = this.getAttribute('data-thinking-id');
          toggleThinkingUIMode(id);
        });

        const thinkingContent = document.createElement('div');
        thinkingContent.className = 'thinking-content';
        thinkingContent.id = thinkingId;

        // å°†æ€è€ƒå†…å®¹æŒ‰å¥å­åˆ†å‰²æ˜¾ç¤ºï¼ˆå¦‚æœåŒ…å«å¥å·ï¼‰
        const sentences = message.reasoning_content.match(/[^.ã€‚!ï¼?ï¼Ÿ]+[.ã€‚!ï¼?ï¼Ÿ]+/g);
        if (sentences && sentences.length > 0) {
          sentences.forEach(sentence => {
            const sentenceSpan = document.createElement('span');
            sentenceSpan.className = 'thinking-sentence';
            // è¯†åˆ«**æ–‡æœ¬**æ ¼å¼å¹¶è½¬æ¢ä¸º<strong>æ ‡ç­¾
            const formattedText = sentence.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            sentenceSpan.innerHTML = formattedText;
            thinkingContent.appendChild(sentenceSpan);
          });

          // å¦‚æœæœ‰å‰©ä½™å†…å®¹ï¼ˆæ²¡æœ‰å¥å·ç»“å°¾çš„éƒ¨åˆ†ï¼‰ï¼Œä¹Ÿæ·»åŠ è¿›å»
          const remainingText = message.reasoning_content.slice(sentences.join('').length);
          if (remainingText.trim()) {
            const sentenceSpan = document.createElement('span');
            sentenceSpan.className = 'thinking-sentence';
            // è¯†åˆ«**æ–‡æœ¬**æ ¼å¼å¹¶è½¬æ¢ä¸º<strong>æ ‡ç­¾
            const formattedText = remainingText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            sentenceSpan.innerHTML = formattedText;
            thinkingContent.appendChild(sentenceSpan);
          }
        } else {
          // å¦‚æœæ²¡æœ‰å¥å·åˆ†éš”ç¬¦ï¼Œå°±ç›´æ¥æ˜¾ç¤ºå…¨éƒ¨å†…å®¹ï¼Œè¯†åˆ«**æ–‡æœ¬**æ ¼å¼
          const formattedText = message.reasoning_content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          thinkingContent.innerHTML = formattedText;
        }

        thinkingDiv.appendChild(thinkingLabel_el);

        // æ³¨æ„ï¼šä¸è¦åœ¨å†å²æ¶ˆæ¯ä¸­æ·»åŠ sentence-displayå…ƒç´ 
        // sentence-displayåªç”¨äºå®æ—¶æ€è€ƒæ—¶çš„ç®€æ´æ¨¡å¼é¢„è§ˆ

        thinkingDiv.appendChild(thinkingContent);
        content.appendChild(thinkingDiv);
      }

      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';
      // ä½¿ç”¨renderMarkdownWithMathæ¸²æŸ“Markdownå’Œæ•°å­¦å…¬å¼
      textDiv.innerHTML = renderMarkdownWithMath(message.content || '');
      content.appendChild(textDiv);

      // ä¸ºAIæ¶ˆæ¯æ·»åŠ å…ƒä¿¡æ¯å’Œå¤åˆ¶æŒ‰é’®
      if (message.role === 'assistant') {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'message-meta';

        // æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
        if (message.model) {
          const modelBadge = document.createElement('span');
          modelBadge.className = 'meta-badge';

          // è·å–æ¨¡å‹æ˜¾ç¤ºåç§°
          let modelName = message.model;
          if (MODELS[message.model]) {
            modelName = MODELS[message.model].name;
          }

          modelBadge.innerHTML = `
            ${getSvgIcon('smart_toy', 'material-symbols-outlined', 24)}
            <span>${modelName}</span>
          `;
          metaDiv.appendChild(modelBadge);
        }

        // æ˜¾ç¤ºè”ç½‘çŠ¶æ€
        // å¢å¼ºåˆ¤æ–­é€»è¾‘ï¼šæ£€æŸ¥ enable_search æˆ– internet_modeï¼Œå¹¶å¤„ç†å¯èƒ½çš„ç±»å‹å·®å¼‚ï¼ˆæ•°å­—/å¸ƒå°”å€¼ï¼‰
        const isInternet = (message.enable_search === 1 || message.enable_search === true) ||
          (message.internet_mode === 1 || message.internet_mode === true);

        if (isInternet) {
          const internetBadge = document.createElement('span');
          internetBadge.className = 'meta-badge';
          internetBadge.innerHTML = `
            ${getSvgIcon('language', 'material-symbols-outlined', 24)}
            <span>${appState.language === 'zh-CN' ? 'è”ç½‘' : 'Web'}</span>
          `;
          metaDiv.appendChild(internetBadge);
        }

        // æ˜¾ç¤ºæ€è€ƒçŠ¶æ€
        if (message.reasoning_content && message.reasoning_content !== 'null' && message.reasoning_content.trim() !== '') {
          const thinkingBadge = document.createElement('span');
          thinkingBadge.className = 'meta-badge';
          thinkingBadge.innerHTML = `
            ${getSvgIcon('psychology', 'material-symbols-outlined', 24)}
            <span>${appState.language === 'zh-CN' ? 'æ€è€ƒ' : 'Thinking'}</span>
          `;
          metaDiv.appendChild(thinkingBadge);
        }

        // æ·»åŠ å¤åˆ¶æŒ‰é’®
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.title = appState.language === 'zh-CN' ? 'å¤åˆ¶æ¶ˆæ¯' : 'Copy message';
        copyBtn.innerHTML = `
          ${getSvgIcon('content_copy', 'material-symbols-outlined', 24)}
        `;

        // å¤åˆ¶æŒ‰é’®äº‹ä»¶
        copyBtn.addEventListener('click', async function () {
          const textToCopy = message.content || '';

          try {
            // ä¼˜å…ˆä½¿ç”¨ç°ä»£API
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(textToCopy);
              console.log('âœ… å¤åˆ¶æˆåŠŸ');
            } else {
              // å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
              const textarea = document.createElement('textarea');
              textarea.value = textToCopy;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              console.log('âœ… å¤åˆ¶æˆåŠŸï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰');
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            copyBtn.classList.add('copied');
            copyBtn.innerHTML = `
              ${getSvgIcon('check', 'material-symbols-outlined', 24)}
            `;

            setTimeout(() => {
              copyBtn.classList.remove('copied');
              copyBtn.innerHTML = `
                ${getSvgIcon('content_copy', 'material-symbols-outlined', 24)}
              `;
            }, 2000);
          } catch (err) {
            console.error('âŒ å¤åˆ¶å¤±è´¥:', err);
            alert(appState.language === 'zh-CN' ? 'å¤åˆ¶å¤±è´¥' : 'Copy failed');
          }
        });

        metaDiv.appendChild(copyBtn);
        content.appendChild(metaDiv);
      }

      div.appendChild(content);

      return div;
    }

    // ä¿®å¤ï¼šæ”¹è¿›openSidebarå‡½æ•°
    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      if (sidebar) {
        sidebar.classList.add('active');
        sidebar.style.transform = '';
      }

      if (overlay) {
        overlay.classList.add('active');
      }

      appState.sidebarOpen = true;
    }

    // ä¿®å¤ï¼šæ”¹è¿›closeSidebarå‡½æ•°
    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      if (sidebar) {
        sidebar.classList.remove('active');
        sidebar.style.transform = '';
      }

      if (overlay) {
        overlay.classList.remove('active');
      }

      appState.sidebarOpen = false;
    }

    // ä¿®å¤ï¼šæ”¹è¿›toggleSidebarå‡½æ•°
    function toggleSidebar() {
      if (appState.sidebarOpen) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›deleteSessionå‡½æ•°
    async function deleteSession(event, sessionId) {
      if (!event) {
        console.warn('âš ï¸ äº‹ä»¶å¯¹è±¡æœªä¼ é€’');
        return;
      }

      event.stopPropagation();

      const confirmMsg = appState.language === 'zh-CN' ? 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—?' : 'Delete this conversation?';
      if (!confirm(confirmMsg)) return;

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        if (appState.currentSession?.id === sessionId) {
          appState.currentSession = null;
          appState.messages = [];
          showWelcome();
        }

        await loadSessions();
      } catch (error) {
        console.error('âŒ åˆ é™¤ä¼šè¯å¤±è´¥:', error);
        alert(appState.language === 'zh-CN' ? 'åˆ é™¤å¤±è´¥' : 'Delete failed');
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›renderSessionsï¼Œä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†åˆ é™¤æŒ‰é’®
    function renderSessions() {
      const container = document.getElementById('sessionsContainer');

      if (!container) {
        console.error('âŒ æ‰¾ä¸åˆ°ä¼šè¯å®¹å™¨');
        return;
      }

      container.innerHTML = '';

      if (!appState.sessions || appState.sessions.length === 0) {
        const msg = appState.language === 'zh-CN'
          ? 'æš‚æ— å†å²å¯¹è¯<br>ç‚¹å‡»"æ–°å¯¹è¯"å¼€å§‹èŠå¤©'
          : 'No conversations<br>Click "New Chat" to start';
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 13px;">${msg}</div>`;
        return;
      }

      appState.sessions.forEach(session => {
        const div = document.createElement('div');
        div.className = `session-item ${session.id === appState.currentSession?.id ? 'active' : ''}`;
        div.setAttribute('data-session-id', session.id);

        div.innerHTML = `
          <div class="session-title">${escapeHtml(session.title || '')}</div>
          <div class="session-preview">${escapeHtml((session.last_message || '').substring(0, 50))}...</div>
          <button class="session-delete-btn" type="button">
            ${getSvgIcon('close', 'material-symbols-outlined', 24)}
          </button>
        `;

        // ä¸»é¡¹ç›®ç‚¹å‡»åŠ è½½ä¼šè¯
        div.addEventListener('click', function (e) {
          if (!e.target.closest('.session-delete-btn')) {
            const sid = this.getAttribute('data-session-id');
            if (sid) loadSession(sid);
          }
        });

        // åˆ é™¤æŒ‰é’®ç‚¹å‡»å¤„ç†
        const deleteBtn = div.querySelector('.session-delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            const sid = div.getAttribute('data-session-id');
            if (sid) deleteSession(e, sid);
          });
        }

        container.appendChild(div);
      });
    }

    // ä¿®å¤ï¼šæ”¹è¿›sendMessageï¼Œæ·»åŠ æ›´å¤šçš„é”™è¯¯å¤„ç†
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      if (!input) {
        console.error('âŒ æ¶ˆæ¯è¾“å…¥æ¡†æœªæ‰¾åˆ°');
        return;
      }

      const message = input.value.trim();

      if (!message || appState.isStreaming) return;

      if (!appState.currentSession) {
        await createNewSession();
        return;
      }

      input.value = '';
      autoResizeInput();

      const userMsg = {
        role: 'user',
        content: message,
        created_at: new Date().toISOString()
      };
      appState.messages.push(userMsg);
      renderMessages();

      const messages = appState.messages.map(m => ({
        role: m.role,
        content: m.content
      }));

      const sendBtn = document.getElementById('sendBtn');
      const stopBtn = document.getElementById('stopBtn');

      if (sendBtn) sendBtn.style.display = 'none';
      if (stopBtn) stopBtn.style.display = 'flex';

      appState.isStreaming = true;

      const aiMsgDiv = document.createElement('div');
      aiMsgDiv.className = 'message assistant';
      const thinkingLabelText = '';

      // æ ¹æ®å½“å‰æ¨¡å¼ç¡®å®šåˆå§‹åŠ è½½çŠ¶æ€æ–‡æœ¬
      const initialStatusText = appState.internetMode
        ? (appState.language === 'zh-CN' ? 'è”ç½‘æœç´¢ä¸­...' : 'Searching...')
        : (appState.thinkingMode
          ? (appState.language === 'zh-CN' ? 'æ¨ç†ä¸­...' : 'Reasoning...')
          : (appState.language === 'zh-CN' ? 'æ€è€ƒä¸­...' : 'Thinking...'));

      aiMsgDiv.innerHTML = `
        <div class="message-avatar">
          ${getSvgIcon('rai_logo_colored', 'material-symbols-outlined ai-avatar processing', 24)}
          <span class="loading-status" id="loadingStatus">
            <svg class="status-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 4V2C6.48 2 2 6.48 2 12h2c0-4.41 3.59-8 8-8z"/>
            </svg>
            <span id="loadingStatusText">${initialStatusText}</span>
          </span>
        </div>
        <div class="message-content">
          <div class="thinking-indicator" id="thinkingIndicator" style="display: none;">
            <div class="thinking-label" data-thinking-id="thinkingContent">
              <div class="thinking-label-left">
                <span class="thinking-toggle-text" id="thinkingTitleText" style="display: none;">${thinkingLabelText}</span>
              </div>
              ${getSvgIcon('expand_more', 'material-symbols-outlined thinking-expand-icon', 18).replace('<svg', '<svg id="thinkingContent-icon"')}
            </div>
            <div class="sentence-display" data-thinking-id="thinkingContent"></div>
            <div class="thinking-content" id="thinkingContent"></div>
          </div>
          <div class="message-text" id="streamingContent"></div>
        </div>
      `;

      const messagesList = document.getElementById('messagesList');
      if (messagesList) {
        messagesList.appendChild(aiMsgDiv);
      }

      // æ·»åŠ æ€è€ƒæŠ˜å åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬å™¨
      const thinkingLabel = aiMsgDiv.querySelector('.thinking-label');
      if (thinkingLabel) {
        thinkingLabel.addEventListener('click', function () {
          const id = this.getAttribute('data-thinking-id');
          toggleThinkingUIMode(id);
        });
      }

      scrollToBottom();

      let fullContent = '';
      let reasoningContent = '';
      let thinkingSentences = [];
      let isThinkingPhase = false;

      try {
        const response = await fetch(`${API_BASE}/chat/stream`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId: appState.currentSession.id,
            messages: messages,
            model: appState.selectedModel,
            thinkingMode: appState.thinkingMode,
            thinkingBudget: appState.thinkingBudget,
            internetMode: appState.internetMode,
            temperature: appState.temperature,
            top_p: appState.topP,
            max_tokens: appState.maxTokens,
            frequency_penalty: appState.frequencyPenalty,
            presence_penalty: appState.presencePenalty,
            systemPrompt: appState.systemPrompt.trim()
              ? `${BUILT_IN_SYSTEM_PROMPT}\n\nä»¥ä¸‹æ˜¯ç”¨æˆ·ä¸ªäººåå¥½ï¼Œè¯·å‚è€ƒï¼š\n${appState.systemPrompt}`
              : BUILT_IN_SYSTEM_PROMPT,
            // RAGå‚æ•°
            spaceId: appState.currentSpaceId,
            useRag: appState.useRag,
            ragTopK: appState.ragTopK
          })
        });

        const modelUsed = response.headers.get('X-Model-Used');
        const routingReason = response.headers.get('X-Model-Reason');

        if (modelUsed) {
          appState.lastModelUsed = modelUsed;
          appState.lastRoutingReason = routingReason || '';
          console.log(`âœ… å®é™…ä½¿ç”¨æ¨¡å‹: ${modelUsed}`);
          console.log(`   é€‰æ‹©åŸå› : ${appState.lastRoutingReason}`);

          if (appState.selectedModel === 'auto') {
            showModelRoutingInfo(modelUsed, appState.lastRoutingReason);
          }
        }

        appState.currentRequestId = response.headers.get('X-Request-ID');

        if (!response.body) {
          throw new Error('å“åº”ä½“ä¸ºç©º');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        const streamingEl = document.getElementById('streamingContent');
        const thinkingEl = document.getElementById('thinkingContent');
        const thinkingIndicator = document.getElementById('thinkingIndicator');
        const aiAvatar = aiMsgDiv.querySelector('.ai-avatar');

        // ç”¨äºé€å¥æ˜¾ç¤ºæ€è€ƒå†…å®¹ - è¯†åˆ«**æ–‡æœ¬**æ ¼å¼
        function appendThinkingSentence(sentence) {
          if (!thinkingEl || !sentence.trim()) return;

          const sentenceSpan = document.createElement('span');
          sentenceSpan.className = 'thinking-sentence';
          // è¯†åˆ«**æ–‡æœ¬**æ ¼å¼å¹¶è½¬æ¢ä¸º<strong>æ ‡ç­¾
          const formattedText = sentence.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          sentenceSpan.innerHTML = formattedText;
          thinkingEl.appendChild(sentenceSpan);
          scrollToBottom();
        }

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed || !trimmed.startsWith('data: ')) continue;

            const data = trimmed.slice(6);
            if (data === '[DONE]') continue;

            try {
              const parsed = JSON.parse(data);

              if (parsed.type === 'reasoning') {
                // è¿›å…¥æ€è€ƒé˜¶æ®µ
                if (!isThinkingPhase) {
                  isThinkingPhase = true;

                  // æ›´æ–°åŠ è½½çŠ¶æ€æ–‡æœ¬ä¸ºæ¨ç†ä¸­
                  const loadingStatusText = document.getElementById('loadingStatusText');
                  if (loadingStatusText) {
                    loadingStatusText.textContent = appState.language === 'zh-CN' ? 'æ¨ç†ä¸­...' : 'Reasoning...';
                  }

                  // æ˜¾ç¤ºæ€è€ƒåŒºåŸŸ
                  if (thinkingIndicator) thinkingIndicator.style.display = 'block';

                  // æ·»åŠ AIå¤´åƒé—ªçƒæ•ˆæœ
                  if (aiAvatar) {
                    aiAvatar.classList.add('thinking');
                    aiAvatar.classList.remove('processing');  // åœæ­¢ç¼“åŠ¨
                  }

                  // éšè—åŠ è½½çŠ¶æ€æç¤º
                  const loadingStatus = document.getElementById('loadingStatus');
                  if (loadingStatus) loadingStatus.style.display = 'none';
                }

                reasoningContent += parsed.content;

                // å¦‚æœæ˜¯å±•å¼€æ¨¡å¼ï¼ŒæŒç»­æ›´æ–°ç«–çº¿é«˜åº¦
                if (appState.thinkingUIMode === 'expanded') {
                  updateThinkingLine('thinkingContent');
                }

                // è§£æå½“å‰çš„æ€è€ƒå†…å®¹ï¼Œæå–ä»¥ "- " å¼€å¤´çš„å¥å­
                const currentSentences = parseThinkingContent(reasoningContent);

                // å¦‚æœæ˜¯ç®€æ´æ¨¡å¼ï¼Œæ›´æ–°è½®æ’­
                if (appState.thinkingUIMode === 'collapsed' && currentSentences.length > 0) {
                  // åœæ­¢æ—§çš„è½®æ’­
                  stopSentenceRotation();
                  // å¯åŠ¨æ–°çš„è½®æ’­
                  startSentenceRotation('thinkingContent', currentSentences);
                }

                // æ£€æµ‹å¥å·ï¼ˆä¸­è‹±æ–‡ï¼‰ï¼Œé€å¥æ˜¾ç¤º
                const sentenceRegex = /[^.ã€‚!ï¼?ï¼Ÿ]+[.ã€‚!ï¼?ï¼Ÿ]+/g;
                const matches = reasoningContent.match(sentenceRegex);

                if (matches) {
                  const newSentences = matches.slice(thinkingSentences.length);
                  newSentences.forEach(sentence => {
                    appendThinkingSentence(sentence);
                    thinkingSentences.push(sentence);
                  });

                  // åŠ¨æ€æ›´æ–°æ ‡é¢˜ï¼šæ˜¾ç¤ºæœ€æ–°çš„ä¸€å¥
                  if (matches.length > 0) {
                    const latestSentence = matches[matches.length - 1].trim();
                    const thinkingTitleEl = document.getElementById('thinkingTitleText');
                    if (thinkingTitleEl && latestSentence && appState.thinkingUIMode !== 'collapsed') {
                      // æˆªæ–­è¿‡é•¿çš„å¥å­
                      const maxLength = 50;
                      const displayText = latestSentence.length > maxLength
                        ? latestSentence.substring(0, maxLength) + '...'
                        : latestSentence;
                      thinkingTitleEl.textContent = displayText;
                    }
                  }

                  // ç§»é™¤å·²æ˜¾ç¤ºçš„å¥å­ï¼Œä¿ç•™æœªå®Œæˆçš„éƒ¨åˆ†
                  const displayedText = thinkingSentences.join('');
                  reasoningContent = reasoningContent.slice(displayedText.length);
                }
              }
              else if (parsed.type === 'content') {
                // éšè—åŠ è½½çŠ¶æ€æç¤ºï¼ˆé¦–æ¬¡æ”¶åˆ°å†…å®¹æ—¶ï¼‰
                if (!isThinkingPhase) {
                  const loadingStatus = document.getElementById('loadingStatus');
                  if (loadingStatus) loadingStatus.style.display = 'none';
                  if (aiAvatar) aiAvatar.classList.remove('processing');
                }

                // æ€è€ƒé˜¶æ®µç»“æŸ
                if (isThinkingPhase) {
                  isThinkingPhase = false;

                  // æ˜¾ç¤ºå‰©ä½™çš„æ€è€ƒå†…å®¹
                  if (reasoningContent.trim()) {
                    appendThinkingSentence(reasoningContent);
                  }

                  // åœæ­¢AIå¤´åƒé—ªçƒ
                  if (aiAvatar) aiAvatar.classList.remove('thinking');

                  // æ›´æ–°æ ‡é¢˜ä¸ºå®ŒæˆçŠ¶æ€
                  const thinkingTitleEl = document.getElementById('thinkingTitleText');
                  if (thinkingTitleEl) {
                    if (appState.thinkingUIMode === 'collapsed') {
                      // ç®€æ´æ¨¡å¼ï¼šä¿æŒæ˜¾ç¤ºâ€œæ˜¾ç¤ºæ€è·¯â†“â€
                      thinkingTitleEl.textContent = appState.language === 'zh-CN'
                        ? 'æ˜¾ç¤ºæ€è·¯ â†“'
                        : 'Show Thinking â†“';
                    } else {
                      // å±•å¼€æ¨¡å¼ï¼šæ˜¾ç¤ºå®ŒæˆçŠ¶æ€
                      thinkingTitleEl.textContent = appState.language === 'zh-CN'
                        ? 'å·²æ€è€ƒ'
                        : 'Thinking completed';
                    }
                  }

                  // æœ€åæ›´æ–°ä¸€æ¬¡ç«–çº¿é«˜åº¦
                  if (appState.thinkingUIMode === 'expanded') {
                    setTimeout(() => updateThinkingLine('thinkingContent'), 500);
                  }
                }

                // ç°åœ¨å¼€å§‹æ˜¾ç¤ºæ­£æ–‡
                fullContent += parsed.content;
                if (streamingEl) {
                  const contentToDisplay = fullContent.split('[TITLE]')[0].trim();
                  // ä½¿ç”¨renderMarkdownWithMathæ¸²æŸ“Markdownå’Œæ•°å­¦å…¬å¼ï¼ˆä¸€æ­¥å®Œæˆï¼‰
                  streamingEl.innerHTML = renderMarkdownWithMath(contentToDisplay);
                }
                scrollToBottom();
              }
              else if (parsed.type === 'title') {
                // å¤„ç†æ ‡é¢˜æ›´æ–°
                if (parsed.title && appState.currentSession) {
                  appState.currentSession.title = parsed.title;
                  console.log(`âœ… ä¼šè¯æ ‡é¢˜å·²æ›´æ–°: "${parsed.title}"`);
                  loadSessions().catch(err => console.error('åˆ·æ–°ä¼šè¯åˆ—è¡¨å¤±è´¥:', err));
                }
              }
              else if (parsed.type === 'done') {
                console.log('âœ… æµå¼å“åº”å®Œæˆ');
                // åœæ­¢AIå¤´åƒé—ªçƒ
                if (aiAvatar) aiAvatar.classList.remove('thinking');
              }
              else if (parsed.type === 'cancelled') {
                console.log('âš ï¸ å“åº”å·²å–æ¶ˆ');
                // åœæ­¢AIå¤´åƒé—ªçƒ
                if (aiAvatar) aiAvatar.classList.remove('thinking');
                break;
              }
              else if (parsed.type === 'error') {
                // åœæ­¢AIå¤´åƒé—ªçƒ
                if (aiAvatar) aiAvatar.classList.remove('thinking');
                alert((appState.language === 'zh-CN' ? 'AIæœåŠ¡é”™è¯¯: ' : 'AI Service Error: ') + (parsed.error || 'æœªçŸ¥é”™è¯¯'));
                break;
              }
            } catch (e) {
              console.error('âš ï¸ è§£æå“åº”é”™è¯¯:', e);
            }
          }
        }

        // ç¡®ä¿åœæ­¢AIå¤´åƒé—ªçƒ
        if (aiAvatar) aiAvatar.classList.remove('thinking');

        // åˆå¹¶æ‰€æœ‰æ€è€ƒå¥å­
        const finalReasoningContent = thinkingSentences.join('') + reasoningContent.trim();

        // ç§»é™¤æ ‡é¢˜æ ‡è®°åå†ä¿å­˜åˆ°appState
        const cleanContent = fullContent.replace(/\[TITLE\].*?\[\/TITLE\]/g, '').trim();

        const aiMsg = {
          role: 'assistant',
          content: cleanContent,
          reasoning_content: finalReasoningContent || null,
          model: appState.lastModelUsed || appState.selectedModel,
          enable_search: appState.internetMode,
          internet_mode: appState.internetMode,
          created_at: new Date().toISOString()
        };
        appState.messages.push(aiMsg);

        // é‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯ä»¥æ˜¾ç¤ºå…ƒä¿¡æ¯å’Œå¤åˆ¶æŒ‰é’®
        renderMessages();

        await loadSessions();

      } catch (error) {
        console.error('âŒ å‘é€æ¶ˆæ¯é”™è¯¯:', error);
        alert(appState.language === 'zh-CN' ? 'å‘é€å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥' : 'Send failed, check network');
        // ç¡®ä¿åœæ­¢AIå¤´åƒé—ªçƒ
        const aiAvatar = document.querySelector('.message.assistant:last-child .ai-avatar');
        if (aiAvatar) aiAvatar.classList.remove('thinking');
      } finally {
        if (sendBtn) sendBtn.style.display = 'flex';
        if (stopBtn) stopBtn.style.display = 'none';
        appState.isStreaming = false;
        appState.currentRequestId = null;

        // é‡ç½®è”ç½‘æ¨¡å¼ä¸ºå¼€å¯çŠ¶æ€ï¼ˆç”¨æˆ·å…³é—­ä»…é™æœ¬æ¬¡ï¼‰
        appState.internetMode = true;
        updateToolbarUI();

        // ä¿®å¤ï¼šåœ¨æµå¼ä¼ è¾“ç»“æŸåå¤„ç†æ ‡é¢˜
        // æå–æ ‡é¢˜ [TITLE]...[/TITLE]
        const titleMatch = fullContent.match(/\[TITLE\](.*?)\[\/TITLE\]/);
        if (titleMatch && titleMatch[1]) {
          const newTitle = titleMatch[1].trim();
          console.log(`ğŸ“ æ£€æµ‹åˆ°æ–°æ ‡é¢˜: "${newTitle}"`);

          if (appState.currentSession) {
            // 1. æ›´æ–°æœ¬åœ°çŠ¶æ€
            appState.currentSession.title = newTitle;

            // 2. æ›´æ–°æœåŠ¡å™¨
            fetch(`${API_BASE}/sessions/${appState.currentSession.id}`, {
              method: 'PUT',
              headers: {
                'Authorization': `Bearer ${appState.token}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ title: newTitle })
            }).then(() => {
              console.log('âœ… æ ‡é¢˜å·²åŒæ­¥åˆ°æœåŠ¡å™¨');
              // 3. åˆ·æ–°ä¾§è¾¹æ 
              loadSessions();
            }).catch(err => console.error('âŒ åŒæ­¥æ ‡é¢˜å¤±è´¥:', err));
          }
        }
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›stopGenerationå‡½æ•°
    async function stopGeneration() {
      if (!appState.currentRequestId) {
        console.warn('âš ï¸ æ²¡æœ‰æ´»è·ƒçš„è¯·æ±‚');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/chat/stop`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            requestId: appState.currentRequestId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        console.log('ğŸ›‘ å·²å‘é€åœæ­¢è¯·æ±‚');
      } catch (error) {
        console.error('âŒ åœæ­¢å¤±è´¥:', error);
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›handleInputKeydown
    function handleInputKeydown(event) {
      if (!event) return;

      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // ä¿®å¤ï¼šæ”¹è¿›autoResizeInput
    function autoResizeInput() {
      const input = document.getElementById('messageInput');
      if (!input) return;

      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    }

    // æ˜¾ç¤ºæŒ‰é’®æ‚¬æµ®æç¤º
    function showButtonTooltip(buttonElement, tooltipText) {
      if (!buttonElement) return;

      const buttonRect = buttonElement.getBoundingClientRect();
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip-popup';
      tooltip.textContent = tooltipText;

      // å®šä½åœ¨æŒ‰é’®ä¸Šæ–¹
      document.body.appendChild(tooltip);
      const tooltipRect = tooltip.getBoundingClientRect();
      tooltip.style.left = `${buttonRect.left + (buttonRect.width - tooltipRect.width) / 2}px`;
      tooltip.style.top = `${buttonRect.top - tooltipRect.height - 8}px`;

      // 1ç§’åè‡ªåŠ¨ç§»é™¤
      setTimeout(() => {
        if (tooltip.parentNode) {
          tooltip.parentNode.removeChild(tooltip);
        }
      }, 1000);
    }

    // ä¿®å¤ï¼šæ”¹è¿›handleFileUploadï¼Œæ·»åŠ æ‚¬æµ®æç¤º
    function handleFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const attachBtn = document.getElementById('attachBtn');
      if (!fileInput) {
        console.error('âŒ æ–‡ä»¶è¾“å…¥æ¡†æœªæ‰¾åˆ°');
        return;
      }

      // æ˜¾ç¤ºæç¤º
      const tooltipText = appState.language === 'zh-CN' ? 'é™„ä»¶' : 'Attach';
      showButtonTooltip(attachBtn, tooltipText);

      // æ¸…é™¤ä¹‹å‰çš„å€¼ï¼Œç¡®ä¿å¯ä»¥é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
      fileInput.value = '';
      fileInput.click();
    }

    // åˆ‡æ¢è”ç½‘æ¨¡å¼
    function toggleInternet() {
      appState.internetMode = !appState.internetMode;
      updateToolbarUI();

      const internetBtn = document.getElementById('internetBtn');
      const tooltipText = appState.language === 'zh-CN' ? 'è”ç½‘' : 'Internet';
      showButtonTooltip(internetBtn, tooltipText);

      console.log(`ğŸŒ è”ç½‘æ¨¡å¼: ${appState.internetMode ? 'å¼€å¯' : 'å…³é—­'}`);
    }

    // åˆ‡æ¢æ¨ç†æ¨¡å¼
    function toggleThinking() {
      const modelConfig = MODELS[appState.selectedModel];
      if (!modelConfig || !modelConfig.supportsThinking) {
        const msg = appState.language === 'zh-CN'
          ? 'å½“å‰æ¨¡å‹ä¸æ”¯æŒæ¨ç†æ¨¡å¼'
          : 'Current model does not support thinking mode';
        alert(msg);
        return;
      }

      appState.thinkingMode = !appState.thinkingMode;
      updateToolbarUI();

      const thinkingBtn = document.getElementById('thinkingBtn');
      const tooltipText = appState.language === 'zh-CN' ? 'æ¨ç†' : 'Reasoning';
      showButtonTooltip(thinkingBtn, tooltipText);

      console.log(`ğŸ§  æ¨ç†æ¨¡å¼: ${appState.thinkingMode ? 'å¼€å¯' : 'å…³é—­'}`);
    }

    // ä¿®å¤ï¼šæ”¹è¿›handleFileSelected - æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†
    function handleFileSelected(event) {
      if (!event || !event.target) {
        console.error('âŒ äº‹ä»¶å¯¹è±¡æ— æ•ˆ');
        return;
      }

      const files = event.target.files;
      if (!files || files.length === 0) {
        console.warn('âš ï¸ æœªé€‰æ‹©æ–‡ä»¶');
        return;
      }

      const file = files[0];
      console.log(`âœ… é€‰ä¸­æ–‡ä»¶: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

      // æ–‡ä»¶ç±»å‹éªŒè¯
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'text/plain'];
      if (!allowedTypes.includes(file.type)) {
        const msg = appState.language === 'zh-CN'
          ? `ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${file.type}\næ”¯æŒçš„ç±»å‹: å›¾ç‰‡(JPG, PNG, GIF, WebP), PDF, æ–‡æœ¬æ–‡ä»¶`
          : `Unsupported file type: ${file.type}\nSupported: Images (JPG, PNG, GIF, WebP), PDF, Text`;
        alert(msg);
        return;
      }

      // æ–‡ä»¶å¤§å°éªŒè¯ (æœ€å¤§10MB)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        const msg = appState.language === 'zh-CN'
          ? `æ–‡ä»¶è¿‡å¤§: ${(file.size / 1024 / 1024).toFixed(2)} MB\næœ€å¤§æ”¯æŒ: 10 MB`
          : `File too large: ${(file.size / 1024 / 1024).toFixed(2)} MB\nMax size: 10 MB`;
        alert(msg);
        return;
      }

      // TODO: å®ç°æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„é€»è¾‘
      // è¿™é‡Œåº”è¯¥å°†æ–‡ä»¶ä¸Šä¼ åˆ°åç«¯ï¼Œå¹¶è·å–URLæˆ–ID
      // ç„¶åå¯ä»¥åœ¨å‘é€æ¶ˆæ¯æ—¶é™„åŠ æ–‡ä»¶ä¿¡æ¯
      console.log('ğŸ“ æ–‡ä»¶å·²å‡†å¤‡ï¼Œç­‰å¾…ä¸Šä¼ å®ç°');

      // ä¸´æ—¶æç¤ºç”¨æˆ·
      const msg = appState.language === 'zh-CN'
        ? `æ–‡ä»¶ "${file.name}" å·²é€‰æ‹©\næ³¨æ„: æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å°šæœªå®Œå…¨å®ç°`
        : `File "${file.name}" selected\nNote: File upload not fully implemented yet`;
      alert(msg);
    }

    // ä¿®å¤ï¼šæ”¹è¿›showModelRoutingInfo
    function showModelRoutingInfo(modelUsed, reason) {
      console.log(`ğŸ¤– [Autoè·¯ç”±] ä½¿ç”¨æ¨¡å‹: ${modelUsed}, åŸå› : ${reason}`);
    }

    // ä¿®å¤ï¼šæ”¹è¿›handleViewportResize
    function handleViewportResize() {
      // å¤„ç†viewportå˜åŒ–æ—¶çš„å¸ƒå±€è°ƒæ•´
      console.log('ğŸ“± Viewportå·²è°ƒæ•´å¤§å°');
    }

    // ==================== è®¤è¯ç›¸å…³ ====================
    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const errorEl = document.getElementById('loginError');

      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="loading"></span> ' + (appState.language === 'zh-CN' ? 'ç™»å½•ä¸­...' : 'Logging in...');
      errorEl.classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.success) {
          appState.token = data.token;
          appState.user = data.user;
          localStorage.setItem('rai_token', data.token);

          showApp();
          await loadUserData();
        } else {
          showError(errorEl, data.error || (appState.language === 'zh-CN' ? 'ç™»å½•å¤±è´¥' : 'Login failed'));
        }
      } catch (error) {
        showError(errorEl, appState.language === 'zh-CN' ? 'ç½‘ç»œé”™è¯¯,è¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥' : 'Network error');
        console.error('âŒ ç™»å½•é”™è¯¯:', error);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = appState.language === 'zh-CN' ? 'ç™»å½•' : 'Login';
      }
    }

    async function handleRegister(event) {
      event.preventDefault();

      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const username = document.getElementById('registerUsername').value;
      const registerBtn = document.getElementById('registerBtn');
      const errorEl = document.getElementById('registerError');

      registerBtn.disabled = true;
      registerBtn.innerHTML = '<span class="loading"></span> ' + (appState.language === 'zh-CN' ? 'æ³¨å†Œä¸­...' : 'Registering...');
      errorEl.classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, username })
        });

        const data = await response.json();

        if (data.success) {
          appState.token = data.token;
          appState.user = data.user;
          localStorage.setItem('rai_token', data.token);

          showApp();
          await loadUserData();
        } else {
          showError(errorEl, data.error || (appState.language === 'zh-CN' ? 'æ³¨å†Œå¤±è´¥' : 'Registration failed'));
        }
      } catch (error) {
        showError(errorEl, appState.language === 'zh-CN' ? 'ç½‘ç»œé”™è¯¯,è¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥' : 'Network error');
        console.error('âŒ æ³¨å†Œé”™è¯¯:', error);
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = appState.language === 'zh-CN' ? 'æ³¨å†Œ' : 'Register';
      }
    }

    async function verifyToken() {
      try {
        const response = await fetch(`${API_BASE}/auth/verify`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        const data = await response.json();

        if (data.success) {
          appState.user = data.user;
          showApp();
          await loadUserData();
        } else {
          localStorage.removeItem('rai_token');
          appState.token = null;
        }
      } catch (error) {
        console.error('âŒ éªŒè¯tokenå¤±è´¥:', error);
        localStorage.removeItem('rai_token');
        appState.token = null;
      }
    }

    function handleLogout() {
      const confirmMsg = appState.language === 'zh-CN' ? 'ç¡®å®šè¦é€€å‡ºç™»å½•å—?' : 'Are you sure you want to logout?';
      if (confirm(confirmMsg)) {
        localStorage.removeItem('rai_token');
        appState.token = null;
        appState.user = null;
        appState.sessions = [];
        appState.currentSession = null;

        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('authContainer').classList.add('active');
      }
    }

    function switchToRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loginError').classList.remove('show');
    }

    function switchToLogin() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerError').classList.remove('show');
    }

    function showApp() {
      document.getElementById('authContainer').classList.remove('active');
      document.getElementById('appContainer').style.display = 'flex';
    }

    function showError(element, message) {
      element.textContent = message;
      element.classList.add('show');
    }

    async function loadUserData() {
      try {
        console.log('ğŸ“¥ åŠ è½½ç”¨æˆ·æ•°æ®...');

        const profileResponse = await fetch(`${API_BASE}/user/profile`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!profileResponse.ok) {
          throw new Error(`HTTP ${profileResponse.status}`);
        }

        const profile = await profileResponse.json();

        const realEmail = appState.user?.email || profile.email || '';
        const displayName = appState.user?.username || profile.username || (realEmail ? realEmail.split('@')[0] : 'ç”¨æˆ·');

        console.log('ğŸ“§ æ˜¾ç¤ºé‚®ç®±:', realEmail);

        document.getElementById('userName').textContent = displayName;
        document.getElementById('userEmail').textContent = realEmail;
        document.getElementById('userAvatar').textContent = realEmail ? realEmail[0].toUpperCase() : 'U';

        appState.user = {
          username: displayName,
          email: realEmail
        };

        // âœ… ä¿®å¤ï¼šæ£€æŸ¥profileå¯¹è±¡çš„æ‰€æœ‰å¿…éœ€å­—æ®µ
        if (profile && typeof profile === 'object') {
          if (profile.temperature !== undefined) appState.temperature = parseFloat(profile.temperature) || 0.7;
          if (profile.top_p !== undefined) appState.topP = parseFloat(profile.top_p) || 0.9;
          if (profile.max_tokens !== undefined) appState.maxTokens = parseInt(profile.max_tokens, 10) || 2000;
          if (profile.frequency_penalty !== undefined) appState.frequencyPenalty = parseFloat(profile.frequency_penalty) || 0;
          if (profile.presence_penalty !== undefined) appState.presencePenalty = parseFloat(profile.presence_penalty) || 0;
          // âœ… å…³é”®ä¿®å¤ï¼šæ­£ç¡®å¤„ç†system_promptï¼Œç¡®ä¿å§‹ç»ˆæ˜¯å­—ç¬¦ä¸²
          if (profile.system_prompt !== undefined) {
            appState.systemPrompt = (profile.system_prompt || '');
            console.log(`âœ… åŠ è½½ç³»ç»Ÿæç¤ºè¯: ${appState.systemPrompt.length}å­—ç¬¦`);
          }
          if (profile.thinking_mode !== undefined) appState.thinkingMode = profile.thinking_mode === 1 || profile.thinking_mode === true;
          if (profile.internet_mode !== undefined) appState.internetMode = profile.internet_mode === 1 || profile.internet_mode === true;

          updateSettingsUI();
          updateToolbarUI();
          console.log('âœ… ç”¨æˆ·é…ç½®å·²åŠ è½½åˆ°UI');
        } else {
          console.warn('âš ï¸ profileå¯¹è±¡æ ¼å¼ä¸æ­£ç¡®');
        }

        console.log('ğŸ“‹ åŠ è½½å†å²ä¼šè¯...');
        await loadSessions();

        if (appState.sessions && appState.sessions.length > 0) {
          console.log(`âœ… æ‰¾åˆ° ${appState.sessions.length} ä¸ªå†å²ä¼šè¯,è‡ªåŠ¨åŠ è½½æœ€æ–°ä¼šè¯`);
          await loadSession(appState.sessions[0].id);
        } else {
          console.log('â„¹ï¸ æ— å†å²ä¼šè¯,æ˜¾ç¤ºæ¬¢è¿ç•Œé¢');
          showWelcome();
        }

        console.log('âœ… ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        if (error.message.includes('500')) {
          console.warn('âš ï¸ ç”¨æˆ·é…ç½®åŠ è½½å¤±è´¥,ä½¿ç”¨é»˜è®¤é…ç½®ç»§ç»­');
          showWelcome();
        } else {
          alert((appState.language === 'zh-CN' ? 'åŠ è½½å¤±è´¥: ' : 'Load failed: ') + error.message);
        }
      }
    }

    // ==================== RAG åŠŸèƒ½å‡½æ•° ====================

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function switchSidebarTab(tabName) {
      const tabs = document.querySelectorAll('.sidebar-tab');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => tab.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));

      const activeTab = Array.from(tabs).find(tab =>
        tab.onclick.toString().includes(tabName)
      );
      if (activeTab) activeTab.classList.add('active');

      const activeContent = document.getElementById(
        tabName === 'sessions' ? 'sessionsTab' : 'spacesTab'
      );
      if (activeContent) activeContent.classList.add('active');

      // åˆ‡æ¢åˆ°ç©ºé—´æ ‡ç­¾é¡µæ—¶åŠ è½½ç©ºé—´åˆ—è¡¨
      if (tabName === 'spaces') {
        loadSpaces();
      }
    }

    // åŠ è½½ç”¨æˆ·ç©ºé—´åˆ—è¡¨
    async function loadSpaces() {
      try {
        const response = await fetch(`${API_BASE}/spaces`, {
          headers: {
            'Authorization': `Bearer ${appState.token}`
          }
        });

        if (!response.ok) throw new Error('åŠ è½½ç©ºé—´å¤±è´¥');

        const spaces = await response.json();
        appState.spaces = spaces;

        const spacesList = document.getElementById('spacesList');
        if (!spacesList) return;

        if (spaces.length === 0) {
          spacesList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— ç©ºé—´ï¼Œç‚¹å‡»ä¸Šæ–¹åˆ›å»º</div>';
          return;
        }

        spacesList.innerHTML = spaces.map(space => `
          <div class="space-item ${space.id === appState.currentSpaceId ? 'active' : ''}"
               onclick="selectSpace('${space.id}')">
            <div class="space-icon">${space.icon}</div>
            <div class="space-info">
              <div class="space-name">${space.name}</div>
              <div class="space-doc-count">${space.document_count || 0} ä¸ªæ–‡æ¡£</div>
            </div>
            <div class="space-actions" onclick="event.stopPropagation()">
              <button class="space-action-icon delete" onclick="deleteSpace('${space.id}')" title="åˆ é™¤">
                ${getSvgIcon('delete', 'material-symbols-outlined', 24)}
              </button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½ç©ºé—´å¤±è´¥:', error);
      }
    }

    // åˆ›å»ºæ–°ç©ºé—´
    async function createNewSpace() {
      const name = prompt('è¯·è¾“å…¥ç©ºé—´åç§°:');
      if (!name || !name.trim()) return;

      const icon = prompt('è¯·è¾“å…¥å›¾æ ‡ emoji (å¯é€‰):', 'ğŸ“š');

      try {
        const response = await fetch(`${API_BASE}/spaces`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${appState.token}`
          },
          body: JSON.stringify({
            name: name.trim(),
            description: '',
            icon: icon || 'ğŸ“š'
          })
        });

        if (!response.ok) throw new Error('åˆ›å»ºç©ºé—´å¤±è´¥');

        const { space } = await response.json();
        console.log('âœ… ç©ºé—´åˆ›å»ºæˆåŠŸ:', space);

        // é‡æ–°åŠ è½½ç©ºé—´åˆ—è¡¨
        await loadSpaces();
      } catch (error) {
        console.error('åˆ›å»ºç©ºé—´å¤±è´¥:', error);
        alert('åˆ›å»ºç©ºé—´å¤±è´¥: ' + error.message);
      }
    }

    // é€‰æ‹©ç©ºé—´
    async function selectSpace(spaceId) {
      appState.currentSpaceId = spaceId;

      // æ›´æ–°UI
      const spaceItems = document.querySelectorAll('.space-item');
      spaceItems.forEach(item => item.classList.remove('active'));

      const selectedItem = Array.from(spaceItems).find(item =>
        item.onclick.toString().includes(spaceId)
      );
      if (selectedItem) selectedItem.classList.add('active');

      // æ˜¾ç¤ºç©ºé—´è¯¦æƒ…é¢æ¿
      const spaceDetail = document.getElementById('spaceDetail');
      if (spaceDetail) {
        spaceDetail.classList.add('active');
        const space = appState.spaces.find(s => s.id === spaceId);
        if (space) {
          document.getElementById('spaceDetailTitle').textContent = space.name;
        }
      }

      // åŠ è½½æ–‡æ¡£åˆ—è¡¨
      await loadDocuments(spaceId);
    }

    // åŠ è½½æ–‡æ¡£åˆ—è¡¨
    async function loadDocuments(spaceId) {
      try {
        const response = await fetch(`${API_BASE}/spaces/${spaceId}/documents`, {
          headers: {
            'Authorization': `Bearer ${appState.token}`
          }
        });

        if (!response.ok) throw new Error('åŠ è½½æ–‡æ¡£å¤±è´¥');

        const documents = await response.json();

        const documentList = document.getElementById('documentList');
        if (!documentList) return;

        if (documents.length === 0) {
          documentList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">æš‚æ— æ–‡æ¡£</div>';
          return;
        }

        documentList.innerHTML = documents.map(doc => `
          <div class="document-item">
            <div class="document-info">
              <div class="document-name" title="${doc.original_name}">${doc.original_name}</div>
              <div class="document-meta">${formatFileSize(doc.file_size)} â€¢ ${doc.embedding_status === 'completed' ? 'âœ“ å·²ç´¢å¼•' : 'å¤„ç†ä¸­'}</div>
            </div>
            <button class="document-delete" onclick="deleteDocument('${spaceId}', '${doc.id}')" title="åˆ é™¤">
              ${getSvgIcon('delete', 'material-symbols-outlined', 24)}
            </button>
          </div>
        `).join('');
      } catch (error) {
        console.error('åŠ è½½æ–‡æ¡£å¤±è´¥:', error);
      }
    }

    // ä¸Šä¼ æ–‡æ¡£
    function uploadDocument() {
      if (!appState.currentSpaceId) {
        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç©ºé—´');
        return;
      }

      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.pdf,.docx';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        try {
          const response = await fetch(`${API_BASE}/spaces/${appState.currentSpaceId}/upload`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${appState.token}`
            },
            body: formData
          });

          if (!response.ok) throw new Error('ä¸Šä¼ å¤±è´¥');

          const result = await response.json();
          console.log('âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:', result);

          // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨å’Œç©ºé—´åˆ—è¡¨
          await loadDocuments(appState.currentSpaceId);
          await loadSpaces();

          alert(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼\nçŠ¶æ€: ${result.document.embedding_status === 'completed' ? 'å·²ç´¢å¼•' : 'å¤„ç†ä¸­'}`);
        } catch (error) {
          console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
          alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
        }
      };

      input.click();
    }

    // åˆ é™¤æ–‡æ¡£
    async function deleteDocument(spaceId, docId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤æ–‡æ¡£å—ï¼Ÿ')) return;

      try {
        const response = await fetch(`${API_BASE}/spaces/${spaceId}/documents/${docId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${appState.token}`
          }
        });

        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

        console.log('âœ… æ–‡æ¡£åˆ é™¤æˆåŠŸ');

        // é‡æ–°åŠ è½½æ–‡æ¡£åˆ—è¡¨å’Œç©ºé—´åˆ—è¡¨
        await loadDocuments(spaceId);
        await loadSpaces();
      } catch (error) {
        console.error('åˆ é™¤æ–‡æ¡£å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // åˆ é™¤ç©ºé—´
    async function deleteSpace(spaceId) {
      if (!confirm('ç¡®è®¤åˆ é™¤æ­¤ç©ºé—´å—ï¼Ÿç©ºé—´ä¸­çš„æ‰€æœ‰æ–‡æ¡£ä¹Ÿä¼šè¢«åˆ é™¤ï¼')) return;

      try {
        const response = await fetch(`${API_BASE}/spaces/${spaceId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${appState.token}`
          }
        });

        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');

        console.log('âœ… ç©ºé—´åˆ é™¤æˆåŠŸ');

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ç©ºé—´ï¼Œæ¸…ç©ºçŠ¶æ€
        if (appState.currentSpaceId === spaceId) {
          appState.currentSpaceId = null;
          document.getElementById('spaceDetail').classList.remove('active');
        }

        // é‡æ–°åŠ è½½ç©ºé—´åˆ—è¡¨
        await loadSpaces();
      } catch (error) {
        console.error('åˆ é™¤ç©ºé—´å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥: ' + error.message);
      }
    }

    // RAGåŠŸèƒ½åˆ‡æ¢
    function toggleRAG() {
      appState.useRag = !appState.useRag;
      const ragBtn = document.getElementById('ragBtn');
      if (ragBtn) {
        ragBtn.classList.toggle('active');
      }
      console.log('RAGåŠŸèƒ½:', appState.useRag ? 'å·²å¼€å¯' : 'å·²å…³é—­');
    }

    // åœºæ™¯é¢„è®¾åˆ‡æ¢
    async function selectScenario(scenario) {
      appState.currentScenario = scenario;

      // æ›´æ–°UI
      const scenarioBtns = document.querySelectorAll('.scenario-btn');
      scenarioBtns.forEach(btn => btn.classList.remove('active'));

      const selectedBtn = document.getElementById(`scenario-${scenario}`);
      if (selectedBtn) selectedBtn.classList.add('active');

      // è°ƒç”¨æ„å›¾è¯†åˆ«APIè·å–æ¨èå‚æ•°(å¯é€‰)
      // è¿™é‡Œç®€åŒ–å¤„ç†,ç›´æ¥è®¾ç½®é¢„å®šä¹‰çš„å‚æ•°
      const scenarios = {
        divergent: { temperature: 1.3, top_p: 0.95, presence_penalty: 0.6 },
        precise: { temperature: 0.4, top_p: 0.2, presence_penalty: 0 },
        code: { temperature: 0.3, top_p: 0.2, presence_penalty: 0 },
        creative: { temperature: 0.9, top_p: 0.85, presence_penalty: 0.4 },
        balanced: { temperature: 0.7, top_p: 0.9, presence_penalty: 0 }
      };

      const params = scenarios[scenario];
      if (params) {
        appState.temperature = params.temperature;
        appState.topP = params.top_p;
        appState.presencePenalty = params.presence_penalty;
        console.log(`âœ… åˆ‡æ¢åˆ°${scenario}æ¨¡å¼:`, params);
      }
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // ==================== ä¼šè¯ç®¡ç† ====================

    async function loadSessions() {
      try {
        const response = await fetch(`${API_BASE}/sessions`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const sessions = await response.json();
        appState.sessions = Array.isArray(sessions) ? sessions : [];

        console.log(`âœ… æˆåŠŸåŠ è½½ ${appState.sessions.length} ä¸ªä¼šè¯`);
        renderSessions();

      } catch (error) {
        console.error('âŒ åŠ è½½ä¼šè¯å¤±è´¥:', error);
        appState.sessions = [];
        renderSessions();
      }
    }

    function showWelcome() {
      const welcomeScreen = document.getElementById('welcomeScreen');
      const messagesList = document.getElementById('messagesList');

      if (welcomeScreen) {
        welcomeScreen.style.display = 'flex';
        welcomeScreen.classList.remove('hidden');
      }

      if (messagesList) {
        messagesList.style.display = 'none';
      }
    }

    // åˆ«åï¼Œç¡®ä¿å…¼å®¹æ€§
    const renderWelcomeScreen = showWelcome;

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    async function createNewSession() {
      try {
        const response = await fetch(`${API_BASE}/sessions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: appState.language === 'zh-CN' ? 'æ–°å¯¹è¯' : 'New Chat',
            model: appState.selectedModel || 'auto'  // é»˜è®¤ä¸ºautoæˆ–å½“å‰é€‰æ‹©çš„æ¨¡å‹
          })
        });

        const data = await response.json();

        if (data.success) {
          await loadSessions();
          await loadSession(data.sessionId);

          // ç§»é™¤ç§»åŠ¨ç«¯è‡ªåŠ¨å¼¹å‡ºä¾§è¾¹æ 
          // if (window.innerWidth <= 768) {
          //   toggleSidebar();
          // }
        }
      } catch (error) {
        console.error('âŒ åˆ›å»ºä¼šè¯å¤±è´¥:', error);
        alert(appState.language === 'zh-CN' ? 'åˆ›å»ºå¯¹è¯å¤±è´¥' : 'Failed to create chat');
      }
    }

    async function loadSession(sessionId) {
      try {
        console.log('ğŸ“– åŠ è½½ä¼šè¯:', sessionId);

        const response = await fetch(`${API_BASE}/sessions/${sessionId}/messages`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const messages = await response.json();

        appState.currentSession = appState.sessions.find(s => s.id === sessionId);
        appState.messages = Array.isArray(messages) ? messages : [];

        console.log(`âœ… åŠ è½½åˆ° ${messages.length} æ¡æ¶ˆæ¯`);

        renderMessages();
        renderSessions();

        // ç§»é™¤ç§»åŠ¨ç«¯è‡ªåŠ¨å¼¹å‡ºä¾§è¾¹æ 
        // if (window.innerWidth <= 768) {
        //   toggleSidebar();
        // }

      } catch (error) {
        console.error('âŒ åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
        alert(appState.language === 'zh-CN' ? 'åŠ è½½å¯¹è¯å¤±è´¥' : 'Failed to load chat');
      }
    }

    // ==================== ä¾§è¾¹æ æ»‘åŠ¨æ‰‹åŠ¿ ====================
    function initSwipeGestures() {
      const mainContent = document.querySelector('.main-content');
      const sidebar = document.getElementById('sidebar');

      if (!mainContent || !sidebar) return;

      mainContent.addEventListener('touchstart', (e) => {
        appState.touchStartX = e.touches[0].clientX;
        appState.touchStartY = e.touches[0].clientY;
        appState.isSwiping = false;
      }, { passive: true });

      mainContent.addEventListener('touchmove', (e) => {
        if (!appState.touchStartX) return;

        appState.touchMoveX = e.touches[0].clientX;
        const touchMoveY = e.touches[0].clientY;

        const deltaX = appState.touchMoveX - appState.touchStartX;
        const deltaY = Math.abs(touchMoveY - appState.touchStartY);

        if (Math.abs(deltaX) > 30 && Math.abs(deltaX) > deltaY * 2) {
          appState.isSwiping = true;

          if (deltaX > 0 && appState.touchStartX < 50 && !appState.sidebarOpen) {
            const translateX = Math.min(deltaX, sidebar.offsetWidth);
            sidebar.style.transform = `translateX(calc(-100% + ${translateX}px))`;
          }
          else if (deltaX < 0 && appState.sidebarOpen) {
            const translateX = Math.max(deltaX, -sidebar.offsetWidth);
            sidebar.style.transform = `translateX(${translateX}px)`;
          }
        }
      }, { passive: true });

      mainContent.addEventListener('touchend', () => {
        if (!appState.isSwiping) {
          appState.touchStartX = 0;
          return;
        }

        const deltaX = appState.touchMoveX - appState.touchStartX;
        const threshold = sidebar.offsetWidth / 3;

        if (!appState.sidebarOpen && deltaX > threshold) {
          openSidebar();
        } else if (appState.sidebarOpen && deltaX < -threshold) {
          closeSidebar();
        } else {
          sidebar.style.transform = '';
        }

        appState.touchStartX = 0;
        appState.touchMoveX = 0;
        appState.isSwiping = false;
      }, { passive: true });
    }

    function selectModel(value, displayName) {
      appState.selectedModel = value;

      document.getElementById('selectedModelText').textContent = displayName;

      document.querySelectorAll('.model-option').forEach(option => {
        option.classList.remove('selected');
      });

      // ä¿®å¤ï¼šç›´æ¥é€šè¿‡data-valueå±æ€§æŸ¥æ‰¾å¯¹åº”çš„option
      const targetOption = document.querySelector(`.model-option[data-value="${value}"]`);
      if (targetOption) {
        targetOption.classList.add('selected');
      }

      closeModelDropdown();
      updateModelControls();
    }

    // ä¿®å¤ï¼šæ·»åŠ nullæ£€æŸ¥å’Œå®‰å…¨çš„DOMæ“ä½œ
    function toggleThinkingContent(id) {
      if (!id) return;

      const content = document.getElementById(id);
      const icon = document.getElementById(`${id}-icon`);

      if (!content || !icon) {
        console.warn(`âš ï¸ æ‰¾ä¸åˆ°å…ƒç´ : ${id}`);
        return;
      }

      const expanded = content.classList.toggle('expanded');
      const iconName = expanded ? 'expand_less' : 'expand_more';
      icon.outerHTML = getSvgIcon(iconName, 'material-symbols-outlined thinking-expand-icon', 24).replace('<svg', `<svg id="${icon.id}"`);
    }

    function formatMessage(text) {
      // ç®€å•è½¬ä¹‰ä¸æ¢è¡Œå¤„ç†ï¼Œè€ƒè™‘æ’å…¥ä»£ç å—æ¸²æŸ“ç­‰
      if (!text) return '';

      let escaped = text.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      // ä¿ç•™æ¢è¡Œ
      escaped = escaped.replace(/\n/g, '<br>');

      return escaped;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function loadSettings() {
      // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç”¨æˆ·è®¾ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const savedSettings = localStorage.getItem('rai_settings');
      if (savedSettings) {
        try {
          const settings = JSON.parse(savedSettings);
          if (settings.temperature !== undefined) appState.temperature = settings.temperature;
          if (settings.topP !== undefined) appState.topP = settings.topP;
          if (settings.maxTokens !== undefined) appState.maxTokens = settings.maxTokens;
          if (settings.frequencyPenalty !== undefined) appState.frequencyPenalty = settings.frequencyPenalty;
          if (settings.presencePenalty !== undefined) appState.presencePenalty = settings.presencePenalty;
          if (settings.systemPrompt !== undefined) appState.systemPrompt = settings.systemPrompt;
          console.log('âœ… ä»æœ¬åœ°å­˜å‚¨åŠ è½½è®¾ç½®æˆåŠŸ');
        } catch (e) {
          console.warn('âš ï¸ è§£ææœ¬åœ°è®¾ç½®å¤±è´¥:', e);
        }
      }
    }

    // åˆå§‹åŒ–å®Œæ¯•åè°ƒç”¨
    if (document.readyState !== 'loading') {
      updateModelControls();
    } else {
      document.addEventListener('DOMContentLoaded', updateModelControls);
    }

    // ==================== ç§»åŠ¨ç«¯é”®ç›˜å¤„ç†å™¨ (iOS VisualViewport ä¿®å¤ç‰ˆ) ====================
    class MobileKeyboardHandler {
      constructor(options = {}) {
        this.options = {
          scrollThreshold: options.scrollThreshold || 0.85,
          iosDelay: options.iosDelay || 0,
          androidDelay: options.androidDelay || 300,
          debug: options.debug || false,
          ...options
        };

        this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        this.isAndroid = /Android/i.test(navigator.userAgent);
        this.isMobile = this.isIOS || this.isAndroid;

        this.activeInput = null;
        this.keyboardOpen = false;
        this.visualViewport = window.visualViewport;
        this.inputContainer = document.getElementById('inputContainer');

        // ç»‘å®šæ–¹æ³•
        this.handleViewportChange = this.handleViewportChange.bind(this);
        this.handleFocusIn = this.handleFocusIn.bind(this);
        this.handleFocusOut = this.handleFocusOut.bind(this);
        this.resetPosition = this.resetPosition.bind(this);

        if (this.isMobile) {
          this.init();
        }
      }

      log(...args) {
        if (this.options.debug) console.log('[MobileKeyboard]', ...args);
      }

      init() {
        // 1. VisualViewport ç›‘å¬ (iOS æ ¸å¿ƒä¿®å¤)
        if (this.visualViewport) {
          if (this.isIOS) {
            // iOS: å¿…é¡»ç›‘å¬ resize å’Œ scroll æ¥å®æ—¶è°ƒæ•´ä½ç½®
            this.visualViewport.addEventListener('resize', this.handleViewportChange);
            this.visualViewport.addEventListener('scroll', this.handleViewportChange);
          } else {
            // Android: ä»…ç›‘å¬ resize ç”¨äºæ£€æµ‹é”®ç›˜
            this.visualViewport.addEventListener('resize', this.handleViewportChange);
          }
        }

        // 2. Focus ç›‘å¬
        this.setupFocusListeners();

        // 3. å¹³å°ç‰¹å®šä¿®å¤
        if (this.isAndroid) this.applyAndroidFixes();
        if (this.isIOS) this.applyIOSFixes();
      }

      handleViewportChange() {
        if (!this.activeInput && !this.keyboardOpen) return;

        // iOS ä¸“ç”¨å®šä½é€»è¾‘
        if (this.isIOS && this.inputContainer) {
          requestAnimationFrame(() => {
            const viewport = this.visualViewport;
            const layoutHeight = window.innerHeight;
            const visualHeight = viewport.height;
            const visualTop = viewport.offsetTop;

            // è®¡ç®—åç§»é‡ï¼šå¸ƒå±€é«˜åº¦ - (è§†è§‰è§†å£é«˜åº¦ + è§†è§‰è§†å£é¡¶éƒ¨åç§»)
            // è¿™ä»£è¡¨äº†é”®ç›˜ï¼ˆæˆ–è§†å£åº•éƒ¨è¢«é®æŒ¡åŒºåŸŸï¼‰çš„é«˜åº¦
            // æ³¨æ„ï¼šMath.max(0, ...) é˜²æ­¢è´Ÿå€¼
            const offset = Math.max(0, layoutHeight - visualHeight - visualTop);

            // åº”ç”¨ä½ç§»ï¼Œå°†è¾“å…¥æ¡†æŠ¬èµ·
            // åªæœ‰å½“åç§»é‡æ˜¾è‘—ï¼ˆ>10pxï¼‰æ—¶æ‰åº”ç”¨ï¼Œé¿å…å¾®å°æŠ–åŠ¨
            if (offset > 10) {
              this.inputContainer.style.transform = `translateY(-${offset}px)`;
              this.inputContainer.style.transition = 'none'; // ç¦ç”¨è¿‡æ¸¡ä»¥å®ç°å®æ—¶è·Ÿéš
              this.keyboardOpen = true;
            } else {
              this.resetPosition();
            }

            this.log('iOS Adjust:', { layoutHeight, visualHeight, visualTop, offset });
          });
        }

        // Android é€»è¾‘ (ä¿æŒä¸å˜)
        if (this.isAndroid) {
          // ... Android existing logic if needed, mostly handled by resize ...
          const currentHeight = this.visualViewport.height;
          const keyboardHeight = window.innerHeight - currentHeight;
          this.keyboardOpen = keyboardHeight > 150;
          if (this.keyboardOpen) {
            setTimeout(() => this.adjustAndroidPosition(), 100);
          }
        }
      }

      resetPosition() {
        if (this.inputContainer) {
          this.inputContainer.style.transform = '';
          this.inputContainer.style.transition = ''; // æ¢å¤ CSS å®šä¹‰çš„è¿‡æ¸¡
        }
        this.keyboardOpen = false;
      }

      adjustAndroidPosition() {
        if (!this.activeInput) return;
        const inputRect = this.activeInput.getBoundingClientRect();
        const viewportTop = this.visualViewport ? this.visualViewport.offsetTop : 0;
        const viewportHeight = this.visualViewport ? this.visualViewport.height : window.innerHeight;
        const inputBottomRelative = inputRect.bottom - viewportTop;
        const threshold = viewportHeight * 0.85;

        if (inputBottomRelative > threshold) {
          const scrollAmount = inputBottomRelative - threshold + 20;
          if (scrollAmount > 0) {
            window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
          }
        }
      }

      setupFocusListeners() {
        document.addEventListener('focusin', this.handleFocusIn);
        document.addEventListener('focusout', this.handleFocusOut);
      }

      handleFocusIn(event) {
        const target = event.target;
        if (!this.isInputElement(target)) return;

        this.activeInput = target;
        this.keyboardOpen = true;

        if (window.expandInput && !window.appState?.inputExpanded) {
          window.expandInput();
        }

        // iOS: ç«‹å³è§¦å‘ä¸€æ¬¡ä½ç½®æ›´æ–°
        if (this.isIOS) {
          setTimeout(() => this.handleViewportChange(), 100);
        }

        // Android: æ»šåŠ¨
        if (this.isAndroid) {
          setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }

      handleFocusOut(event) {
        if (event.target === this.activeInput) {
          this.activeInput = null;
          // å»¶è¿Ÿé‡ç½®ï¼Œé˜²æ­¢ç„¦ç‚¹åˆ‡æ¢æ—¶çš„é—ªçƒ
          setTimeout(() => {
            if (!this.activeInput) this.resetPosition();
          }, 100);
        }
      }

      applyAndroidFixes() {
        const container = document.getElementById('inputContainer');
        if (container) {
          container.addEventListener('click', (e) => {
            const input = document.getElementById('messageInput');
            if (input && e.target !== input && !e.target.closest('button')) {
              setTimeout(() => input.focus(), 10);
            }
          });
        }
      }

      applyIOSFixes() {
        document.addEventListener('touchstart', (e) => {
          if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
      }

      isInputElement(element) {
        return element.tagName === 'TEXTAREA' || (element.tagName === 'INPUT' && element.type === 'text');
      }
    }

    // ==================== æ–‡ä»¶ä¸Šä¼ å¤„ç† ====================
    let currentAttachment = null;

    function handleFileUpload() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*,video/*,.pdf,.doc,.docx,.txt';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const maxSize = 50 * 1024 * 1024;
        if (file.size > maxSize) {
          alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡50MB');
          return;
        }

        const fileType = file.type;
        let attachmentType = 'document';

        if (fileType.startsWith('image/')) attachmentType = 'image';
        else if (fileType.startsWith('video/')) attachmentType = 'video';

        if (attachmentType === 'document') {
          try {
            const formData = new FormData();
            formData.append('file', file);
            const response = await fetch(`${API_BASE}/upload/document`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${appState.token}` },
              body: formData
            });
            if (!response.ok) throw new Error('æ–‡æ¡£ä¸Šä¼ å¤±è´¥');
            const data = await response.json();
            currentAttachment = {
              type: 'document',
              fileId: data.file_id,
              fileName: file.name
            };
            console.log('âœ… æ–‡æ¡£ä¸Šä¼ æˆåŠŸ');
          } catch (error) {
            console.error('âŒ æ–‡æ¡£ä¸Šä¼ å¤±è´¥:', error);
            alert('æ–‡æ¡£ä¸Šä¼ å¤±è´¥');
          }
        } else {
          const reader = new FileReader();
          reader.onload = (event) => {
            currentAttachment = {
              type: attachmentType,
              data: event.target.result,
              fileName: file.name
            };
            console.log(`âœ… ${attachmentType}æ–‡ä»¶å·²é€‰æ‹©`);
          };
          reader.readAsDataURL(file);
        }
      };
      input.click();
    }

    function removeAttachment() {
      currentAttachment = null;
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      window.mobileKeyboardHandler = new MobileKeyboardHandler({
        debug: false
      });

      // çª—å£å°ºå¯¸å˜åŒ–æ—¶é‡æ–°è®¡ç®—ç«–çº¿é•¿åº¦
      window.addEventListener('resize', () => {
        if (appState.thinkingUIMode === 'expanded') {
          // æ›´æ–°æ‰€æœ‰å±•å¼€çš„æ€è€ƒå†…å®¹ç«–çº¿
          document.querySelectorAll('.thinking-content.expanded').forEach(content => {
            const thinkingId = content.id;
            if (thinkingId) {
              updateThinkingLine(thinkingId);
            }
          });
        }
      });

    });
  </script>
</body>

</html>
