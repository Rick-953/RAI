<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-visual">
  <meta name="theme-color" content="#0D0D0D">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>RAI</title>

  <link rel="icon"
    href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="64" height="64"><defs><linearGradient id="planetGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23f5d547;stop-opacity:1"/><stop offset="100%" style="stop-color:%23e6a824;stop-opacity:1"/></linearGradient><linearGradient id="ringGrad" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:%23f9e79f;stop-opacity:1"/><stop offset="100%" style="stop-color:%23fef5e7;stop-opacity:1"/></linearGradient></defs><circle cx="32" cy="32" r="14" fill="url(%23planetGrad)"/><path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(%23ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.8"/><path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(%23ringGrad)" stroke-width="4" stroke-linecap="round" opacity="0.9"/><circle cx="26" cy="26" r="4" fill="white" opacity="0.2"/></svg>'
    type="image/svg+xml">

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <!-- Marked.js for Markdown Rendering -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* ==================== 全局重置与变量 ==================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0D0D0D;
      --bg-secondary: #1A1A1A;
      --bg-tertiary: #2A2A2A;
      --bg-hover: #353535;
      --text-primary: #ECECEC;
      --text-secondary: #ACACAC;
      --text-tertiary: #6E6E6E;
      --border-color: #2A2A2A;
      --border-dark: #404040;
      --accent-color: #FFFFFF;
      --accent-hover: #E0E0E0;
      --input-bg: #202020;
      --error-color: #EF4444;
      --warning-color: #F59E0B;
      --success-color: #10B981;
      --thinking-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --sidebar-width: 280px;
      --header-height: 60px;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 12px;
      --spacing-lg: 20px;
      --spacing-xl: 28px;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.5);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
      --z-modal: 1000;
      --z-overlay: 999;
      --z-sidebar: 100;
      --z-header: 90;
    }

    /* 浅色主题 */
    [data-theme="light"] {
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F5;
      --bg-tertiary: #E5E5E5;
      --bg-hover: #D4D4D4;
      --text-primary: #1A1A1A;
      --text-secondary: #525252;
      --text-tertiary: #A3A3A3;
      --border-color: #E5E5E5;
      --border-dark: #D4D4D4;
      --accent-color: #000000;
      --accent-hover: #404040;
      --input-bg: #F5F5F5;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.2);
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      position: fixed;
      /* 防止iOS橡皮筋效果 */
      transition: background-color 0.3s, color 0.3s;
    }



    .material-symbols-outlined {
      font-variation-settings: 'FILL' 0, 'wght' 300, 'GRAD' 0, 'opsz' 20;
    }

    /* ==================== 布局容器 ==================== */
    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      background-color: transparent;
      /* 改为透明 */
      position: relative;
      overflow: hidden;
      z-index: 1;
      /* 确保在canvas之上 */
    }

    /* ==================== 侧边栏 ==================== */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: var(--z-sidebar);
    }

    .sidebar-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    /* PC侧边栏顶栏控制按钮 */
    .sidebar-header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .sidebar-header-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .sidebar-control-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .sidebar-control-btn:hover {
      background: var(--bg-hover);
    }

    .sidebar-lang-text {
      font-size: 14px;
      font-weight: 600;
      min-width: 18px;
      text-align: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-bottom: 0;
    }

    .logo-icon {
      width: 38px;
      height: 38px;
      flex-shrink: 0;
      background: var(--bg-tertiary);
      border-radius: 50% 10px 10px 10px;
      padding: 3px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.5px;
    }

    .version-tag {
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .new-chat-btn {
      width: 100%;
      padding: var(--spacing-md) var(--spacing-lg);
      background: transparent;
      color: var(--text-primary);
      border: 1px solid var(--border-dark);
      border-radius: 50px;
      /* 新对话按钮从圆角矩形改成两侧圆形 */
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }

    .new-chat-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-color);
    }

    .sessions-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-md);
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    .sessions-container::-webkit-scrollbar {
      width: 5px;
    }

    .sessions-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .sessions-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .session-item {
      padding: var(--spacing-md);
      padding-right: 36px;
      margin-bottom: var(--spacing-sm);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .session-item:hover {
      background: var(--bg-tertiary);
    }

    .session-item.active {
      background: var(--bg-tertiary);
      border-color: var(--border-dark);
    }

    .session-title {
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-preview {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-delete-btn {
      position: absolute;
      top: 50%;
      right: var(--spacing-sm);
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      padding: 0;
      background: transparent;
      color: var(--text-tertiary);
      border: none;
      border-radius: var(--radius-sm);
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
    }

    .session-delete-btn:hover {
      background: var(--error-color);
      color: white;
      opacity: 1;
    }

    .sidebar-footer {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      background: var(--bg-tertiary);
      border-radius: 20px 20px 10px 10px;
      /* 左上和右上圆角为30dp，下面两个圆角为14dp */
      margin-bottom: var(--spacing-md);
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: var(--radius-full);
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 10px;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-email {
      font-size: 11px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .sidebar-action-btn {
      flex: 1;
      padding: var(--spacing-sm) var(--spacing-md);
      background: transparent;
      border: 1px solid var(--border-color);
      /* border-radius: var(--radius-sm); removed for specific corners */
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
    }

    .sidebar-action-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
    }

    .sidebar-actions .sidebar-action-btn:first-child {
      border-radius: 10px 10px 10px 20px;
      /* 设置按钮 左下角为30dp 其他14dp */
    }

    .sidebar-actions .sidebar-action-btn:last-child {
      border-radius: 10px 10px 20px 10px;
      /* 退出按钮 右下是30dp 其他14dp */
    }

    .logo-text-col {
      display: flex;
      flex-direction: column;
      line-height: 1;
    }

    .logo-subtitle {
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
      font-weight: 400;
    }

    /* ==================== 主内容区 ==================== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: transparent;
      /* 改为透明 */
      position: relative;
      overflow: hidden;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-xl) var(--spacing-lg);
      padding-bottom: 160px;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    .chat-container::-webkit-scrollbar {
      width: 6px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    .welcome-screen {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 700px;
      margin: 0 auto;
      text-align: center;
      padding: var(--spacing-xl);
    }

    .welcome-icon {
      width: 96px;
      height: 96px;
      margin-bottom: var(--spacing-xl);
      animation: float 3s ease-in-out infinite;
      filter: drop-shadow(0 4px 12px rgba(245, 213, 71, 0.3));
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .welcome-icon svg {
      width: 100%;
      height: 100%;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    .welcome-title {
      font-size: 32px;
      font-weight: 700;
      background: linear-gradient(90deg, #FFFFFF 0%, #E0E0E0 25%, #888888 50%, #404040 75%, #FFFFFF 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0;
      letter-spacing: -0.5px;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.15);
      animation: gradientShift 3s linear infinite;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 200% 50%;
      }
    }

    .welcome-subtitle {
      font-size: 15px;
      color: var(--text-secondary);
      line-height: 1.7;
      margin-bottom: var(--spacing-xl);
    }

    .welcome-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 420px;
      margin-top: 32px;
    }

    .action-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      aspect-ratio: 1;
      min-width: 140px;
      min-height: 140px;
      position: relative;
      overflow: hidden;
    }

    .action-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .action-card:hover::before {
      opacity: 1;
    }

    .action-card:hover {
      transform: translateY(-4px);
      border-color: var(--border-dark);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .action-card:nth-child(1) {
      border-radius: 30px 13px 13px 13px;
    }

    .action-card:nth-child(2) {
      border-radius: 13px 30px 13px 13px;
    }

    .action-card:nth-child(3) {
      border-radius: 13px 13px 13px 30px;
    }

    .action-card:nth-child(4) {
      border-radius: 13px 13px 30px 13px;
    }

    .action-card-icon {
      font-size: 32px;
      background: linear-gradient(135deg, #FFFFFF 0%, #D0D0D0 50%, #606060 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .action-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    [data-theme="light"] .welcome-icon {
      background: linear-gradient(135deg, #404040 0%, #808080 50%, #D0D0D0 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    [data-theme="light"] .welcome-title {
      background: linear-gradient(90deg, #202020 0%, #404040 25%, #808080 50%, #A0A0A0 75%, #202020 100%);
      background-size: 200% 100%;
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: gradientShift 3s linear infinite;
    }

    [data-theme="light"] .action-card-icon {
      background: linear-gradient(135deg, #303030 0%, #606060 50%, #909090 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .messages-list {
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    .message {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
      animation: messageSlideIn 0.3s ease-out;
    }

    /* 用户消息居右对齐 */
    .message.user {
      flex-direction: row-reverse;
      justify-content: flex-start;
      margin-bottom: calc(var(--spacing-xl) * 1.5);
    }

    /* AI消息居左对齐，不显示头像 */
    .message.assistant {
      flex-direction: row;
      margin-bottom: calc(var(--spacing-xl) * 2);
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(15px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .message.user .message-avatar {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
    }

    .message.assistant .message-avatar {
      display: none;
    }

    .message-content {
      flex: 1;
      min-width: 0;
    }

    /* 用户消息内容居右 */
    .message.user .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-text {
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      line-height: 1.7;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-size: 14px;
    }

    .message.user .message-text {
      background: var(--bg-secondary);
      color: var(--text-primary);
      max-width: 100%;
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .message.assistant .message-text {
      background: transparent;
      color: var(--text-primary);
      padding: 0;
    }

    /* 消息元信息和操作栏 */
    .message-meta {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-sm);
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .meta-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .meta-badge .material-symbols-outlined {
      font-size: 12px;
    }

    .copy-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px;
      width: 28px;
      height: 28px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      font-size: 11px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .copy-btn .material-symbols-outlined {
      font-size: 16px;
    }

    .copy-btn.copied {
      color: var(--accent-color);
      border-color: var(--accent-color);
    }

    /* ====================Markdown渲染样式 ==================== */
    .message-text h1,
    .message-text h2,
    .message-text h3,
    .message-text h4,
    .message-text h5,
    .message-text h6 {
      margin: 1em 0 0.5em 0;
      font-weight: 600;
      line-height: 1.3;
    }

    .message-text h1 {
      font-size: 1.8em;
    }

    .message-text h2 {
      font-size: 1.5em;
    }

    .message-text h3 {
      font-size: 1.3em;
    }

    .message-text h4 {
      font-size: 1.1em;
    }

    .message-text p {
      margin: 0.5em 0;
    }

    .message-text ul,
    .message-text ol {
      margin: 0.5em 0;
      padding-left: 2em;
    }

    .message-text li {
      margin: 0.3em 0;
    }

    .message-text a {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .message-text blockquote {
      border-left: 3px solid var(--border-dark);
      padding-left: 1em;
      margin: 1em 0;
      color: var(--text-secondary);
    }

    .message-text code {
      background: var(--bg-tertiary);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 0.9em;
    }

    .message-text pre {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      overflow-x: auto;
      margin: 0.8em 0;
    }

    .message-text pre code {
      background: none;
      padding: 0;
      border-radius: 0;
      font-size: 0.85em;
    }

    .message-text img {
      max-width: 100%;
      border-radius: var(--radius-md);
      margin: 0.8em 0;
    }

    /* ==================== 流式输出模糊动画 ==================== */
    @keyframes streamBlurIn {
      0% {
        opacity: 0;
        filter: blur(8px);
        transform: translateY(4px);
      }

      100% {
        opacity: 1;
        filter: blur(0);
        transform: translateY(0);
      }
    }

    .streaming-char {
      display: inline;
      animation: streamBlurIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    }

    #streamingContent {
      animation: streamBlurIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }

    .message-text table {
      border-collapse: collapse;
      width: 100%;
      margin: 1em 0;
    }

    .message-text table th,
    .message-text table td {
      border: 1px solid var(--border-color);
      padding: 0.5em;
      text-align: left;
    }

    .message-text table th {
      background: var(--bg-tertiary);
      font-weight: 600;
    }

    .message-text hr {
      border: none;
      border-top: 1px solid var(--border-color);
      margin: 1.5em 0;
    }

    /* 浅色主题Markdown样式 */
    [data-theme="light"] .message-text code {
      background: #F3F4F6;
    }

    [data-theme="light"] .message-text pre {
      background: #F9FAFB;
      border-color: #E5E7EB;
    }

    [data-theme="light"] .message-text blockquote {
      border-left-color: #D1D5DB;
    }

    [data-theme="light"] .message-text table th {
      background: #F3F4F6;
    }

    [data-theme="light"] .message-text table th,
    [data-theme="light"] .message-text table td {
      border-color: #E5E7EB;
    }


    .thinking-indicator {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-md);
      overflow: hidden;
    }

    .thinking-label {
      color: var(--text-primary);
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .thinking-label:hover {
      background: var(--bg-hover);
    }

    .thinking-label-left {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .thinking-expand-icon {
      font-size: 16px;
      transition: transform 0.3s;
      color: var(--text-secondary);
    }

    .thinking-expand-icon.expanded {
      transform: rotate(180deg);
    }

    .thinking-content {
      background: var(--bg-secondary);
      padding: var(--spacing-md);
      color: var(--text-secondary);
      font-size: 12px;
      font-family: 'Monaco', 'Courier New', monospace;
      white-space: pre-wrap;
      line-height: 1.6;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid var(--border-color);
      display: none;
    }

    .thinking-content.expanded {
      display: block;
    }

    /* ==================== 输入区域悬浮样式 ==================== */
    .input-area {
      position: absolute;
      /* 保持absolute以便桌面端居中 */
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      padding: var(--spacing-lg);
      padding-bottom: var(--spacing-lg);
      background: transparent;
      border-top: none;
      pointer-events: none;
      /* 恢复，让布局正常 */
    }

    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
    }

    .input-container {
      position: relative;
      background: rgba(26, 26, 26, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-xl);
      padding: var(--spacing-md);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      box-shadow: var(--shadow-lg);
      pointer-events: auto;
      will-change: width, height, padding, gap;
    }

    /* 简化状态 */
    .input-container.collapsed {
      /* 保持圆角一致，避免动画卡顿 */
      border-radius: var(--radius-xl);
      padding: 8px 8px 8px 16px;
      gap: 0;
    }

    .input-container.collapsed .input-toolbar {
      max-height: 0;
      opacity: 0;
      padding-bottom: 0;
      border-bottom: none;
      margin-bottom: 0;
      pointer-events: none;
    }

    .input-container.collapsed .message-input {
      font-size: 14px;
      padding: 4px 0;
    }

    .input-container.collapsed .input-row {
      align-items: center;
    }

    [data-theme="light"] .input-container {
      background: rgba(245, 245, 245, 0.7);
    }

    .input-container:focus-within {
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary), var(--shadow-lg);
    }

    .input-toolbar {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--border-color);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
      opacity: 1;
      max-height: 100px;
      overflow: hidden;
    }

    /* 展开且动画结束后，允许溢出以显示下拉菜单 */
    .input-toolbar.overflow-visible {
      overflow: visible;
    }

    .toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .toolbar-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
      color: var(--text-primary);
    }

    .toolbar-btn.active {
      background: var(--bg-tertiary);
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .toolbar-btn .material-symbols-outlined {
      font-size: 16px;
    }

    /* ==================== 自定义模型选择器 ==================== */
    .model-selector {
      position: relative;
      flex: 0 0 auto;
    }

    .model-select-custom {
      width: auto;
      min-width: 80px;
      padding: 6px 8px 6px 12px;
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      user-select: none;
      white-space: nowrap;
    }

    .model-select-custom:hover {
      background: var(--bg-hover);
      border-color: var(--border-dark);
    }

    .model-select-arrow {
      font-size: 16px;
      color: var(--text-secondary);
      transition: transform 0.2s;
    }

    .model-select-custom.open .model-select-arrow {
      transform: rotate(180deg);
    }

    .model-dropdown {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 100;
      overflow: hidden;
      display: none;
    }

    .model-dropdown.open {
      display: block;
      animation: dropdownSlide 0.2s ease-out;
    }

    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .model-option {
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text-primary);
      cursor: pointer;
      transition: background 0.2s;
      border-bottom: 1px solid var(--border-color);
    }

    .model-option:last-child {
      border-bottom: none;
    }

    .model-option:hover {
      background: var(--bg-hover);
    }

    .model-option.selected {
      background: var(--bg-tertiary);
      color: var(--accent-color);
      font-weight: 600;
    }

    .input-row {
      display: flex;
      align-items: flex-end;
      gap: var(--spacing-md);
      transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .message-input {
      flex: 1;
      min-height: 24px;
      max-height: 200px;
      padding: 0;
      border: none;
      background: transparent;
      font-size: 16px;
      /* iOS 防止自动缩放，最小必须 16px */
      color: var(--text-primary);
      resize: none;
      outline: none;
      font-family: inherit;
      line-height: 1.5;
      transition: font-size 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    .message-input::placeholder {
      color: var(--text-tertiary);
    }

    .send-btn,
    .stop-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      background: var(--accent-color);
      color: var(--bg-primary);
    }

    .send-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: scale(1.05);
    }

    .send-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      background: var(--text-tertiary);
    }

    .stop-btn {
      background: var(--error-color);
      color: white;
    }

    .stop-btn:hover {
      background: #DC2626;
    }

    .send-btn .material-symbols-outlined,
    .stop-btn .material-symbols-outlined {
      font-size: 18px;
    }

    /* ==================== 设置面板 ==================== */
    .settings-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      padding: var(--spacing-lg);
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .settings-modal.active {
      display: flex;
    }

    .settings-content {
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .settings-header {
      padding: var(--spacing-xl);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .settings-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .settings-body {
      padding: var(--spacing-xl);
    }

    .settings-group {
      margin-bottom: var(--spacing-xl);
    }

    .settings-group-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--spacing-md);
    }

    .setting-item {
      margin-bottom: var(--spacing-lg);
    }

    .setting-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .setting-description {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    .setting-input,
    .system-prompt-input {
      width: 100%;
      padding: var(--spacing-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-family: inherit;
      font-size: 16px;
      /* iOS 防止自动缩放 */
      resize: vertical;
      min-height: 100px;
      outline: none;
      transition: border-color 0.2s;
      -webkit-appearance: none;
      appearance: none;
    }

    .setting-input:focus {
      outline: none;
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary);
    }

    .system-prompt-input:focus {
      border-color: var(--accent-color);
    }

    /* 高级选项样式 */
    .advanced-options-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      padding: var(--spacing-sm) 0;
      user-select: none;
    }

    .advanced-options-icon {
      transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .advanced-options-header.expanded .advanced-options-icon {
      transform: rotate(180deg);
    }

    .advanced-options-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .advanced-options-content.expanded {
      max-height: 1000px;
      /* 足够大以容纳内容 */
      opacity: 1;
      margin-top: var(--spacing-sm);
    }

    .setting-textarea {
      min-height: 100px;
      resize: vertical;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 12px;
    }

    .slider-container {
      padding: var(--spacing-md) 0;
    }

    .slider-input {
      width: 100%;
      height: 4px;
      border-radius: 2px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .slider-input::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .slider-input::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border: none;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
    }

    .slider-value {
      display: inline-block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-left: var(--spacing-sm);
    }

    .settings-footer {
      padding: var(--spacing-lg) var(--spacing-xl);
      border-top: 1px solid var(--border-color);
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
    }

    .btn {
      padding: var(--spacing-md) var(--spacing-xl);
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--accent-color);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }

    /* ==================== 移动端键盘优化 CSS ==================== */
    /* iOS 防止橡皮筋效果 */
    .prevent-bounce {
      overscroll-behavior: none;
      -webkit-overflow-scrolling: touch;
    }

    /* Android 防止过度滚动 */
    .no-overscroll {
      overscroll-behavior-y: contain;
    }

    /* 平滑滚动 */
    @media (prefers-reduced-motion: no-preference) {
      .smooth-scroll {
        scroll-behavior: smooth;
      }
    }

    /* 底部固定输入框容器优化 */
    .fixed-input-container {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1000;
      transform: translateY(0);
    }

    /* iOS 安全区域适配 */
    @supports (padding: max(0px)) {
      body {
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    }

    /* 确保输入框在移动端有足够的高度 */
    @media (max-width: 768px) {
      .message-input {
        font-size: 16px !important;
        /* 强制 16px 防止缩放 */
      }
    }

    /* ==================== 登录/注册界面 ==================== */
    .auth-container {
      position: fixed;
      top: 0;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      /* 禁止body滚动 */
      background-color: var(--bg-primary);
      color: var(--text-primary);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      position: fixed;
      /* 防止iOS橡皮筋效果和意外滚动 */
    }

    .app-container {
      display: flex;
      width: 100%;
      height: 100%;
      /* 将由JS动态调整 */
      background-color: transparent;
      position: relative;
      overflow: hidden;
      /* 确保内部滚动不影响整体 */
    }

    .auth-container {
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-primary);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
    }

    .auth-container.active {
      display: flex;
    }

    .auth-box {
      width: 100%;
      max-width: 400px;
      padding: var(--spacing-xl);
      background: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      margin: var(--spacing-lg);
    }

    .auth-logo {
      text-align: center;
      margin-bottom: var(--spacing-xl);
    }

    .auth-logo-text {
      font-size: 42px;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -1px;
    }

    .auth-title {
      font-size: 22px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      text-align: center;
    }

    .auth-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-xl);
      text-align: center;
    }

    .auth-form {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .form-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .form-input {
      padding: var(--spacing-md);
      background: var(--input-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
      font-family: inherit;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--text-tertiary);
      box-shadow: 0 0 0 1px var(--text-tertiary);
    }

    .auth-btn {
      padding: var(--spacing-md);
      background: var(--accent-color);
      color: var(--bg-primary);
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: var(--spacing-md);
    }

    .auth-btn:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .auth-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .auth-switch {
      text-align: center;
      margin-top: var(--spacing-lg);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .auth-link {
      color: var(--accent-color);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: opacity 0.2s;
    }

    .auth-link:hover {
      opacity: 0.8;
    }

    .error-message {
      padding: var(--spacing-md);
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--error-color);
      border-radius: var(--radius-sm);
      color: var(--error-color);
      font-size: 13px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* ==================== 移动端适配与侧边栏滑动 ==================== */
    .mobile-header {
      display: none;
      padding: var(--spacing-md) var(--spacing-lg);
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: var(--z-header);
    }

    /* ==================== 顶栏控制按钮 ==================== */
    .header-controls {
      display: flex;
      gap: var(--spacing-sm);
      align-items: center;
    }

    .control-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .control-btn:hover {
      background: var(--bg-hover);
    }

    .hamburger-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 22px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      transition: background 0.2s;
    }

    .hamburger-btn:hover {
      background: var(--bg-hover);
    }

    .mobile-logo {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: calc(var(--z-sidebar) - 1);
    }

    .mobile-overlay.active {
      display: block;
    }

    @media (max-width: 768px) {
      :root {
        --sidebar-width: 85%;
        --spacing-lg: 14px;
        --spacing-xl: 20px;
      }

      .app-container {
        display: block;
        position: relative;
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: var(--sidebar-width);
        max-width: 320px;
        transform: translateX(-100%);
        box-shadow: var(--shadow-lg);
        z-index: var(--z-sidebar);
      }

      .sidebar.active {
        transform: translateX(0);
      }

      .main-content {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        margin: 0;
      }

      .mobile-header {
        display: flex;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: var(--z-header);
      }

      .chat-container {
        padding-top: calc(var(--header-height) + var(--spacing-lg));
        padding-left: var(--spacing-md);
        padding-right: var(--spacing-md);
        height: 100%;
      }

      .input-area {
        padding: var(--spacing-md);
        padding-bottom: calc(var(--spacing-md) + env(safe-area-inset-bottom));
      }

      .input-toolbar {
        flex-wrap: wrap;
      }

      .toolbar-btn {
        padding: 5px 10px;
        font-size: 11px;
      }

      .model-selector {
        max-width: 140px;
      }

      .welcome-icon .material-symbols-outlined {
        font-size: 48px !important;
      }

      .welcome-title {
        font-size: 22px;
      }

      .welcome-subtitle {
        font-size: 13px;
      }

      .message {
        margin-bottom: var(--spacing-lg);
      }

      .message-avatar {
        width: 28px;
        height: 28px;
      }

      .settings-content {
        margin: 0;
        border-radius: 0;
        max-height: 100vh;
        width: 100%;
      }

      .auth-box {
        margin: var(--spacing-md);
        max-width: 100%;
      }
    }

    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }

    *::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 3px;
    }

    *::-webkit-scrollbar-thumb:hover {
      background: var(--border-dark);
    }

    /* ==================== 思考预算控制 ==================== */
    .thinking-controls {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .thinking-budget-modal {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      z-index: 200;
      animation: budgetSlideUp 0.2s ease-out;
    }

    @keyframes budgetSlideUp {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .thinking-budget-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-dark);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      box-shadow: var(--shadow-lg);
      min-width: 280px;
    }

    .thinking-budget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .thinking-budget-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .thinking-budget-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .thinking-budget-description {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-md);
    }

    .thinking-budget-slider-container {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .thinking-budget-label {
      font-size: 11px;
      color: var(--text-tertiary);
      flex-shrink: 0;
    }

    .thinking-budget-slider {
      flex: 1;
      height: 4px;
      border-radius: 2px;
      background: var(--border-color);
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .thinking-budget-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 14px;
      height: 14px;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .thinking-budget-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .thinking-budget-slider::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border: none;
      border-radius: var(--radius-full);
      background: var(--accent-color);
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- 登录/注册界面 -->
  <div class="auth-container active" id="authContainer">
    <div class="auth-box">
      <div class="auth-logo">
        <div class="auth-logo-text">RAI</div>
      </div>

      <div id="loginForm">
        <h2 class="auth-title" data-i18n="login-title">欢迎回来</h2>
        <p class="auth-subtitle" data-i18n="login-subtitle">登录继续使用 RAI</p>

        <div class="error-message" id="loginError"></div>

        <form class="auth-form" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label class="form-label" data-i18n="email-label">邮箱</label>
            <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="password-label">密码</label>
            <input type="password" class="form-input" id="loginPassword" data-i18n-placeholder="password-placeholder"
              placeholder="至少6位字符" required>
          </div>

          <button type="submit" class="auth-btn" id="loginBtn" data-i18n="login-btn">登录</button>
        </form>

        <div class="auth-switch">
          <span data-i18n="no-account">还没有账号?</span> <a class="auth-link" onclick="switchToRegister()"
            data-i18n="register-link">立即注册</a>
        </div>
      </div>

      <div id="registerForm" style="display: none;">
        <h2 class="auth-title" data-i18n="register-title">创建账号</h2>
        <p class="auth-subtitle" data-i18n="register-subtitle">加入 RAI 开始对话</p>

        <div class="error-message" id="registerError"></div>

        <form class="auth-form" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label class="form-label" data-i18n="email-label">邮箱</label>
            <input type="email" class="form-input" id="registerEmail" placeholder="your@email.com" required>
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="username-label">用户名 (可选)</label>
            <input type="text" class="form-input" id="registerUsername" data-i18n-placeholder="username-placeholder"
              placeholder="您的昵称">
          </div>

          <div class="form-group">
            <label class="form-label" data-i18n="password-label">密码</label>
            <input type="password" class="form-input" id="registerPassword" data-i18n-placeholder="password-placeholder"
              placeholder="至少6位字符" required minlength="6">
          </div>

          <button type="submit" class="auth-btn" id="registerBtn" data-i18n="register-btn">注册</button>
        </form>

        <div class="auth-switch">
          <span data-i18n="has-account">已有账号?</span> <a class="auth-link" onclick="switchToLogin()"
            data-i18n="login-link">立即登录</a>
        </div>
      </div>
    </div>
  </div>

  <!-- 主应用容器 -->
  <div class="app-container" id="appContainer" style="display: none;">
    <!-- 移动端头部 -->
    <div class="mobile-header" id="mobileHeader">
      <button class="hamburger-btn" onclick="toggleSidebar()">
        <span class="material-symbols-outlined">menu</span>
      </button>
      <div class="mobile-logo">RAI</div>
      <div class="header-controls">
        <button class="control-btn" onclick="toggleTheme()" title="切换主题">
          <span class="material-symbols-outlined" id="mobileThemeIcon">light_mode</span>
        </button>
        <button class="control-btn" onclick="toggleLanguage()" title="切换语言">
          <span id="mobileLangText" style="font-size: 14px; font-weight: 600;">EN</span>
        </button>
      </div>
    </div>

    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleSidebar()"></div>

    <!-- 侧边栏 -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-header-top">
          <div class="logo-section">
            <svg class="logo-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="32" height="32">
              <defs>
                <linearGradient id="planetGradLogo" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f5d547;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#e6a824;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="ringGradLogo" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#f9e79f;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#fef5e7;stop-opacity:1" />
                </linearGradient>
              </defs>
              <circle cx="32" cy="32" r="14" fill="url(#planetGradLogo)" />
              <path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(#ringGradLogo)"
                stroke-width="4" stroke-linecap="round" opacity="0.8" />
              <path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(#ringGradLogo)" stroke-width="4"
                stroke-linecap="round" opacity="0.9" />
              <circle cx="26" cy="26" r="4" fill="white" opacity="0.2" />
            </svg>
            <div class="logo-text-col">
              <div class="logo">RAI</div>
              <div class="logo-subtitle">by Rick</div>
            </div>
            <span class="version-tag" style="display:none;">v0.3</span>
          </div>
          <div class="sidebar-header-controls">
            <button class="sidebar-control-btn" onclick="toggleTheme()" title="切换主题">
              <span class="material-symbols-outlined" id="sidebarThemeIcon">light_mode</span>
            </button>
            <button class="sidebar-control-btn" onclick="toggleLanguage()" title="切换语言">
              <span class="sidebar-lang-text" id="sidebarLangText">EN</span>
            </button>
          </div>
        </div>
        <button class="new-chat-btn" onclick="createNewSession()">
          <span class="material-symbols-outlined">add</span>
          <span data-i18n="new-chat">新对话</span>
        </button>
      </div>

      <div class="sessions-container" id="sessionsContainer">
      </div>

      <div class="sidebar-footer">
        <div class="user-section" id="userSection">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-info">
            <div class="user-name" id="userName">用户</div>
            <div class="user-email" id="userEmail">user@email.com</div>
          </div>
        </div>

        <div class="sidebar-actions">
          <button class="sidebar-action-btn" onclick="openSettings()">
            <span class="material-symbols-outlined">settings</span>
            <span data-i18n="settings">设置</span>
          </button>
          <button class="sidebar-action-btn" onclick="handleLogout()">
            <span class="material-symbols-outlined">logout</span>
            <span data-i18n="logout">退出</span>
          </button>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <div class="chat-container" id="chatContainer">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="96" height="96">
              <defs>
                <linearGradient id="planetGradWelcome" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" style="stop-color:#f5d547;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#e6a824;stop-opacity:1" />
                </linearGradient>
                <linearGradient id="ringGradWelcome" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" style="stop-color:#f9e79f;stop-opacity:1" />
                  <stop offset="100%" style="stop-color:#fef5e7;stop-opacity:1" />
                </linearGradient>
              </defs>
              <circle cx="32" cy="32" r="14" fill="url(#planetGradWelcome)" />
              <path d="M 10 42 C 10 35, 54 20, 54 28 C 54 32, 40 40, 32 40" fill="none" stroke="url(#ringGradWelcome)"
                stroke-width="4" stroke-linecap="round" opacity="0.8" />
              <path d="M 54 28 C 54 36, 10 50, 10 42" fill="none" stroke="url(#ringGradWelcome)" stroke-width="4"
                stroke-linecap="round" opacity="0.9" />
              <circle cx="26" cy="26" r="4" fill="white" opacity="0.2" />
            </svg>
          </div>
          <h1 class="welcome-title" data-i18n="welcome-title">How can I help you? ✨</h1>

          <div class="welcome-actions">
            <div class="action-card"
              onclick="document.getElementById('messageInput').value='帮我写一篇文章：'; document.getElementById('messageInput').focus();">
              <span class="material-symbols-outlined action-card-icon">edit_note</span>
              <span class="action-card-title">写作</span>
            </div>

            <div class="action-card"
              onclick="document.getElementById('messageInput').value='搜索：'; document.getElementById('messageInput').focus(); toggleInternet();">
              <span class="material-symbols-outlined action-card-icon">search</span>
              <span class="action-card-title">搜索</span>
            </div>

            <div class="action-card"
              onclick="document.getElementById('messageInput').value='帮我写代码：'; document.getElementById('messageInput').focus();">
              <span class="material-symbols-outlined action-card-icon">code</span>
              <span class="action-card-title">代码</span>
            </div>

            <div class="action-card"
              onclick="document.getElementById('messageInput').value='翻译：'; document.getElementById('messageInput').focus();">
              <span class="material-symbols-outlined action-card-icon">translate</span>
              <span class="action-card-title">翻译</span>
            </div>
          </div>
        </div>

        <div class="messages-list" id="messagesList" style="display: none;">
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="input-area">
        <div class="input-wrapper">
          <div class="input-container collapsed" id="inputContainer" onclick="handleInputContainerClick(event)">
            <!-- 顶部工具栏 -->
            <div class="input-toolbar">
              <!-- 自定义模型选择器 -->
              <div class="model-selector">
                <div class="model-select-custom" id="modelSelectCustom" onclick="toggleModelDropdown()">
                  <span id="selectedModelText">Auto</span>
                  <span class="material-symbols-outlined model-select-arrow">expand_more</span>
                </div>
                <div class="model-dropdown" id="modelDropdown">
                  <div class="model-option selected" data-value="auto" onclick="selectModel('auto', 'Auto')">Auto</div>
                  <div class="model-option" data-value="qwen-flash" onclick="selectModel('qwen-flash', 'Qwen3Flash')">
                    Qwen3Flash</div>
                  <div class="model-option" data-value="qwen-plus" onclick="selectModel('qwen-plus', 'Qwen3-Plus')">
                    Qwen3-Plus</div>
                  <div class="model-option" data-value="qwen-max" onclick="selectModel('qwen-max', 'Qwen3-Max')">
                    Qwen3-Max</div>
                  <div class="model-option" data-value="deepseek-v3"
                    onclick="selectModel('deepseek-v3', 'DeepSeekV3.2')">DeepSeekV3.2</div>
                </div>
              </div>

              <button class="toolbar-btn" id="attachBtn" onclick="handleFileUpload()">
                <span class="material-symbols-outlined">attach_file</span>
                <span data-i18n="attach">附件</span>
              </button>

              <button class="toolbar-btn" id="internetBtn" onclick="toggleInternet()">
                <span class="material-symbols-outlined">language</span>
                <span data-i18n="internet">联网</span>
              </button>

              <div class="thinking-controls" id="thinkingControls" style="display: none;">
                <button class="toolbar-btn" id="thinkingBtn" onclick="toggleThinking()">
                  <span class="material-symbols-outlined">psychology</span>
                  <span data-i18n="reasoning">推理</span>
                </button>
                <button class="toolbar-btn" id="thinkingExpandBtn" style="display: none;"
                  onclick="toggleThinkingBudget()">
                  <span class="material-symbols-outlined">expand_less</span>
                </button>
              </div>

              <!-- 思考预算弹窗 -->
              <div class="thinking-budget-modal" id="thinkingBudgetModal" style="display: none;">
                <div class="thinking-budget-content">
                  <div class="thinking-budget-header">
                    <span class="thinking-budget-title" data-i18n="thinking-budget">思考预算</span>
                    <span class="thinking-budget-value" id="thinkingBudgetValue">1024 tokens</span>
                  </div>
                  <div class="thinking-budget-description" data-i18n="thinking-budget-desc">控制思考的最大长度</div>
                  <div class="thinking-budget-slider-container">
                    <span class="thinking-budget-label" data-i18n="min">最小</span>
                    <input type="range" class="thinking-budget-slider" id="thinkingBudgetSlider" min="1" max="32768"
                      step="256" value="1024" oninput="updateThinkingBudget(this.value)">
                    <span class="thinking-budget-label" data-i18n="max">最大</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 底部输入行 -->
            <div class="input-row">
              <textarea class="message-input" id="messageInput" data-i18n-placeholder="input-placeholder"
                placeholder="询问任何问题" rows="1" inputmode="text" autocomplete="off" autocorrect="off"
                autocapitalize="sentences" onkeydown="handleInputKeydown(event)" oninput="autoResizeInput()"
                onfocus="expandInput()"></textarea>

              <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                <span class="material-symbols-outlined">arrow_upward</span>
              </button>

              <button class="stop-btn" id="stopBtn" style="display: none;" onclick="stopGeneration()">
                <span class="material-symbols-outlined">stop</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 设置面板 -->
  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <div class="settings-header">
        <h2 class="settings-title" data-i18n="settings">设置</h2>
        <button class="close-btn" onclick="closeSettings()">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>

      <div class="settings-body">
        <div class="settings-group">
          <h3 class="settings-group-title" data-i18n="appearance">外观</h3>

          <div class="setting-item">
            <label class="setting-label" data-i18n="theme-label">主题</label>
            <p class="setting-description" data-i18n="theme-desc">选择界面主题</p>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" style="flex: 1;" onclick="setTheme('dark')">
                <span data-i18n="dark-theme">深色</span>
              </button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="setTheme('light')">
                <span data-i18n="light-theme">浅色</span>
              </button>
            </div>
          </div>

          <div class="setting-item">
            <label class="setting-label" data-i18n="language-label">语言</label>
            <p class="setting-description" data-i18n="language-desc">选择界面语言</p>
            <div style="display: flex; gap: 8px;">
              <button class="btn btn-secondary" style="flex: 1;" onclick="setLanguage('zh-CN')">
                <span>中文</span>
              </button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="setLanguage('en')">
                <span>English</span>
              </button>
            </div>
          </div>
        </div>

        <div class="settings-group">
          <h3 class="settings-group-title" data-i18n="preferences-title">您有什么偏好？</h3>
          <div class="setting-item">
            <p class="setting-description" data-i18n="preferences-desc">设置AI的角色和行为</p>
            <textarea class="system-prompt-input" id="systemPrompt" rows="4"
              data-i18n-placeholder="preferences-placeholder" placeholder="例如: 你是一个专业的编程助手,擅长解释代码和解决技术问题..."></textarea>
          </div>
        </div>

        <div class="settings-group">
          <div class="advanced-options-header" onclick="toggleAdvancedOptions()">
            <h3 class="settings-group-title" style="margin-bottom: 0;" data-i18n="advanced-options">高级选项</h3>
            <span class="material-symbols-outlined advanced-options-icon" id="advancedOptionsIcon">expand_more</span>
          </div>

          <div class="advanced-options-content" id="advancedOptionsContent">
            <div class="setting-item" style="margin-top: 16px;">
              <label class="setting-label">Temperature</label>
              <p class="setting-description" data-i18n="temperature-desc">控制回复的随机性 (0-2)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="temperatureSlider" min="0" max="2" step="0.1" value="0.7"
                  oninput="updateSliderValue('temperature', this.value)">
                <span class="slider-value" id="temperatureValue">0.7</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Top P</label>
              <p class="setting-description" data-i18n="topp-desc">核采样参数 (0-1)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="topPSlider" min="0" max="1" step="0.05" value="0.9"
                  oninput="updateSliderValue('topP', this.value)">
                <span class="slider-value" id="topPValue">0.9</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Max Tokens</label>
              <p class="setting-description" data-i18n="maxtokens-desc">最大生成长度 (100-8000)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="maxTokensSlider" min="100" max="8000" step="100"
                  value="2000" oninput="updateSliderValue('maxTokens', this.value)">
                <span class="slider-value" id="maxTokensValue">2000</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Frequency Penalty</label>
              <p class="setting-description" data-i18n="frequency-desc">频率惩罚 (仅DeepSeek)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="frequencySlider" min="-2" max="2" step="0.1" value="0"
                  oninput="updateSliderValue('frequency', this.value)">
                <span class="slider-value" id="frequencyValue">0</span>
              </div>
            </div>

            <div class="setting-item">
              <label class="setting-label">Presence Penalty</label>
              <p class="setting-description" data-i18n="presence-desc">存在惩罚 (仅DeepSeek)</p>
              <div class="slider-container">
                <input type="range" class="slider-input" id="presenceSlider" min="-2" max="2" step="0.1" value="0"
                  oninput="updateSliderValue('presence', this.value)">
                <span class="slider-value" id="presenceValue">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="settings-footer">
        <button class="btn btn-secondary" onclick="closeSettings()" data-i18n="cancel">取消</button>
        <button class="btn btn-primary" onclick="saveSettings()" data-i18n="save-settings">保存设置</button>
      </div>
    </div>
  </div>

  <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelected(event)">

  <!-- 粒子背景画布 -->
  <canvas id="particleCanvas"></canvas>

  <script>
    const API_BASE = '/api';

    const appState = {
      user: null,
      token: null,
      currentSession: null,
      sessions: [],
      messages: [],
      currentRequestId: null,
      isStreaming: false,
      selectedModel: 'auto',  // 默认为auto模式
      thinkingMode: false,
      internetMode: true,  // 默认开启联网
      inputExpanded: false,  // 输入框展开状态
      thinkingBudget: 1024,
      thinkingBudgetOpen: false,
      temperature: 0.7,
      topP: 0.9,
      maxTokens: 2000,
      frequencyPenalty: 0,
      presencePenalty: 0,
      systemPrompt: '',  // 用户的个人偏好，将附加到内置提示词后
      sidebarOpen: false,
      settingsOpen: false,
      touchStartX: 0,
      touchStartY: 0,
      touchMoveX: 0,
      isSwiping: false,
      theme: 'dark',
      language: 'zh-CN',
      lastModelUsed: '',  // 记录最后使用的实际模型
      lastRoutingReason: ''  // 记录路由选择原因
    };

    const MODELS = {
      "auto": {
        name: "最佳 Auto",
        displayName: { "zh-CN": "最佳", "en": "Auto" },
        provider: "auto",
        supportsThinking: true
      },
      'qwen-flash': {
        name: 'Qwen3Flash',
        provider: 'aliyun',
        supportsThinking: true
      },
      'qwen-plus': {
        name: 'Qwen3-Plus',
        provider: 'aliyun',
        supportsThinking: true
      },
      'qwen-max': {
        name: 'Qwen3-Max',
        provider: 'aliyun',
        supportsThinking: true
      },
      'deepseek-v3': {
        name: 'DeepSeekV3.2',
        provider: 'deepseek',
        supportsThinking: true
      }
    };

    // 内置系统提示词 - 每次请求强制执行
    const BUILT_IN_SYSTEM_PROMPT = `你是RAI助理，由Rick开发。你的任务是提供专业、有用且切合上下文的回应，帮助用户完成写作、创意项目、概念解释、总结等任务。

核心要求：

**简洁性原则**
对简单问题给出简明答案，对复杂问题提供全面解释。使用markdown格式。

**语言风格**
使用友好对话的语气，主动语态配合具体动词。避免机械重复，确保句子之间自然流畅过渡。用通俗语言解释复杂概念，必要时用例子或类比说明。

**适应性**
改写内容时匹配原文语气和风格。生成新内容时根据目标受众调整表达方式。

**专业态度**
即使无法完成请求也保持有帮助的态度，说明限制并提供替代方案。避免使用"我"等第一人称代词，保持客观专业。

**任务后续智能建议**
每次完成用户请求后，分析当前任务的类型和完成状态，预判用户的下一个自然需求，并主动提供一个针对性建议。

**执行标准**
准确理解用户意图，提供可操作的建议，用结构化推理确保回应清晰易懂。禁止输出任何违法侵权内容！

**对话标题自动生成**
在首轮交互完成后，基于用户首个问题和你的回复，生成3-10字的标题。
输出格式：在回复最后强制以特定标记输出
[TITLE]生成的标题[/TITLE]`;

    // 国际化翻译
    const i18n = {
      'zh-CN': {
        'login-title': '欢迎回来',
        'login-subtitle': '登录继续使用 RAI',
        'register-title': '创建账号',
        'register-subtitle': '加入 RAI 开始对话',
        'email-label': '邮箱',
        'password-label': '密码',
        'username-label': '用户名 (可选)',
        'password-placeholder': '至少6位字符',
        'username-placeholder': '您的昵称',
        'login-btn': '登录',
        'register-btn': '注册',
        'no-account': '还没有账号?',
        'has-account': '已有账号?',
        'register-link': '立即注册',
        'login-link': '立即登录',
        'new-chat': '新对话',
        'settings': '设置',
        'logout': '退出',
        'welcome-title': '询问任何问题:D',
        'welcome-subtitle': '可以帮您写作,翻译,构思\n您专属RAI助理',
        'attach': '附件',
        'internet': '联网',
        'reasoning': '推理',
        'thinking-budget': '思考预算',
        'thinking-budget-desc': '控制思考的最大长度',
        'min': '最小',
        'max': '最大',
        'input-placeholder': '输入消息... (Shift+Enter 换行)',
        'appearance': '外观',
        'theme-label': '主题',
        'theme-desc': '选择界面主题',
        'dark-theme': '深色',
        'light-theme': '浅色',
        'language-label': '语言',
        'language-desc': '选择界面语言',
        'generation-params': '生成参数',
        'temperature-desc': '控制回复的随机性 (0-2)',
        'topp-desc': '核采样参数 (0-1)',
        'maxtokens-desc': '最大生成长度 (100-8000)',
        'frequency-desc': '频率惩罚 (仅DeepSeek)',
        'presence-desc': '存在惩罚 (仅DeepSeek)',
        'system-prompt-title': '系统提示词',
        'custom-system-prompt': '自定义系统提示词',
        'system-prompt-desc': '设置AI的角色和行为',
        'system-prompt-placeholder': '例如: 你是一个专业的编程助手,擅长解释代码和解决技术问题...',
        'cancel': '取消',
        'save-settings': '保存设置'
      },
      'en': {
        'login-title': 'Welcome Back',
        'login-subtitle': 'Log in to continue using RAI',
        'register-title': 'Create Account',
        'register-subtitle': 'Join RAI to start chatting',
        'email-label': 'Email',
        'password-label': 'Password',
        'username-label': 'Username (optional)',
        'password-placeholder': 'At least 6 characters',
        'username-placeholder': 'Your nickname',
        'login-btn': 'Login',
        'register-btn': 'Register',
        'no-account': "Don't have an account?",
        'has-account': 'Already have an account?',
        'register-link': 'Sign up now',
        'login-link': 'Log in now',
        'new-chat': 'New Chat',
        'settings': 'Settings',
        'logout': 'Logout',
        'welcome-title': 'How can I help you?',
        'welcome-subtitle': 'I can help you write, translate, and brainstorm\nYour personal RAI assistant',
        'attach': 'Attach',
        'internet': 'Web',
        'reasoning': 'Reasoning',
        'thinking-budget': 'Thinking Budget',
        'thinking-budget-desc': 'Control max thinking length',
        'min': 'Min',
        'max': 'Max',
        'input-placeholder': 'Type a message... (Shift+Enter for new line)',
        'appearance': 'Appearance',
        'theme-label': 'Theme',
        'theme-desc': 'Choose interface theme',
        'dark-theme': 'Dark',
        'light-theme': 'Light',
        'language-label': 'Language',
        'language-desc': 'Choose interface language',
        'generation-params': 'Generation Parameters',
        'temperature-desc': 'Control response randomness (0-2)',
        'topp-desc': 'Nucleus sampling parameter (0-1)',
        'maxtokens-desc': 'Maximum generation length (100-8000)',
        'frequency-desc': 'Frequency penalty (DeepSeek only)',
        'presence-desc': 'Presence penalty (DeepSeek only)',
        'system-prompt-title': 'System Prompt',
        'custom-system-prompt': 'Custom System Prompt',
        'system-prompt-desc': 'Set AI role and behavior',
        'system-prompt-placeholder': 'e.g., You are a professional programming assistant...',
        'cancel': 'Cancel',
        'save-settings': 'Save Settings'
      }
    };

    // 主题切换
    function toggleTheme() {
      const newTheme = appState.theme === 'dark' ? 'light' : 'dark';
      setTheme(newTheme);
    }

    function setTheme(theme) {
      appState.theme = theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('rai_theme', theme);

      // 更新移动端图标
      const mobileIcon = document.getElementById('mobileThemeIcon');
      if (mobileIcon) {
        mobileIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
      }

      // 更新PC侧边栏图标
      const sidebarIcon = document.getElementById('sidebarThemeIcon');
      if (sidebarIcon) {
        sidebarIcon.textContent = theme === 'dark' ? 'light_mode' : 'dark_mode';
      }

      // 更新meta theme-color
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      if (metaTheme) {
        metaTheme.content = theme === 'dark' ? '#0D0D0D' : '#FFFFFF';
      }
    }

    // 语言切换
    function toggleLanguage() {
      const newLang = appState.language === 'zh-CN' ? 'en' : 'zh-CN';
      setLanguage(newLang);
    }

    function setLanguage(lang) {
      appState.language = lang;
      localStorage.setItem('rai_language', lang);

      // 更新HTML lang属性
      document.documentElement.lang = lang;

      // 更新所有翻译文本
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][key]) {
          el.textContent = i18n[lang][key];
        }
      });

      // 更新placeholder
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        if (i18n[lang] && i18n[lang][key]) {
          el.placeholder = i18n[lang][key];
        }
      });

      // 更新移动端语言按钮文本
      const mobileLangText = document.getElementById('mobileLangText');
      if (mobileLangText) {
        mobileLangText.textContent = lang === 'zh-CN' ? 'EN' : '中';
      }

      // 更新PC侧边栏语言按钮文本
      const sidebarLangText = document.getElementById('sidebarLangText');
      if (sidebarLangText) {
        sidebarLangText.textContent = lang === 'zh-CN' ? 'EN' : '中';
      }
    }

    // 初始化主题和语言
    function initThemeAndLanguage() {
      // 加载保存的主题
      const savedTheme = localStorage.getItem('rai_theme') || 'dark';
      setTheme(savedTheme);

      // 加载保存的语言
      const savedLanguage = localStorage.getItem('rai_language') || 'zh-CN';
      setLanguage(savedLanguage);

      // 初始化PC侧边栏按钮状态
      const sidebarThemeIcon = document.getElementById('sidebarThemeIcon');
      if (sidebarThemeIcon) {
        sidebarThemeIcon.textContent = savedTheme === 'dark' ? 'light_mode' : 'dark_mode';
      }

      const sidebarLangText = document.getElementById('sidebarLangText');
      if (sidebarLangText) {
        sidebarLangText.textContent = savedLanguage === 'zh-CN' ? 'EN' : '中';
      }
    }

    // ==================== 输入框展开/收缩交互 ====================
    function expandInput() {
      if (appState.inputExpanded) return;

      const container = document.getElementById('inputContainer');
      const toolbar = container.querySelector('.input-toolbar');

      if (!container) return;

      container.classList.remove('collapsed');
      appState.inputExpanded = true;

      // 动画结束后设置overflow: visible，以便显示下拉菜单
      setTimeout(() => {
        if (appState.inputExpanded && toolbar) {
          toolbar.classList.add('overflow-visible');
        }
      }, 500); // 与CSS transition时间匹配
    }

    function collapseInput() {
      if (!appState.inputExpanded) return;

      const container = document.getElementById('inputContainer');
      const input = document.getElementById('messageInput');
      const toolbar = container.querySelector('.input-toolbar');

      if (!container) return;

      // 如果输入框有内容或正在流式生成，不收缩
      if (input && (input.value.trim() !== '' || appState.isStreaming)) {
        return;
      }

      // 立即隐藏overflow，防止内容溢出
      if (toolbar) {
        toolbar.classList.remove('overflow-visible');
      }

      container.classList.add('collapsed');
      appState.inputExpanded = false;
    }

    function handleInputContainerClick(event) {
      // 点击输入容器时展开
      const target = event.target;

      // 如果点击的是工具栏按钮或下拉菜单，不处理
      if (target.closest('.toolbar-btn') ||
        target.closest('.model-dropdown') ||
        target.closest('.thinking-budget-modal')) {
        return;
      }

      expandInput();

      // 点击容器时，如果输入框未聚焦，强制聚焦
      // 解决 Android "点一下展开，再点一下输入" 的问题
      const input = document.getElementById('messageInput');
      if (input && document.activeElement !== input) {
        // 稍微延迟以等待展开动画开始
        setTimeout(() => input.focus(), 10);
      }
    }

    function autoResizeInput() {
      const input = document.getElementById('messageInput');
      if (!input) return;

      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    }

    function handleInputKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('✅ RAI v0.3 初始化');

      // 初始化主题和语言
      initThemeAndLanguage();

      const token = localStorage.getItem('rai_token');
      if (token) {
        appState.token = token;
        verifyToken();
      }

      loadSettings();
      updateModelControls();
      initSwipeGestures();

      // 修复：改进model dropdown的点击外关闭逻辑
      document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('modelDropdown');
        const customSelect = document.getElementById('modelSelectCustom');

        if (dropdown && customSelect) {
          if (!customSelect.contains(e.target) && !dropdown.contains(e.target)) {
            closeModelDropdown();
          }
        }

        // 修复：改进thinking budget modal的点击外关闭逻辑
        const budgetModal = document.getElementById('thinkingBudgetModal');
        const expandBtn = document.getElementById('thinkingExpandBtn');

        if (budgetModal && expandBtn) {
          if (!budgetModal.contains(e.target) && !expandBtn.contains(e.target)) {
            appState.thinkingBudgetOpen = false;
            budgetModal.style.display = 'none';
            const icon = expandBtn.querySelector('.material-symbols-outlined');
            if (icon) {
              icon.textContent = 'expand_less';
            }
          }
        }

        // 输入框收缩逻辑：点击空白区域时收缩
        const inputContainer = document.getElementById('inputContainer');
        const inputArea = document.querySelector('.input-area');

        if (inputContainer && inputArea) {
          // 检查点击是否在输入区域之外
          if (!inputArea.contains(e.target)) {
            collapseInput();
          }
        }
      });
    });

    // ==================== 自定义模型选择器 ====================
    function toggleModelDropdown() {
      const dropdown = document.getElementById('modelDropdown');
      const customSelect = document.getElementById('modelSelectCustom');

      if (!dropdown || !customSelect) {
        console.error('❌ 模型选择器元素未找到');
        return;
      }

      const isOpen = dropdown.classList.contains('open');

      if (isOpen) {
        closeModelDropdown();
      } else {
        dropdown.classList.add('open');
        customSelect.classList.add('open');
      }
    }

    function closeModelDropdown() {
      const dropdown = document.getElementById('modelDropdown');
      const customSelect = document.getElementById('modelSelectCustom');

      if (dropdown) {
        dropdown.classList.remove('open');
      }

      if (customSelect) {
        customSelect.classList.remove('open');
      }
    }

    // ==================== 工具栏功能 ====================
    function toggleInternet() {
      appState.internetMode = !appState.internetMode;
      updateToolbarUI();
    }

    function toggleThinking() {
      appState.thinkingMode = !appState.thinkingMode;
      updateToolbarUI();
    }

    function handleFileUpload() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.click();
      }
    }

    function handleFileSelected(event) {
      const files = event.target.files;
      if (files && files.length > 0) {
        console.log('文件选择:', files[0].name);
        // 这里可以添加文件上传逻辑
      }
    }

    function updateToolbarUI() {
      const internetBtn = document.getElementById('internetBtn');
      const thinkingBtn = document.getElementById('thinkingBtn');

      if (internetBtn) {
        if (appState.internetMode) {
          internetBtn.classList.add('active');
        } else {
          internetBtn.classList.remove('active');
        }
      }

      if (thinkingBtn) {
        if (appState.thinkingMode) {
          thinkingBtn.classList.add('active');
        } else {
          thinkingBtn.classList.remove('active');
        }
      }
    }

    function updateModelControls() {
      // 根据选择的模型显示/隐藏推理控件
      const thinkingControls = document.getElementById('thinkingControls');
      const selectedModel = appState.selectedModel;

      if (thinkingControls) {
        // DeepSeek模型支持推理模式
        if (selectedModel === 'deepseek-v3') {
          thinkingControls.style.display = 'flex';
        } else {
          thinkingControls.style.display = 'none';
        }
      }

      // 更新工具栏UI状态
      updateToolbarUI();
    }

    // 修复：改进toggleThinkingBudget函数
    function toggleThinkingBudget() {
      appState.thinkingBudgetOpen = !appState.thinkingBudgetOpen;

      const modal = document.getElementById('thinkingBudgetModal');
      const expandBtn = document.getElementById('thinkingExpandBtn');

      if (!modal || !expandBtn) {
        console.warn('⚠️ 思考预算模态框元素未找到');
        return;
      }

      const icon = expandBtn.querySelector('.material-symbols-outlined');

      if (appState.thinkingBudgetOpen) {
        modal.style.display = 'block';
        if (icon) icon.textContent = 'expand_more';
      } else {
        modal.style.display = 'none';
        if (icon) icon.textContent = 'expand_less';
      }
    }

    // 修复：改进updateThinkingBudget函数
    function updateThinkingBudget(value) {
      const numValue = parseInt(value);
      if (!isNaN(numValue)) {
        appState.thinkingBudget = numValue;

        const valueEl = document.getElementById('thinkingBudgetValue');
        if (valueEl) {
          valueEl.textContent = `${value} tokens`;
        }
      }
    }

    // 修复：改进updateToolbarUI函数
    function updateToolbarUI() {
      const thinkingBtn = document.getElementById('thinkingBtn');
      const internetBtn = document.getElementById('internetBtn');

      if (thinkingBtn) {
        if (appState.thinkingMode) {
          thinkingBtn.classList.add('active');
        } else {
          thinkingBtn.classList.remove('active');
        }
      }

      if (internetBtn) {
        if (appState.internetMode) {
          internetBtn.classList.add('active');
        } else {
          internetBtn.classList.remove('active');
        }
      }
    }

    // 修复：改进updateSliderValue函数
    function updateSliderValue(name, value) {
      const spanMap = {
        'temperature': 'temperatureValue',
        'topP': 'topPValue',
        'maxTokens': 'maxTokensValue',
        'frequency': 'frequencyValue',
        'presence': 'presenceValue'
      };

      const spanId = spanMap[name];
      if (spanId) {
        const element = document.getElementById(spanId);
        if (element) {
          element.textContent = value;
        }
      }
    }

    // 修复：改进updateSettingsUI函数，添加null检查
    function updateSettingsUI() {
      const elements = [
        { id: 'temperatureSlider', valueId: 'temperatureValue', value: appState.temperature, format: 1 },
        { id: 'topPSlider', valueId: 'topPValue', value: appState.topP, format: 2 },
        { id: 'maxTokensSlider', valueId: 'maxTokensValue', value: appState.maxTokens, format: 0 },
        { id: 'frequencySlider', valueId: 'frequencyValue', value: appState.frequencyPenalty, format: 1 },
        { id: 'presenceSlider', valueId: 'presenceValue', value: appState.presencePenalty, format: 1 }
      ];

      elements.forEach(({ id, valueId, value, format }) => {
        const slider = document.getElementById(id);
        const valueEl = document.getElementById(valueId);

        if (slider) slider.value = value;
        if (valueEl) {
          valueEl.textContent = format === 0 ? value : value.toFixed(format);
        }
      });

      const systemPromptEl = document.getElementById('systemPrompt');
      if (systemPromptEl) {
        systemPromptEl.value = appState.systemPrompt;
      }
    }

    // 修复：改进updateModelControls函数，添加null检查
    function updateModelControls() {
      const model = MODELS[appState.selectedModel];

      if (!model) {
        console.warn(`⚠️ 未找到模型配置: ${appState.selectedModel}`);
        return;
      }

      const thinkingControls = document.getElementById('thinkingControls');
      const thinkingExpandBtn = document.getElementById('thinkingExpandBtn');

      if (thinkingControls) {
        if (model.supportsThinking) {
          thinkingControls.style.display = 'flex';
        } else {
          thinkingControls.style.display = 'none';
          appState.thinkingMode = false;
          appState.thinkingBudgetOpen = false;
        }
      }

      if (thinkingExpandBtn) {
        if (appState.thinkingMode) {
          thinkingExpandBtn.style.display = 'flex';
        } else {
          thinkingExpandBtn.style.display = 'none';
          appState.thinkingBudgetOpen = false;
          const budgetModal = document.getElementById('thinkingBudgetModal');
          if (budgetModal) {
            budgetModal.style.display = 'none';
          }
        }
      }

      updateToolbarUI();
    }

    // 修复：改进toggleThinking函数
    function toggleThinking() {
      const model = MODELS[appState.selectedModel];

      if (!model || !model.supportsThinking) {
        console.warn('⚠️ 当前模型不支持思考模式');
        return;
      }

      appState.thinkingMode = !appState.thinkingMode;
      updateModelControls();
      updateToolbarUI();
    }

    // 修复：改进toggleInternet函数
    function toggleInternet() {
      appState.internetMode = !appState.internetMode;
      updateToolbarUI();
    }

    // ==================== 设置相关 ====================
    function toggleAdvancedOptions() {
      const content = document.getElementById('advancedOptionsContent');
      const header = document.querySelector('.advanced-options-header');

      if (content && header) {
        content.classList.toggle('expanded');
        header.classList.toggle('expanded');
      }
    }

    // 修复：改进openSettings函数
    function openSettings() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.classList.add('active');
        appState.settingsOpen = true;
        updateSettingsUI();
      }
    }

    // 修复：改进closeSettings函数
    function closeSettings() {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal) {
        settingsModal.classList.remove('active');
        appState.settingsOpen = false;
      }
    }

    // 点击空白处关闭设置
    document.addEventListener('click', (e) => {
      const settingsModal = document.getElementById('settingsModal');
      if (settingsModal && e.target === settingsModal) {
        closeSettings();
      }
    });

    // 移动端键盘适配 - 最简单保守方案
    // 只处理iOS的滚动问题，让Android使用默认行为
    if (window.visualViewport) {
      window.visualViewport.addEventListener('scroll', () => {
        // 防止iOS橡皮筋效果
        window.scrollTo(0, 0);
      });
    }

    function scrollToBottom() {
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }

    // 修复：改进saveSettings函数，添加null检查
    function saveSettings() {
      const temperatureSlider = document.getElementById('temperatureSlider');
      const topPSlider = document.getElementById('topPSlider');
      const maxTokensSlider = document.getElementById('maxTokensSlider');
      const frequencySlider = document.getElementById('frequencySlider');
      const presenceSlider = document.getElementById('presenceSlider');
      const systemPromptEl = document.getElementById('systemPrompt');

      if (!temperatureSlider || !topPSlider || !maxTokensSlider) {
        console.error('❌ 设置表单元素未找到');
        return;
      }

      const temperature = parseFloat(temperatureSlider.value);
      const topP = parseFloat(topPSlider.value);
      const maxTokens = parseInt(maxTokensSlider.value, 10);
      const frequencyPenalty = parseFloat(frequencySlider?.value || 0);
      const presencePenalty = parseFloat(presenceSlider?.value || 0);
      // ✅ 修复：确保systemPrompt正确读取和处理，处理空字符串和null
      const systemPrompt = (systemPromptEl?.value || '').trim();

      if (isNaN(temperature) || isNaN(topP) || isNaN(maxTokens)) {
        console.error('❌ 参数值无效');
        return;
      }

      appState.temperature = temperature;
      appState.topP = topP;
      appState.maxTokens = maxTokens;
      appState.frequencyPenalty = frequencyPenalty;
      appState.presencePenalty = presencePenalty;
      appState.systemPrompt = systemPrompt;  // ✅ 保存trimmed版本

      const settings = {
        temperature,
        topP,
        maxTokens,
        frequencyPenalty,
        presencePenalty,
        systemPrompt
      };
      localStorage.setItem('rai_settings', JSON.stringify(settings));

      // ✅ 修复：同步保存到后端数据库
      if (appState.token) {
        console.log(`📤 正在将设置同步到云端...`);
        console.log(`   系统提示词长度: ${systemPrompt.length}字符`);

        fetch(`${API_BASE}/user/config`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            theme: appState.theme,
            default_model: appState.selectedModel,
            temperature,
            top_p: topP,
            max_tokens: maxTokens,
            frequency_penalty: frequencyPenalty,
            presence_penalty: presencePenalty,
            system_prompt: systemPrompt,  // ✅ 确保发送正确的值
            thinking_mode: appState.thinkingMode ? 1 : 0,
            internet_mode: appState.internetMode ? 1 : 0
          })
        })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              console.log('✅ 云端配置已同步');
            } else {
              console.warn('⚠️ 云端同步失败:', data.error);
            }
          })
          .catch(err => console.error('❌ 保存配置网络错误:', err));
      }

      console.log('✅ 设置已保存本地并同步云端');

      closeSettings();
    }

    // 修复事件处理器中inline onclick处理和事件委托问题，避免undefined引用

    // 修复：改进renderMessages，防止事件处理中的undefined错误
    function renderMessages() {
      const container = document.getElementById('messagesList');
      const welcome = document.getElementById('welcomeScreen');

      if (!container || !welcome) {
        console.error('❌ 消息容器或欢迎屏幕未找到');
        return;
      }

      if (appState.messages.length === 0) {
        showWelcome();
        return;
      }

      welcome.style.display = 'none';
      container.style.display = 'block';
      container.innerHTML = '';

      appState.messages.forEach(msg => {
        const messageDiv = createMessageElement(msg);
        if (messageDiv) {
          container.appendChild(messageDiv);
        }
      });

      scrollToBottom();
    }

    // 修复：改进createMessageElement，添加安全的事件处理
    function createMessageElement(message) {
      if (!message || !message.role) {
        console.warn('⚠️ 无效的消息对象');
        return null;
      }

      const div = document.createElement('div');
      div.className = `message ${message.role}`;

      // 只为用户消息显示头像
      if (message.role === 'user') {
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        const name = appState.user?.username || appState.user?.email || 'U';
        avatar.textContent = name ? name[0].toUpperCase() : 'U';
        div.appendChild(avatar);
      }

      const content = document.createElement('div');
      content.className = 'message-content';

      if (message.reasoning_content && message.reasoning_content !== 'null' && message.reasoning_content.trim() !== '') {
        const thinkingDiv = document.createElement('div');
        thinkingDiv.className = 'thinking-indicator';

        const thinkingId = `thinking-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        const thinkingLabel = appState.language === 'zh-CN' ? '思考过程' : 'Thinking Process';

        const thinkingLabel_el = document.createElement('div');
        thinkingLabel_el.className = 'thinking-label';
        thinkingLabel_el.setAttribute('data-thinking-id', thinkingId);
        thinkingLabel_el.innerHTML = `
          <div class="thinking-label-left">
            <span class="material-symbols-outlined" style="font-size: 16px;">psychology</span>
            <span>${thinkingLabel}</span>
          </div>
          <span class="material-symbols-outlined thinking-expand-icon" id="${thinkingId}-icon">expand_more</span>
        `;

        // 使用事件委托而不是inline onclick
        thinkingLabel_el.addEventListener('click', function () {
          const id = this.getAttribute('data-thinking-id');
          toggleThinkingContent(id);
        });

        const thinkingContent = document.createElement('div');
        thinkingContent.className = 'thinking-content';
        thinkingContent.id = thinkingId;
        thinkingContent.textContent = message.reasoning_content;

        thinkingDiv.appendChild(thinkingLabel_el);
        thinkingDiv.appendChild(thinkingContent);
        content.appendChild(thinkingDiv);
      }

      const textDiv = document.createElement('div');
      textDiv.className = 'message-text';
      // 使用marked渲染Markdown，如果marked未加载则回退到formatMessage
      if (typeof marked !== 'undefined' && marked.parse) {
        textDiv.innerHTML = marked.parse(message.content || '');
      } else {
        textDiv.innerHTML = formatMessage(message.content || '');
      }
      content.appendChild(textDiv);

      // 为AI消息添加元信息和复制按钮
      if (message.role === 'assistant') {
        const metaDiv = document.createElement('div');
        metaDiv.className = 'message-meta';

        // 显示模型信息
        if (message.model) {
          const modelBadge = document.createElement('span');
          modelBadge.className = 'meta-badge';

          // 获取模型显示名称
          let modelName = message.model;
          if (MODELS[message.model]) {
            modelName = MODELS[message.model].name;
          }

          modelBadge.innerHTML = `
            <span class="material-symbols-outlined">smart_toy</span>
            <span>${modelName}</span>
          `;
          metaDiv.appendChild(modelBadge);
        }

        // 显示联网状态
        // 增强判断逻辑：检查 enable_search 或 internet_mode，并处理可能的类型差异（数字/布尔值）
        const isInternet = (message.enable_search === 1 || message.enable_search === true) ||
          (message.internet_mode === 1 || message.internet_mode === true);

        if (isInternet) {
          const internetBadge = document.createElement('span');
          internetBadge.className = 'meta-badge';
          internetBadge.innerHTML = `
            <span class="material-symbols-outlined">language</span>
            <span>${appState.language === 'zh-CN' ? '联网' : 'Web'}</span>
          `;
          metaDiv.appendChild(internetBadge);
        }

        // 显示思考状态
        if (message.reasoning_content && message.reasoning_content !== 'null' && message.reasoning_content.trim() !== '') {
          const thinkingBadge = document.createElement('span');
          thinkingBadge.className = 'meta-badge';
          thinkingBadge.innerHTML = `
            <span class="material-symbols-outlined">psychology</span>
            <span>${appState.language === 'zh-CN' ? '思考' : 'Thinking'}</span>
          `;
          metaDiv.appendChild(thinkingBadge);
        }

        // 添加复制按钮
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-btn';
        copyBtn.title = appState.language === 'zh-CN' ? '复制消息' : 'Copy message';
        copyBtn.innerHTML = `
          <span class="material-symbols-outlined">content_copy</span>
        `;

        // 复制按钮事件
        copyBtn.addEventListener('click', async function () {
          const textToCopy = message.content || '';

          try {
            // 优先使用现代API
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(textToCopy);
              console.log('✅ 复制成功');
            } else {
              // 备用方案：使用传统方法
              const textarea = document.createElement('textarea');
              textarea.value = textToCopy;
              textarea.style.position = 'fixed';
              textarea.style.opacity = '0';
              document.body.appendChild(textarea);
              textarea.select();
              document.execCommand('copy');
              document.body.removeChild(textarea);
              console.log('✅ 复制成功（备用方法）');
            }

            // 更新按钮状态
            copyBtn.classList.add('copied');
            copyBtn.innerHTML = `
              <span class="material-symbols-outlined">check</span>
            `;

            setTimeout(() => {
              copyBtn.classList.remove('copied');
              copyBtn.innerHTML = `
                <span class="material-symbols-outlined">content_copy</span>
              `;
            }, 2000);
          } catch (err) {
            console.error('❌ 复制失败:', err);
            alert(appState.language === 'zh-CN' ? '复制失败' : 'Copy failed');
          }
        });

        metaDiv.appendChild(copyBtn);
        content.appendChild(metaDiv);
      }

      div.appendChild(content);

      return div;
    }

    // 修复：改进openSidebar函数
    function openSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      if (sidebar) {
        sidebar.classList.add('active');
        sidebar.style.transform = '';
      }

      if (overlay) {
        overlay.classList.add('active');
      }

      appState.sidebarOpen = true;
    }

    // 修复：改进closeSidebar函数
    function closeSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobileOverlay');

      if (sidebar) {
        sidebar.classList.remove('active');
        sidebar.style.transform = '';
      }

      if (overlay) {
        overlay.classList.remove('active');
      }

      appState.sidebarOpen = false;
    }

    // 修复：改进toggleSidebar函数
    function toggleSidebar() {
      if (appState.sidebarOpen) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }

    // 修复：改进deleteSession函数
    async function deleteSession(event, sessionId) {
      if (!event) {
        console.warn('⚠️ 事件对象未传递');
        return;
      }

      event.stopPropagation();

      const confirmMsg = appState.language === 'zh-CN' ? '确定要删除这个对话吗?' : 'Delete this conversation?';
      if (!confirm(confirmMsg)) return;

      try {
        const response = await fetch(`${API_BASE}/sessions/${sessionId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        if (appState.currentSession?.id === sessionId) {
          appState.currentSession = null;
          appState.messages = [];
          showWelcome();
        }

        await loadSessions();
      } catch (error) {
        console.error('❌ 删除会话失败:', error);
        alert(appState.language === 'zh-CN' ? '删除失败' : 'Delete failed');
      }
    }

    // 修复：改进renderSessions，使用事件委托处理删除按钮
    function renderSessions() {
      const container = document.getElementById('sessionsContainer');

      if (!container) {
        console.error('❌ 找不到会话容器');
        return;
      }

      container.innerHTML = '';

      if (!appState.sessions || appState.sessions.length === 0) {
        const msg = appState.language === 'zh-CN'
          ? '暂无历史对话<br>点击"新对话"开始聊天'
          : 'No conversations<br>Click "New Chat" to start';
        container.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--text-secondary); font-size: 13px;">${msg}</div>`;
        return;
      }

      appState.sessions.forEach(session => {
        const div = document.createElement('div');
        div.className = `session-item ${session.id === appState.currentSession?.id ? 'active' : ''}`;
        div.setAttribute('data-session-id', session.id);

        div.innerHTML = `
          <div class="session-title">${escapeHtml(session.title || '')}</div>
          <div class="session-preview">${escapeHtml((session.last_message || '').substring(0, 50))}...</div>
          <button class="session-delete-btn" type="button">
            <span class="material-symbols-outlined">close</span>
          </button>
        `;

        // 主项目点击加载会话
        div.addEventListener('click', function (e) {
          if (!e.target.closest('.session-delete-btn')) {
            const sid = this.getAttribute('data-session-id');
            if (sid) loadSession(sid);
          }
        });

        // 删除按钮点击处理
        const deleteBtn = div.querySelector('.session-delete-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function (e) {
            e.stopPropagation();
            const sid = div.getAttribute('data-session-id');
            if (sid) deleteSession(e, sid);
          });
        }

        container.appendChild(div);
      });
    }

    // 修复：改进sendMessage，添加更多的错误处理
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      if (!input) {
        console.error('❌ 消息输入框未找到');
        return;
      }

      const message = input.value.trim();

      if (!message || appState.isStreaming) return;

      if (!appState.currentSession) {
        await createNewSession();
        return;
      }

      input.value = '';
      autoResizeInput();

      const userMsg = {
        role: 'user',
        content: message,
        created_at: new Date().toISOString()
      };
      appState.messages.push(userMsg);
      renderMessages();

      const messages = appState.messages.map(m => ({
        role: m.role,
        content: m.content
      }));

      const sendBtn = document.getElementById('sendBtn');
      const stopBtn = document.getElementById('stopBtn');

      if (sendBtn) sendBtn.style.display = 'none';
      if (stopBtn) stopBtn.style.display = 'flex';

      appState.isStreaming = true;

      const aiMsgDiv = document.createElement('div');
      aiMsgDiv.className = 'message assistant';
      const thinkingLabel = appState.language === 'zh-CN' ? '正在思考...' : 'Thinking...';
      aiMsgDiv.innerHTML = `
        <div class="message-avatar">
          <span class="material-symbols-outlined">smart_toy</span>
        </div>
        <div class="message-content">
          <div class="thinking-indicator" id="thinkingIndicator" style="display: none;">
            <div class="thinking-label" onclick="try { toggleThinkingContent('thinkingContent'); } catch(e) { console.error('Error in toggleThinkingContent:', e); }">
              <div class="thinking-label-left">
                <span class="material-symbols-outlined" style="font-size: 16px;">psychology</span>
                <span>${thinkingLabel}</span>
              </div>
              <span class="material-symbols-outlined thinking-expand-icon" id="thinkingContent-icon">expand_more</span>
            </div>
            <div class="thinking-content" id="thinkingContent"></div>
          </div>
          <div class="message-text" id="streamingContent"></div>
        </div>
      `;

      const messagesList = document.getElementById('messagesList');
      if (messagesList) {
        messagesList.appendChild(aiMsgDiv);
      }

      scrollToBottom();

      try {
        const response = await fetch(`${API_BASE}/chat/stream`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            sessionId: appState.currentSession.id,
            messages: messages,
            model: appState.selectedModel,
            thinkingMode: appState.thinkingMode,
            thinkingBudget: appState.thinkingBudget,
            internetMode: appState.internetMode,
            temperature: appState.temperature,
            top_p: appState.topP,
            max_tokens: appState.maxTokens,
            frequency_penalty: appState.frequencyPenalty,
            presence_penalty: appState.presencePenalty,
            systemPrompt: appState.systemPrompt.trim()
              ? `${BUILT_IN_SYSTEM_PROMPT}\n\n以下是用户个人偏好，请参考：\n${appState.systemPrompt}`
              : BUILT_IN_SYSTEM_PROMPT
          })
        });

        const modelUsed = response.headers.get('X-Model-Used');
        const routingReason = response.headers.get('X-Model-Reason');

        if (modelUsed) {
          appState.lastModelUsed = modelUsed;
          appState.lastRoutingReason = routingReason || '';
          console.log(`✅ 实际使用模型: ${modelUsed}`);
          console.log(`   选择原因: ${appState.lastRoutingReason}`);

          if (appState.selectedModel === 'auto') {
            showModelRoutingInfo(modelUsed, appState.lastRoutingReason);
          }
        }

        appState.currentRequestId = response.headers.get('X-Request-ID');

        if (!response.body) {
          throw new Error('响应体为空');
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullContent = '';
        let reasoningContent = '';

        const streamingEl = document.getElementById('streamingContent');
        const thinkingEl = document.getElementById('thinkingContent');
        const thinkingIndicator = document.getElementById('thinkingIndicator');

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed || !trimmed.startsWith('data: ')) continue;

            const data = trimmed.slice(6);
            if (data === '[DONE]') continue;

            try {
              const parsed = JSON.parse(data);

              if (parsed.type === 'reasoning') {
                if (thinkingIndicator) thinkingIndicator.style.display = 'block';
                reasoningContent += parsed.content;
                if (thinkingEl) thinkingEl.textContent = reasoningContent;
                scrollToBottom();
              }
              else if (parsed.type === 'content') {
                fullContent += parsed.content;
                if (streamingEl) {
                  // 移除标题标记，防止显示给用户
                  const contentToDisplay = fullContent.replace(/\[TITLE\].*?\[\/TITLE\]/g, '').trim();
                  // 使用marked渲染Markdown，如果available
                  if (typeof marked !== 'undefined' && marked.parse) {
                    streamingEl.innerHTML = marked.parse(contentToDisplay);
                  } else {
                    streamingEl.innerHTML = formatMessage(contentToDisplay);
                  }
                }
                scrollToBottom();
              }
              else if (parsed.type === 'title') {
                // 处理标题更新
                if (parsed.title && appState.currentSession) {
                  appState.currentSession.title = parsed.title;
                  console.log(`✅ 会话标题已更新: "${parsed.title}"`);
                  // 异步刷新侧边栏显示
                  loadSessions().catch(err => console.error('刷新会话列表失败:', err));
                }
              }
              else if (parsed.type === 'done') {
                console.log('✅ 流式响应完成');
              }
              else if (parsed.type === 'cancelled') {
                console.log('⚠️ 响应已取消');
                break;
              }
              else if (parsed.type === 'error') {
                alert((appState.language === 'zh-CN' ? 'AI服务错误: ' : 'AI Service Error: ') + (parsed.error || '未知错误'));
                break;
              }
            } catch (e) {
              console.error('⚠️ 解析响应错误:', e);
            }
          }
        }

        // 移除标题标记后再保存到appState
        const cleanContent = fullContent.replace(/\[TITLE\].*?\[\/TITLE\]/g, '').trim();

        const aiMsg = {
          role: 'assistant',
          content: cleanContent,
          reasoning_content: reasoningContent || null,
          model: appState.lastModelUsed || appState.selectedModel,
          enable_search: appState.internetMode,
          internet_mode: appState.internetMode,
          created_at: new Date().toISOString()
        };
        appState.messages.push(aiMsg);

        // 重新渲染所有消息以显示元信息和复制按钮
        renderMessages();

        await loadSessions();

      } catch (error) {
        console.error('❌ 发送消息错误:', error);
        alert(appState.language === 'zh-CN' ? '发送失败,请检查网络连接' : 'Send failed, check network');
      } finally {
        if (sendBtn) sendBtn.style.display = 'flex';
        if (stopBtn) stopBtn.style.display = 'none';
        appState.isStreaming = false;
        appState.currentRequestId = null;
      }
    }

    // 修复：改进stopGeneration函数
    async function stopGeneration() {
      if (!appState.currentRequestId) {
        console.warn('⚠️ 没有活跃的请求');
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/chat/stop`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            requestId: appState.currentRequestId
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        console.log('🛑 已发送停止请求');
      } catch (error) {
        console.error('❌ 停止失败:', error);
      }
    }

    // 修复：改进handleInputKeydown
    function handleInputKeydown(event) {
      if (!event) return;

      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // 修复：改进autoResizeInput
    function autoResizeInput() {
      const input = document.getElementById('messageInput');
      if (!input) return;

      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 200) + 'px';
    }

    // 修复：改进handleFileUpload
    function handleFileUpload() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput) {
        console.error('❌ 文件输入框未找到');
        return;
      }
      // 清除之前的值，确保可以重复选择同一文件
      fileInput.value = '';
      fileInput.click();
    }

    // 修复：改进handleFileSelected - 添加完整的错误处理
    function handleFileSelected(event) {
      if (!event || !event.target) {
        console.error('❌ 事件对象无效');
        return;
      }

      const files = event.target.files;
      if (!files || files.length === 0) {
        console.warn('⚠️ 未选择文件');
        return;
      }

      const file = files[0];
      console.log(`✅ 选中文件: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

      // 文件类型验证
      const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp', 'application/pdf', 'text/plain'];
      if (!allowedTypes.includes(file.type)) {
        const msg = appState.language === 'zh-CN'
          ? `不支持的文件类型: ${file.type}\n支持的类型: 图片(JPG, PNG, GIF, WebP), PDF, 文本文件`
          : `Unsupported file type: ${file.type}\nSupported: Images (JPG, PNG, GIF, WebP), PDF, Text`;
        alert(msg);
        return;
      }

      // 文件大小验证 (最大10MB)
      const maxSize = 10 * 1024 * 1024;
      if (file.size > maxSize) {
        const msg = appState.language === 'zh-CN'
          ? `文件过大: ${(file.size / 1024 / 1024).toFixed(2)} MB\n最大支持: 10 MB`
          : `File too large: ${(file.size / 1024 / 1024).toFixed(2)} MB\nMax size: 10 MB`;
        alert(msg);
        return;
      }

      // TODO: 实现文件上传到服务器的逻辑
      // 这里应该将文件上传到后端，并获取URL或ID
      // 然后可以在发送消息时附加文件信息
      console.log('📎 文件已准备，等待上传实现');

      // 临时提示用户
      const msg = appState.language === 'zh-CN'
        ? `文件 "${file.name}" 已选择\n注意: 文件上传功能尚未完全实现`
        : `File "${file.name}" selected\nNote: File upload not fully implemented yet`;
      alert(msg);
    }

    // 修复：改进showModelRoutingInfo
    function showModelRoutingInfo(modelUsed, reason) {
      console.log(`🤖 [Auto路由] 使用模型: ${modelUsed}, 原因: ${reason}`);
    }

    // 修复：改进handleViewportResize
    function handleViewportResize() {
      // 处理viewport变化时的布局调整
      console.log('📱 Viewport已调整大小');
    }

    // ==================== 认证相关 ====================
    async function handleLogin(event) {
      event.preventDefault();

      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      const loginBtn = document.getElementById('loginBtn');
      const errorEl = document.getElementById('loginError');

      loginBtn.disabled = true;
      loginBtn.innerHTML = '<span class="loading"></span> ' + (appState.language === 'zh-CN' ? '登录中...' : 'Logging in...');
      errorEl.classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (data.success) {
          appState.token = data.token;
          appState.user = data.user;
          localStorage.setItem('rai_token', data.token);

          showApp();
          await loadUserData();
        } else {
          showError(errorEl, data.error || (appState.language === 'zh-CN' ? '登录失败' : 'Login failed'));
        }
      } catch (error) {
        showError(errorEl, appState.language === 'zh-CN' ? '网络错误,请检查服务器连接' : 'Network error');
        console.error('❌ 登录错误:', error);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = appState.language === 'zh-CN' ? '登录' : 'Login';
      }
    }

    async function handleRegister(event) {
      event.preventDefault();

      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const username = document.getElementById('registerUsername').value;
      const registerBtn = document.getElementById('registerBtn');
      const errorEl = document.getElementById('registerError');

      registerBtn.disabled = true;
      registerBtn.innerHTML = '<span class="loading"></span> ' + (appState.language === 'zh-CN' ? '注册中...' : 'Registering...');
      errorEl.classList.remove('show');

      try {
        const response = await fetch(`${API_BASE}/auth/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password, username })
        });

        const data = await response.json();

        if (data.success) {
          appState.token = data.token;
          appState.user = data.user;
          localStorage.setItem('rai_token', data.token);

          showApp();
          await loadUserData();
        } else {
          showError(errorEl, data.error || (appState.language === 'zh-CN' ? '注册失败' : 'Registration failed'));
        }
      } catch (error) {
        showError(errorEl, appState.language === 'zh-CN' ? '网络错误,请检查服务器连接' : 'Network error');
        console.error('❌ 注册错误:', error);
      } finally {
        registerBtn.disabled = false;
        registerBtn.textContent = appState.language === 'zh-CN' ? '注册' : 'Register';
      }
    }

    async function verifyToken() {
      try {
        const response = await fetch(`${API_BASE}/auth/verify`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        const data = await response.json();

        if (data.success) {
          appState.user = data.user;
          showApp();
          await loadUserData();
        } else {
          localStorage.removeItem('rai_token');
          appState.token = null;
        }
      } catch (error) {
        console.error('❌ 验证token失败:', error);
        localStorage.removeItem('rai_token');
        appState.token = null;
      }
    }

    function handleLogout() {
      const confirmMsg = appState.language === 'zh-CN' ? '确定要退出登录吗?' : 'Are you sure you want to logout?';
      if (confirm(confirmMsg)) {
        localStorage.removeItem('rai_token');
        appState.token = null;
        appState.user = null;
        appState.sessions = [];
        appState.currentSession = null;

        document.getElementById('appContainer').style.display = 'none';
        document.getElementById('authContainer').classList.add('active');
      }
    }

    function switchToRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
      document.getElementById('loginError').classList.remove('show');
    }

    function switchToLogin() {
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('registerError').classList.remove('show');
    }

    function showApp() {
      document.getElementById('authContainer').classList.remove('active');
      document.getElementById('appContainer').style.display = 'flex';
    }

    function showError(element, message) {
      element.textContent = message;
      element.classList.add('show');
    }

    async function loadUserData() {
      try {
        console.log('📥 加载用户数据...');

        const profileResponse = await fetch(`${API_BASE}/user/profile`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!profileResponse.ok) {
          throw new Error(`HTTP ${profileResponse.status}`);
        }

        const profile = await profileResponse.json();

        const realEmail = appState.user?.email || profile.email || '';
        const displayName = appState.user?.username || profile.username || (realEmail ? realEmail.split('@')[0] : '用户');

        console.log('📧 显示邮箱:', realEmail);

        document.getElementById('userName').textContent = displayName;
        document.getElementById('userEmail').textContent = realEmail;
        document.getElementById('userAvatar').textContent = realEmail ? realEmail[0].toUpperCase() : 'U';

        appState.user = {
          username: displayName,
          email: realEmail
        };

        // ✅ 修复：检查profile对象的所有必需字段
        if (profile && typeof profile === 'object') {
          if (profile.temperature !== undefined) appState.temperature = parseFloat(profile.temperature) || 0.7;
          if (profile.top_p !== undefined) appState.topP = parseFloat(profile.top_p) || 0.9;
          if (profile.max_tokens !== undefined) appState.maxTokens = parseInt(profile.max_tokens, 10) || 2000;
          if (profile.frequency_penalty !== undefined) appState.frequencyPenalty = parseFloat(profile.frequency_penalty) || 0;
          if (profile.presence_penalty !== undefined) appState.presencePenalty = parseFloat(profile.presence_penalty) || 0;
          // ✅ 关键修复：正确处理system_prompt，确保始终是字符串
          if (profile.system_prompt !== undefined) {
            appState.systemPrompt = (profile.system_prompt || '');
            console.log(`✅ 加载系统提示词: ${appState.systemPrompt.length}字符`);
          }
          if (profile.thinking_mode !== undefined) appState.thinkingMode = profile.thinking_mode === 1 || profile.thinking_mode === true;
          if (profile.internet_mode !== undefined) appState.internetMode = profile.internet_mode === 1 || profile.internet_mode === true;

          updateSettingsUI();
          updateToolbarUI();
          console.log('✅ 用户配置已加载到UI');
        } else {
          console.warn('⚠️ profile对象格式不正确');
        }

        console.log('📋 加载历史会话...');
        await loadSessions();

        if (appState.sessions && appState.sessions.length > 0) {
          console.log(`✅ 找到 ${appState.sessions.length} 个历史会话,自动加载最新会话`);
          await loadSession(appState.sessions[0].id);
        } else {
          console.log('ℹ️ 无历史会话,显示欢迎界面');
          showWelcome();
        }

        console.log('✅ 用户数据加载完成');
      } catch (error) {
        console.error('❌ 加载用户数据失败:', error);
        if (error.message.includes('500')) {
          console.warn('⚠️ 用户配置加载失败,使用默认配置继续');
          showWelcome();
        } else {
          alert((appState.language === 'zh-CN' ? '加载失败: ' : 'Load failed: ') + error.message);
        }
      }
    }

    async function loadSessions() {
      try {
        const response = await fetch(`${API_BASE}/sessions`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const sessions = await response.json();
        appState.sessions = Array.isArray(sessions) ? sessions : [];

        console.log(`✅ 成功加载 ${appState.sessions.length} 个会话`);
        renderSessions();

      } catch (error) {
        console.error('❌ 加载会话失败:', error);
        appState.sessions = [];
        renderSessions();
      }
    }

    function showWelcome() {
      document.getElementById('welcomeScreen').style.display = 'flex';
      document.getElementById('messagesList').style.display = 'none';
    }

    function scrollToBottom() {
      const container = document.getElementById('chatContainer');
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
      }, 100);
    }

    async function createNewSession() {
      try {
        const response = await fetch(`${API_BASE}/sessions`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${appState.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: appState.language === 'zh-CN' ? '新对话' : 'New Chat',
            model: appState.selectedModel || 'auto'  // 默认为auto或当前选择的模型
          })
        });

        const data = await response.json();

        if (data.success) {
          await loadSessions();
          await loadSession(data.sessionId);

          // 移除移动端自动弹出侧边栏
          // if (window.innerWidth <= 768) {
          //   toggleSidebar();
          // }
        }
      } catch (error) {
        console.error('❌ 创建会话失败:', error);
        alert(appState.language === 'zh-CN' ? '创建对话失败' : 'Failed to create chat');
      }
    }

    async function loadSession(sessionId) {
      try {
        console.log('📖 加载会话:', sessionId);

        const response = await fetch(`${API_BASE}/sessions/${sessionId}/messages`, {
          headers: { 'Authorization': `Bearer ${appState.token}` }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const messages = await response.json();

        appState.currentSession = appState.sessions.find(s => s.id === sessionId);
        appState.messages = Array.isArray(messages) ? messages : [];

        console.log(`✅ 加载到 ${messages.length} 条消息`);

        renderMessages();
        renderSessions();

        // 移除移动端自动弹出侧边栏
        // if (window.innerWidth <= 768) {
        //   toggleSidebar();
        // }

      } catch (error) {
        console.error('❌ 加载消息失败:', error);
        alert(appState.language === 'zh-CN' ? '加载对话失败' : 'Failed to load chat');
      }
    }

    // ==================== 侧边栏滑动手势 ====================
    function initSwipeGestures() {
      const mainContent = document.querySelector('.main-content');
      const sidebar = document.getElementById('sidebar');

      if (!mainContent || !sidebar) return;

      mainContent.addEventListener('touchstart', (e) => {
        appState.touchStartX = e.touches[0].clientX;
        appState.touchStartY = e.touches[0].clientY;
        appState.isSwiping = false;
      }, { passive: true });

      mainContent.addEventListener('touchmove', (e) => {
        if (!appState.touchStartX) return;

        appState.touchMoveX = e.touches[0].clientX;
        const touchMoveY = e.touches[0].clientY;

        const deltaX = appState.touchMoveX - appState.touchStartX;
        const deltaY = Math.abs(touchMoveY - appState.touchStartY);

        if (Math.abs(deltaX) > 30 && Math.abs(deltaX) > deltaY * 2) {
          appState.isSwiping = true;

          if (deltaX > 0 && appState.touchStartX < 50 && !appState.sidebarOpen) {
            const translateX = Math.min(deltaX, sidebar.offsetWidth);
            sidebar.style.transform = `translateX(calc(-100% + ${translateX}px))`;
          }
          else if (deltaX < 0 && appState.sidebarOpen) {
            const translateX = Math.max(deltaX, -sidebar.offsetWidth);
            sidebar.style.transform = `translateX(${translateX}px)`;
          }
        }
      }, { passive: true });

      mainContent.addEventListener('touchend', () => {
        if (!appState.isSwiping) {
          appState.touchStartX = 0;
          return;
        }

        const deltaX = appState.touchMoveX - appState.touchStartX;
        const threshold = sidebar.offsetWidth / 3;

        if (!appState.sidebarOpen && deltaX > threshold) {
          openSidebar();
        } else if (appState.sidebarOpen && deltaX < -threshold) {
          closeSidebar();
        } else {
          sidebar.style.transform = '';
        }

        appState.touchStartX = 0;
        appState.touchMoveX = 0;
        appState.isSwiping = false;
      }, { passive: true });
    }

    function selectModel(value, displayName) {
      appState.selectedModel = value;

      document.getElementById('selectedModelText').textContent = displayName;

      document.querySelectorAll('.model-option').forEach(option => {
        option.classList.remove('selected');
      });

      // 修复：直接通过data-value属性查找对应的option
      const targetOption = document.querySelector(`.model-option[data-value="${value}"]`);
      if (targetOption) {
        targetOption.classList.add('selected');
      }

      closeModelDropdown();
      updateModelControls();
    }

    // 修复：添加null检查和安全的DOM操作
    function toggleThinkingContent(id) {
      if (!id) return;

      const content = document.getElementById(id);
      const icon = document.getElementById(`${id}-icon`);

      if (!content || !icon) {
        console.warn(`⚠️ 找不到元素: ${id}`);
        return;
      }

      const expanded = content.classList.toggle('expanded');
      if (expanded) {
        icon.textContent = 'expand_less';
      } else {
        icon.textContent = 'expand_more';
      }
    }

    function formatMessage(text) {
      // 简单转义与换行处理，考虑插入代码块渲染等
      if (!text) return '';

      let escaped = text.replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      // 保留换行
      escaped = escaped.replace(/\n/g, '<br>');

      return escaped;
    }

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (m) {
        return {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[m];
      });
    }

    function loadSettings() {
      // 从本地存储加载用户设置（如果存在）
      const savedSettings = localStorage.getItem('rai_settings');
      if (savedSettings) {
        try {
          const settings = JSON.parse(savedSettings);
          if (settings.temperature !== undefined) appState.temperature = settings.temperature;
          if (settings.topP !== undefined) appState.topP = settings.topP;
          if (settings.maxTokens !== undefined) appState.maxTokens = settings.maxTokens;
          if (settings.frequencyPenalty !== undefined) appState.frequencyPenalty = settings.frequencyPenalty;
          if (settings.presencePenalty !== undefined) appState.presencePenalty = settings.presencePenalty;
          if (settings.systemPrompt !== undefined) appState.systemPrompt = settings.systemPrompt;
          console.log('✅ 从本地存储加载设置成功');
        } catch (e) {
          console.warn('⚠️ 解析本地设置失败:', e);
        }
      }
    }

    // 初始化完毕后调用
    if (document.readyState !== 'loading') {
      updateModelControls();
    } else {
      document.addEventListener('DOMContentLoaded', updateModelControls);
    }

    // ==================== 移动端键盘处理器 (iOS VisualViewport 修复版) ====================
    class MobileKeyboardHandler {
      constructor(options = {}) {
        this.options = {
          scrollThreshold: options.scrollThreshold || 0.85,
          iosDelay: options.iosDelay || 0,
          androidDelay: options.androidDelay || 300,
          debug: options.debug || false,
          ...options
        };

        this.isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        this.isAndroid = /Android/i.test(navigator.userAgent);
        this.isMobile = this.isIOS || this.isAndroid;

        this.activeInput = null;
        this.keyboardOpen = false;
        this.visualViewport = window.visualViewport;
        this.inputContainer = document.getElementById('inputContainer');

        // 绑定方法
        this.handleViewportChange = this.handleViewportChange.bind(this);
        this.handleFocusIn = this.handleFocusIn.bind(this);
        this.handleFocusOut = this.handleFocusOut.bind(this);
        this.resetPosition = this.resetPosition.bind(this);

        if (this.isMobile) {
          this.init();
        }
      }

      log(...args) {
        if (this.options.debug) console.log('[MobileKeyboard]', ...args);
      }

      init() {
        // 1. VisualViewport 监听 (iOS 核心修复)
        if (this.visualViewport) {
          if (this.isIOS) {
            // iOS: 必须监听 resize 和 scroll 来实时调整位置
            this.visualViewport.addEventListener('resize', this.handleViewportChange);
            this.visualViewport.addEventListener('scroll', this.handleViewportChange);
          } else {
            // Android: 仅监听 resize 用于检测键盘
            this.visualViewport.addEventListener('resize', this.handleViewportChange);
          }
        }

        // 2. Focus 监听
        this.setupFocusListeners();

        // 3. 平台特定修复
        if (this.isAndroid) this.applyAndroidFixes();
        if (this.isIOS) this.applyIOSFixes();
      }

      handleViewportChange() {
        if (!this.activeInput && !this.keyboardOpen) return;

        // iOS 专用定位逻辑
        if (this.isIOS && this.inputContainer) {
          requestAnimationFrame(() => {
            const viewport = this.visualViewport;
            const layoutHeight = window.innerHeight;
            const visualHeight = viewport.height;
            const visualTop = viewport.offsetTop;

            // 计算偏移量：布局高度 - (视觉视口高度 + 视觉视口顶部偏移)
            // 这代表了键盘（或视口底部被遮挡区域）的高度
            // 注意：Math.max(0, ...) 防止负值
            const offset = Math.max(0, layoutHeight - visualHeight - visualTop);

            // 应用位移，将输入框抬起
            // 只有当偏移量显著（>10px）时才应用，避免微小抖动
            if (offset > 10) {
              this.inputContainer.style.transform = `translateY(-${offset}px)`;
              this.inputContainer.style.transition = 'none'; // 禁用过渡以实现实时跟随
              this.keyboardOpen = true;
            } else {
              this.resetPosition();
            }

            this.log('iOS Adjust:', { layoutHeight, visualHeight, visualTop, offset });
          });
        }

        // Android 逻辑 (保持不变)
        if (this.isAndroid) {
          // ... Android existing logic if needed, mostly handled by resize ...
          const currentHeight = this.visualViewport.height;
          const keyboardHeight = window.innerHeight - currentHeight;
          this.keyboardOpen = keyboardHeight > 150;
          if (this.keyboardOpen) {
            setTimeout(() => this.adjustAndroidPosition(), 100);
          }
        }
      }

      resetPosition() {
        if (this.inputContainer) {
          this.inputContainer.style.transform = '';
          this.inputContainer.style.transition = ''; // 恢复 CSS 定义的过渡
        }
        this.keyboardOpen = false;
      }

      adjustAndroidPosition() {
        if (!this.activeInput) return;
        const inputRect = this.activeInput.getBoundingClientRect();
        const viewportTop = this.visualViewport ? this.visualViewport.offsetTop : 0;
        const viewportHeight = this.visualViewport ? this.visualViewport.height : window.innerHeight;
        const inputBottomRelative = inputRect.bottom - viewportTop;
        const threshold = viewportHeight * 0.85;

        if (inputBottomRelative > threshold) {
          const scrollAmount = inputBottomRelative - threshold + 20;
          if (scrollAmount > 0) {
            window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
          }
        }
      }

      setupFocusListeners() {
        document.addEventListener('focusin', this.handleFocusIn);
        document.addEventListener('focusout', this.handleFocusOut);
      }

      handleFocusIn(event) {
        const target = event.target;
        if (!this.isInputElement(target)) return;

        this.activeInput = target;
        this.keyboardOpen = true;

        if (window.expandInput && !window.appState?.inputExpanded) {
          window.expandInput();
        }

        // iOS: 立即触发一次位置更新
        if (this.isIOS) {
          setTimeout(() => this.handleViewportChange(), 100);
        }

        // Android: 滚动
        if (this.isAndroid) {
          setTimeout(() => {
            target.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }

      handleFocusOut(event) {
        if (event.target === this.activeInput) {
          this.activeInput = null;
          // 延迟重置，防止焦点切换时的闪烁
          setTimeout(() => {
            if (!this.activeInput) this.resetPosition();
          }, 100);
        }
      }

      applyAndroidFixes() {
        const container = document.getElementById('inputContainer');
        if (container) {
          container.addEventListener('click', (e) => {
            const input = document.getElementById('messageInput');
            if (input && e.target !== input && !e.target.closest('button')) {
              setTimeout(() => input.focus(), 10);
            }
          });
        }
      }

      applyIOSFixes() {
        document.addEventListener('touchstart', (e) => {
          if (e.touches.length > 1) e.preventDefault();
        }, { passive: false });
      }

      isInputElement(element) {
        return element.tagName === 'TEXTAREA' || (element.tagName === 'INPUT' && element.type === 'text');
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      window.mobileKeyboardHandler = new MobileKeyboardHandler({
        debug: false
      });


    });
  </script>
</body>

</html>
