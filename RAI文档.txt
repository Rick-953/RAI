================================================================================
                           RAI 项目文档 v0.5
                       (带智能模型路由版本)
================================================================================

生成日期: 2025-12-05
项目类型: AI 聊天助手Web应用
技术栈: HTML + CSS + JavaScript (前端) / Node.js + Express + SQLite (后端)

================================================================================
                           一、目前已有功能
================================================================================

【用户系统】
  ✓ 用户注册/登录 (邮箱 + 密码)
  ✓ JWT 令牌认证 (30天有效期)
  ✓ 用户头像上传和更新
  ✓ 设备指纹记录
  ✓ 登录限流保护 (15分钟内最多20次)

【会话管理】
  ✓ 新建对话
  ✓ 对话列表 (侧边栏显示)
  ✓ 对话历史记录
  ✓ 删除对话
  ✓ 对话标题自动生成和更新
  ✓ 会话搜索功能

【AI聊天核心】
  ✓ 流式响应 (SSE) - 打字机效果输出
  ✓ Markdown 渲染支持
  ✓ 数学公式渲染 (KaTeX支持 LaTeX语法)
  ✓ 代码块高亮显示
  ✓ 消息复制功能
  ✓ 停止生成功能

【智能模型路由系统】★★★ 核心特色功能 ★★★
  ✓ Auto模式 - 根据问题复杂度自动选择模型
  ✓ 五维度复杂度评估:
      - 输入长度评估
      - 代码检测 (识别编程语言、代码特征)
      - 数学公式检测
      - 推理复杂度分析
      - 语言混合度分析
  ✓ 关键词触发机制 (情绪词/专业词汇/复杂值词)
  ✓ 预设答案快速通道 (常见问候语极速响应)

【多模型支持】
  ✓ 阿里云通义千问:
      - qwen-flash (极速模式)
      - qwen-plus (智能模式)
      - qwen-max (专家模式)
  ✓ DeepSeek:
      - deepseek-v3 (标准对话)
      - deepseek-reasoner (思考模式)
      - deepseek-v3.2-speciale (特殊版，仅支持思考模式)

【联网搜索功能】
  ✓ Tavily API 搜索集成
  ✓ 阿里云原生联网搜索 (enable_search)
  ✓ 搜索结果自动注入到对话上下文
  ✓ 联网模式一键开关

【思考模式 (Chain of Thought)】
  ✓ DeepSeek 思考模式 (reasoning_content)
  ✓ 阿里云思考模式 (enable_thinking)
  ✓ 思考预算控制 (thinking_budget)
  ✓ 思考过程可视化 (折叠/展开)
  ✓ 思考过程逐句显示动画

【用户配置】
  ✓ 主题切换 (深色/浅色)
  ✓ 默认模型设置
  ✓ 温度参数 (temperature)
  ✓ Top-P 参数
  ✓ 最大输出长度 (max_tokens)
  ✓ 频率惩罚 (frequency_penalty)
  ✓ 存在惩罚 (presence_penalty)
  ✓ 自定义系统提示词
  ✓ 联网模式默认开启
  ✓ 思考模式开关

【UI/UX特性】
  ✓ 响应式设计 (PC/移动端适配)
  ✓ 侧边栏收缩展开
  ✓ 欢迎页面带动画效果 (土星图标浮动动画)
  ✓ 标题金属光泽动画
  ✓ 消息滑入动画
  ✓ 流式输出模糊渐入动画
  ✓ AI头像呼吸/闪烁动画
  ✓ 快捷操作卡片
  ✓ 工具栏按钮悬浮提示
  ✓ 中英文双语支持

【空间管理 (RAG相关)】
  ✓ 空间创建和管理
  ✓ 文档上传功能
  ✓ 空间切换
  ✓ 空间文档列表

【安全特性】
  ✓ API限流 (每分钟100次)
  ✓ 密码加密存储 (bcrypt)
  ✓ 请求取消机制
  ✓ 优雅退出处理

================================================================================
                        二、建议添加的功能
================================================================================

【高优先级】

  1. 图片/文件分析能力
     - 支持上传图片并让AI分析
     - 支持PDF文档内容提取和对话
     - 多模态模型集成 (如 GPT-4V, Qwen-VL)

  2. 对话导出功能
     - 导出为 Markdown 文件
     - 导出为 PDF
     - 导出为纯文本

  3. 对话分享功能
     - 生成分享链接
     - 设置分享有效期
     - 访问权限控制

  4. 语音输入/输出
     - 语音转文字 (STT)
     - 文字转语音 (TTS)
     - 语音对话模式

  5. 消息编辑和重新生成
     - 编辑历史消息
     - 重新生成AI回复
     - 分支对话支持

【中优先级】

  6. 插件系统
     - 代码执行插件
     - 图表生成插件
     - 天气/新闻等实用插件

  7. 快捷指令/提示词模板
     - 预设常用提示词
     - 自定义提示词库
     - 一键使用模板

  8. 对话标签和分类
     - 给对话添加标签
     - 按标签筛选对话
     - 对话分组管理

  9. 更多模型接入
     - OpenAI GPT-4/4o
     - Claude 3.5 Sonnet
     - Google Gemini
     - 本地LLM (Ollama/LM Studio)

  10. 使用统计和分析
      - Token 使用量统计
      - 费用估算
      - 对话统计图表

【低优先级】

  11. 移动端应用
      - PWA 支持 (已部分支持)
      - 原生移动APP封装

  12. 团队协作功能
      - 多用户共享对话
      - 团队空间
      - 权限管理

  13. 自定义主题
      - 更多配色方案
      - 自定义字体
      - 界面布局自定义

  14. 历史消息搜索
      - 全文搜索对话内容
      - 按日期范围筛选
      - 高级搜索过滤器

  15. 快捷键支持
      - 键盘快捷键定义
      - Vim 模式（高级用户）

================================================================================
                        三、需要改进的地方
================================================================================

【代码结构】

  1. 代码拆分和模块化
     - 当前 index.html 有 7389 行，应拆分:
       - CSS 提取到独立文件
       - JavaScript 拆分为多个模块
       - 组件化设计
     - server.js 有 1854 行，应拆分:
       - 路由按功能分离 (auth, chat, session, user)
       - 智能路由引擎独立模块
       - 工具函数独立模块

  2. TypeScript 迁移
     - 增加类型检查
     - 提高代码可维护性
     - 更好的IDE支持

【性能优化】

  3. 前端性能
     - 首屏加载优化 (代码分割)
     - 图片/资源懒加载
     - CSS 关键路径优化
     - 缓存策略优化

  4. 后端性能
     - 数据库查询优化 (添加索引)
     - 连接池管理
     - 响应压缩 (gzip)
     - 静态资源CDN

【用户体验改进】

  5. 错误处理增强
     - 更友好的错误提示
     - 网络断开自动重连
     - 请求失败自动重试

  6. 加载状态优化
     - 骨架屏加载
     - 更细致的加载进度
     - 离线状态提示

  7. 输入体验
     - 输入框自动聚焦
     - 更智能的文本换行
     - 富文本编辑器 (可选)

  8. 移动端体验
     - 手势操作支持
     - 虚拟键盘适配
     - 输入法兼容性

【安全性增强】

  9. API密钥管理
     - 移除代码中硬编码的API密钥
     - 使用环境变量配置
     - 密钥轮换机制

  10. 内容安全
      - 输入内容过滤
      - XSS防护增强
      - CSRF防护

  11. 认证增强
      - 双因素认证 (2FA)
      - 密码强度要求
      - 登录异常提醒

【测试和文档】

  12. 自动化测试
      - 单元测试覆盖
      - 集成测试
      - E2E测试

  13. 文档完善
      - API文档 (Swagger/OpenAPI)
      - 部署文档
      - 开发者指南
      - 用户使用手册

【其他改进】

  14. 日志系统
      - 结构化日志
      - 日志级别控制
      - 日志持久化和轮转

  15. 监控告警
      - 服务健康检查
      - 性能监控
      - 异常告警

  16. 配置管理
      - 配置文件化
      - 环境区分 (开发/测试/生产)
      - 动态配置更新

================================================================================
                            附录: 技术细节
================================================================================

【项目结构】
ai/
├── public/
│   ├── index.html      # 前端主文件 (HTML + CSS + JS)
│   └── lib/            # 第三方库
├── server.js           # 后端主文件
├── ai_data.db          # SQLite 数据库
├── uploads/            # 上传文件目录
├── avatars/            # 用户头像目录
├── package.json        # Node.js 依赖配置
└── node_modules/       # 依赖包

【数据库表结构】
- users: 用户信息
- sessions: 会话记录
- messages: 消息记录
- user_configs: 用户配置
- active_requests: 活跃请求 (用于取消功能)
- device_fingerprints: 设备指纹

【API端点】
- POST /api/auth/register - 用户注册
- POST /api/auth/login - 用户登录
- GET /api/auth/verify - 验证令牌
- GET /api/user/profile - 获取用户信息
- PUT /api/user/config - 更新用户配置
- GET /api/sessions - 获取会话列表
- POST /api/sessions - 创建会话
- DELETE /api/sessions/:id - 删除会话
- POST /api/chat/stream - 流式聊天
- POST /api/chat/stop - 停止生成

================================================================================
                              文档结束
================================================================================
